<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="/shenyeshitang/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/shenyeshitang/icons/icon-192.png">
  <title>深夜食堂</title>

  <!-- v36 固定房间 + PWA 启动自动进入管理员 -->
  <script>
  (function () {
    try {
      const ROOM_LOCK = '家庭聚餐';
      const params = new URLSearchParams(location.search);

      if (params.get('admin') === '1') {
        localStorage.setItem('adminMode','1');
        localStorage.setItem('adminRoom', ROOM_LOCK);
        return;
      }
      const isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)
                 || (navigator.standalone === true);
      const savedAdmin = localStorage.getItem('adminMode') === '1';
      if (isPWA && savedAdmin && !params.get('admin')) {
        const base = location.pathname.replace(/\/index\.html$/, '/');
        location.replace(base + '?admin=1&r=' + encodeURIComponent(ROOM_LOCK));
      }
    } catch(e) {}
  })();
  </script>

  <style>
    :root{
      --bg:#0c0c0f;--text:#e9e9f2;--brand:#7c5cff;--brand2:#3dd9b2;--accent:#ffd166;--muted:#98a0be;
      --safe:max(env(safe-area-inset-left),16px);--safeTop:env(safe-area-inset-top,0px)
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:ui-sans-serif,-apple-system,"PingFang SC","Microsoft YaHei",sans-serif;color:var(--text);
      background:radial-gradient(1200px 600px at 70% -10%,rgba(124,92,255,.15),transparent 60%),radial-gradient(1000px 500px at 0% 100%,rgba(61,217,178,.12),transparent 60%),var(--bg)}
    body.admin-on{padding-top:calc(var(--safeTop)+10px)}
    #admin{margin-bottom:14px;}
    body.admin-on header{margin-top:8px;}
    header{position:sticky;top:0;z-index:20;background:rgba(12,12,15,.85);backdrop-filter:blur(8px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:18px var(--safe)}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),var(--brand2));font-size:24px;color:#fff}
    .logo::after{content:'🌙'}
    .title{font-size:26px;font-weight:800}
    .search{display:flex;align-items:center;gap:8px;background:#0f0f15;border:1px solid #242438;color:var(--text);padding:10px 12px;border-radius:12px;min-width:min(260px,40vw)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;font-size:15px}

    /* Tabs */
    .tabs{display:flex;gap:10px;overflow:auto;padding:8px var(--safe) 14px}
    .pill{border:1px solid #28283e;background:#13131b;color:#e9e9f2;padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer}
    .pill[aria-pressed="true"]{background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(61,217,178,.2));border-color:var(--brand)}

    /* Cards */
    .grid-all{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;padding:16px}
    .card-all{display:grid;gap:8px;background:linear-gradient(180deg,#171a24,#12131a 40%);border:1px solid #2a2a44;border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .18s}
    .card-all:hover{transform:translateY(-3px);border-color:#3b3f5b}
    .imgbox{aspect-ratio:4/3;display:grid;place-items:center;background:#0a0a10}
    .thumb{width:100%;height:100%;object-fit:cover}
    .title-only{padding:0 10px 12px;font-weight:900;font-size:16px;color:#fff;text-align:center}
    .thumb.loading{background:#222;opacity:0;animation:pulse 1.2s ease-in-out infinite}
    .thumb.loaded{opacity:1;animation:none;transition:opacity .4s}
    @keyframes pulse{0%{opacity:.4}50%{opacity:.9}100%{opacity:.4}}

    footer{margin:28px 0 120px;text-align:center;color:#98a0be;font-size:12px}
  </style>
</head>
<body>
  <!-- 管理员实时订单 -->
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>📟 实时订单</h3>
    <div class="toolbar" style="display:flex;gap:10px">
      <label style="display:flex;align-items:center;gap:6px"><input id="showPendingOnly" type="checkbox" checked>只看未做</label>
      <button id="markAllDone">标记完成</button>
      <button id="enableNotify">开启提醒</button>
    </div>
    <div id="roomInfo" style="color:#c7cbe0;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #2a2a44">
      <thead><tr><th>时间</th><th>菜品</th><th>数量</th><th>操作</th></tr></thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <header>
    <div class="topbar">
      <div class="brand"><div class="logo"></div><div class="title">深夜食堂</div></div>
      <div class="search"><input id="search" type="search" placeholder="搜索菜名/标签…" /></div>
    </div>
    <div class="tabs">
      <button class="pill" data-filter="all" aria-pressed="true">全部</button>
      <button class="pill" data-filter="Main">热菜</button>
      <button class="pill" data-filter="Rice">主食</button>
      <button class="pill" data-filter="Cold">凉拌菜</button>
    </div>
  </header>

  <main id="menu-root"></main>
  <footer>© 2025 深夜食堂 · 安装到主屏幕后离线可用。</footer>

  <script>
    const ROOM_LOCK = '家庭聚餐';
    const qs = new URLSearchParams(location.search);
    const isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)||(navigator.standalone===true);
    const ADMIN = qs.get('admin')==='1' || (isPWA && localStorage.getItem('adminMode')==='1');
    const ROOM_EFFECTIVE = ROOM_LOCK;
    if (ADMIN) document.body.classList.add('admin-on');

    const root=document.getElementById('menu-root');
    const pills=document.querySelectorAll('.pill');
    let MENU=[];

    function iconSVG(e,label){
      const svg=encodeURIComponent(`<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#7c5cff'/><stop offset='100%' stop-color='#3dd9b2'/></linearGradient></defs><rect width='220' height='220' rx='28' fill='url(#g)'/><circle cx='110' cy='118' r='72' fill='white'/><circle cx='110' cy='118' r='58' fill='#f4f4f4'/><text x='110' y='124' font-size='72' text-anchor='middle'>${e||'🍽️'}</text><rect x='60' y='168' width='100' height='28' rx='14' fill='rgba(0,0,0,.45)'/><text x='110' y='184' font-size='14' text-anchor='middle' fill='white' font-weight='700'>${label}</text></svg>`);
      const im=new Image();im.className='thumb loaded';im.src='data:image/svg+xml;utf8,'+svg;return im;
    }

    function renderAllSimple(items){
      const grid=document.createElement('div');grid.className='grid-all';
      items.forEach(it=>{
        const card=document.createElement('article');card.className='card-all';
        const imgbox=document.createElement('div');imgbox.className='imgbox';imgbox.appendChild(iconSVG(it.emoji,it.name_cn));
        const t=document.createElement('div');t.className='title-only';t.textContent=it.name_cn;
        card.append(imgbox,t);grid.append(card);
      });
      return grid;
    }

    function renderMenu(){root.innerHTML='';root.append(renderAllSimple(MENU));}
    pills.forEach(btn=>btn.addEventListener('click',()=>{pills.forEach(b=>b.setAttribute('aria-pressed','false'));btn.setAttribute('aria-pressed','true');renderMenu();}));

    fetch('/shenyeshitang/menu.json',{cache:'no-store'}).then(r=>r.json()).then(d=>{MENU=d;renderMenu();});
  </script>
</body>
</html>