<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="/shenyeshitang/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/shenyeshitang/icons/icon-192.png">

  <title>深夜食堂</title>
  <style>
    :root{ --bg:#0c0c0f;--panel:#121218;--muted:#8a8fa3;--text:#e9e9f2;--brand:#7c5cff;--brand2:#3dd9b2;--accent:#ffd166;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35);--safe:max(env(safe-area-inset-left),16px); }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif;letter-spacing:.2px;color:var(--text);background:
      radial-gradient(1200px 600px at 70% -10%, rgba(124,92,255,.15), transparent 60%),
      radial-gradient(1000px 500px at 0% 100%, rgba(61,217,178,.12), transparent 60%),var(--bg)}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(12,12,15,.9), rgba(12,12,15,.6) 70%, transparent);backdrop-filter:blur(8px)}
    .topbar{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;padding:18px var(--safe) 10px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;position:relative;box-shadow:var(--shadow);background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:900}
    .logo::after { content: '🌙'; }
    .title{font-size:clamp(22px,3.2vw,30px);font-weight:800}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .search{display:flex;align-items:center;gap:8px;background:#0f0f15;border:1px solid #242438;color:var(--text);padding:10px 12px;border-radius:12px;min-width:min(360px,60vw)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;font-size:15px}
    .tabs{display:flex;gap:10px;overflow:auto;padding:8px var(--safe) 14px}
    .pill{border:1px solid #28283e;background:#13131b;color:var(--text);padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer;flex:0 0 auto}
    .pill[aria-pressed="true"]{background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(61,217,178,.2));border-color:var(--brand)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;padding:10px var(--safe) 96px}
    @media (min-width: 1024px){.grid{grid-template-columns:repeat(3,minmax(320px,1fr));}}
    .card{display:flex;gap:16px;align-items:stretch;background:linear-gradient(180deg,#161621,#12121a 30%);border:1px solid #24243a;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .imgbox{flex:0 0 160px;display:grid;place-items:center;background:#0a0a10;border-right:1px solid #23233a}
    .qsvg{width:140px;height:140px}
    .content{flex:1;padding:16px}
    .name{font-size:19px;font-weight:900;margin:0 0 6px}
    .desc{font-size:14px;color:var(--muted);min-height:36px;margin:0 0 8px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{font-size:12px;color:#c7cbe0;border:1px dashed #2d2d44;padding:4px 8px;border-radius:999px}
    .add{margin-top:10px;background:#1a1a28;color:#fff;border:1px solid #2a2a44;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;width:fit-content}
    #cartBtn{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));background:linear-gradient(135deg,var(--brand),var(--accent));color:#0b0b0e;border:0;border-radius:16px;padding:12px 16px;font-weight:900;box-shadow:0 14px 40px rgba(0,0,0,.45);z-index:40}
    #cartBtn small{opacity:.8}
    #drawer{position:fixed;inset:auto 0 0 auto;right:0;width:min(420px,96vw);max-height:86vh;background:#0f0f16;border-top-left-radius:18px;border:1px solid #2a2a44;box-shadow:0 -20px 60px rgba(0,0,0,.6);transform:translateY(110%);transition:transform .25s ease;z-index:50}
    #drawer.open{transform:translateY(0)}
    .drawer-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22243c}
    .drawer-ct{padding:12px 16px;max-height:60vh;overflow:auto}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:10px 0;border-bottom:1px dashed #2a2a44}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:28px;height:28px;border-radius:8px;background:#19192a;border:1px solid #2a2a44;color:#fff;cursor:pointer}
    .drawer-ft{padding:14px 16px;border-top:1px solid #22243c;display:grid;gap:8px}
    .primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:#0b0b0e;border:0;border-radius:12px;padding:12px;font-weight:900;cursor:pointer}
    .muted{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:12px;padding:10px;cursor:pointer}
    footer{margin:28px 0 120px;text-align:center;color:#98a0be;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="🌙"></div>
        <div>
          <div class="title">深夜食堂</div>
          <div class="subtitle">可安装到主屏幕 · 内置购物车 · 实时订单（JSON 菜单，易扩展）</div>
        </div>
      </div>
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#8086a3" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="搜索菜名/标签…" aria-label="搜索菜单" />
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="分类筛选">
      <button class="pill" data-filter="all" aria-pressed="true">全部</button>
      <button class="pill" data-filter="Main">主食/热菜</button>
      <button class="pill" data-filter="Rice">炒饭/饭类</button>
      <button class="pill" data-filter="Veg">素菜/凉菜/蘸酱</button>
    </div>
  </header>

  <main class="grid" id="menu-grid"></main>

  <!-- 购物车抽屉 -->
  <button id="cartBtn">🛒 购物车 <small id="cartCount">(0)</small></button>
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-hd">
      <strong>🛒 购物车</strong>
      <button class="muted" id="closeDrawer">关闭</button>
    </div>
    <div class="drawer-ct" id="cartList"></div>
    <div class="drawer-ft">
      <input id="nickname" placeholder="备注 / 桌号 (选填)" class="muted" style="padding:10px;border-radius:10px" />
      <button class="primary" id="submitOrder">提交订单</button>
      <button class="muted" id="clearCart">清空</button>
    </div>
  </aside>

  <!-- 管理员面板 -->
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>📟 实时订单</h3>
    <div id="roomInfo" style="color:#c7cbe0;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #2a2a44">
      <thead><tr><th style="border:1px solid #2a2a44;padding:8px 10px">时间</th><th style="border:1px solid #2a2a44;padding:8px 10px">来源</th><th style="border:1px solid #2a2a44;padding:8px 10px">菜品</th><th style="border:1px solid #2a2a44;padding:8px 10px">数量</th></tr></thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <footer>© 2025 夜间食堂 · 安装到主屏幕后离线可用。店主在链接后加 <code>?admin=1</code> 可查看实时订单。</footer>

<script>
/* ========== Emoji 盘子图标（使用 ${}，别改成 {}） ========== */
const iconSVG = (emoji, label) => {
  const svg = encodeURIComponent(`<?xml version='1.0' encoding='UTF-8'?>
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#7c5cff'/><stop offset='100%' stop-color='#3dd9b2'/></linearGradient></defs>
  <rect width='220' height='220' rx='28' fill='url(#g)'/>
  <circle cx='110' cy='118' r='72' fill='white'/><circle cx='110' cy='118' r='58' fill='#f4f4f4'/>
  <text x='110' y='124' font-size='72' text-anchor='middle' dominant-baseline='middle'>${emoji}</text>
  <rect x='60' y='168' width='100' height='28' rx='14' fill='rgba(0,0,0,.45)'/>
  <text x='110' y='184' font-size='14' text-anchor='middle' fill='white' font-weight='700'>${label}</text>
</svg>`);
  return `<img class="qsvg" alt="${label}" src="data:image/svg+xml;utf8,${svg}">`;
};

/* ========== 页面状态/元素 ========== */
const grid = document.getElementById('menu-grid');
const pills = document.querySelectorAll('.pill');
const search = document.getElementById('search');
const cartBtn = document.getElementById('cartBtn');
const drawer = document.getElementById('drawer');
const cartList = document.getElementById('cartList');
const cartCount = document.getElementById('cartCount');
const nickname = document.getElementById('nickname');
const closeDrawer = document.getElementById('closeDrawer');
const submitOrder = document.getElementById('submitOrder');
const clearCart = document.getElementById('clearCart');

const ROOM = new URLSearchParams(location.search).get('r') || new Date().toISOString().slice(0,10);
const ADMIN = new URLSearchParams(location.search).get('admin') === '1';
let activeFilter = 'all';
let MENU = [];
let cart = JSON.parse(localStorage.getItem('yd_cart')||'{}');

/* ========== 渲染菜单 ========== */
const renderMenu = () => {
  grid.innerHTML = '';
  const q = (search?.value || '').trim().toLowerCase();
  MENU.forEach(item => {
    const catOk = activeFilter === 'all' || item.category === activeFilter;
    const textOk = !q || item.name_cn.toLowerCase().includes(q) || item.name_en.toLowerCase().includes(q) || (item.tags||[]).join(' ').toLowerCase().includes(q);
    if(!(catOk && textOk)) return;
    const card = document.createElement('article');
    card.className = 'card';
    card.dataset.category = item.category;
    card.innerHTML = `
      <div class="imgbox">${iconSVG(item.emoji, item.name_cn)}</div>
      <div class="content">
        <h3 class="name">${item.name_cn} · ${item.name_en}</h3>
        <p class="desc">${item.desc||''}</p>
        <div class="tags">${(item.tags||[]).map(t=>`<span class='tag'>${t}</span>`).join('')}</div>
        <button class="add" data-item="${item.name_cn}">加入</button>
      </div>`;
    card.querySelector('.add').addEventListener('click', () => { cart[item.name_cn] = (cart[item.name_cn]||0)+1; saveCart(); drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); });
    grid.appendChild(card);
  });
};

function saveCart(){ localStorage.setItem('yd_cart', JSON.stringify(cart)); renderCart(); }
function renderCart(){
  cartList.innerHTML = '';
  let totalQty = 0;
  Object.entries(cart).forEach(([name, qty]) => {
    totalQty += qty;
    const row = document.createElement('div'); row.className = 'item';
    row.innerHTML = `<strong>${name}</strong><div></div>
      <div class='qty'><button data-op='-'>-</button><span>${qty}</span><button data-op='+'>+</button></div>`;
    row.querySelector('[data-op="-"]').onclick = ()=>{ cart[name] = Math.max(0,(cart[name]||0)-1); if(cart[name]===0) delete cart[name]; saveCart(); };
    row.querySelector('[data-op="+"]').onclick = ()=>{ cart[name] = (cart[name]||0)+1; saveCart(); };
    cartList.appendChild(row);
  });
  cartCount.textContent = `(${totalQty})`;
}

/* ========== 交互绑定 ========== */
pills.forEach(btn => btn.addEventListener('click', () => { pills.forEach(b => b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); activeFilter = btn.dataset.filter; renderMenu(); }));
search?.addEventListener('input', renderMenu);
cartBtn.onclick = ()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); };
closeDrawer.onclick = ()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };
clearCart.onclick = ()=>{ cart = {}; saveCart(); };
renderCart();

/* ========== GitHub Pages: 使用绝对路径加载 JSON ========== */
fetch('/shenyeshitang/menu.json').then(r=>r.json()).then(data => { MENU = data; renderMenu(); });

/* ========== Firebase（你的配置已写入） ========== */
const firebaseConfig = {
  apiKey: "AIzaSyA45H7MVPejI-09EmX3Y9RP0G-BzxKUA0M",
  authDomain: "shenyeshitang-9a3c2.firebaseapp.com",
  projectId: "shenyeshitang-9a3c2",
  storageBucket: "shenyeshitang-9a3c2.firebasestorage.app",
  messagingSenderId: "293937999981",
  appId: "1:293937999981:web:364b69c1ea61b48e8acf64"
};

let db=null; let fbReady=false;
(async () => {
  try{
    const appMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
    const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    const app = appMod.initializeApp(firebaseConfig);
    db = fsMod.getFirestore(app); fbReady = true;

    if(ADMIN){
      document.getElementById('admin').style.display='block';
      document.getElementById('roomInfo').textContent = `房间/日期: ${ROOM} · 将链接分享为 ?r=${ROOM}`;
      const q = fsMod.query(fsMod.collection(db,'yd_orders'), fsMod.where('room','==',ROOM), fsMod.orderBy('createdAt','desc'));
      fsMod.onSnapshot(q, snap => {
        const tbody = document.getElementById('adminRows'); tbody.innerHTML='';
        snap.forEach(doc=>{
          const d = doc.data();
          const when = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : new Date(d.createdAt).toLocaleString();
          d.items.forEach(it=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style='border:1px solid #2a2a44;padding:8px 10px'>${when}</td><td style='border:1px solid #2a2a44;padding:8px 10px'>${d.nick||'-'}</td><td style='border:1px solid #2a2a44;padding:8px 10px'>${it.name}</td><td style='border:1px solid #2a2a4;padding:8px 10px'>${it.qty}</td>`;
            tbody.appendChild(tr);
          });
        });
      });
    }
  }catch(e){ console.warn('Firebase 初始化失败：', e.message); }
})();

/* ========== 提交订单到 Firestore ========== */
submitOrder.onclick = async () => {
  if(Object.keys(cart).length===0){ alert('请先加入菜品'); return; }
  if(!fbReady){ alert('Firebase 未配置或不可用。'); return; }
  const items = Object.entries(cart).map(([name, qty])=>({name, qty}));
  try{
    const { addDoc, collection, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await addDoc(collection(db,'yd_orders'), { room: ROOM, nick: nickname.value.trim(), items, createdAt: serverTimestamp() });
    cart = {}; saveCart(); drawer.classList.remove('open'); alert('已提交！');
  }catch(err){ alert('提交失败：'+err.message); }
};

/* ========== 注册 Service Worker（GH Pages 绝对路径） ========== */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/shenyeshitang/sw.js'); }
</script>

</body>
</html>
