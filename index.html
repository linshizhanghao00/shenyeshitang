<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="/shenyeshitang/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/shenyeshitang/icons/icon-192.png">
  <title>æ·±å¤œé£Ÿå ‚</title>

  <!-- PWA å¯åŠ¨ä¸”è®°å¿†ä¸ºç®¡ç†å‘˜ -> è·³åˆ° ?admin=1&r=å®¶åº­èšé¤ï¼›æœ¬æ¬¡æ˜¯ admin é“¾æ¥åˆ™è®°å¿† -->
  <script>
  (function () {
    try {
      var ROOM_LOCK = 'å®¶åº­èšé¤';
      var p = new URLSearchParams(location.search);
      if (p.get('admin') === '1') {
        localStorage.setItem('adminMode','1');
        localStorage.setItem('adminRoom', ROOM_LOCK);
        return;
      }
      var isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)
               || (navigator.standalone === true);
      var savedAdmin = localStorage.getItem('adminMode') === '1';
      if (isPWA && savedAdmin && !p.get('admin')) {
        var base = location.pathname.replace(/\/index\.html$/, '/');
        location.replace(base + '?admin=1&r=' + encodeURIComponent(ROOM_LOCK));
      }
    } catch(e) {}
  })();
  </script>

  <style>
    :root{
      --bg:#0c0c0f;--panel:#121218;--text:#e9e9f2;--muted:#98a0be;
      --brand:#7c5cff;--brand2:#3dd9b2;--accent:#ffd166;
      --safe:max(env(safe-area-inset-left),16px);--safeTop:env(safe-area-inset-top,0px)
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;font-family:ui-sans-serif,-apple-system,"PingFang SC","Microsoft YaHei",sans-serif;letter-spacing:.2px;color:var(--text);
      background:radial-gradient(1200px 600px at 70% -10%,rgba(124,92,255,.15),transparent 60%),
                 radial-gradient(1000px 500px at 0% 100%,rgba(61,217,178,.12),transparent 60%),var(--bg)
    }
    body.admin-on{padding-top:calc(var(--safeTop)+10px)}
    #admin{margin-bottom:14px;}
    body.admin-on header{margin-top:8px;}

    header{position:sticky;top:0;z-index:20;background:rgba(12,12,15,.85);backdrop-filter:blur(8px)}
    .topbar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:18px var(--safe) 10px}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-size:24px}
    .logo::after{content:'ğŸŒ™'}
    .title{font-size:26px;font-weight:800}
    .search{display:flex;align-items:center;gap:8px;background:#0f0f15;border:1px solid #242438;color:var(--text);padding:10px 12px;border-radius:12px;min-width:min(260px,40vw)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;font-size:15px}

    .admin-actions{display:none;gap:8px}
    body.admin-on .admin-actions{display:flex}
    #btnAdminOn{display:none}
    #btnAdminOff{display:none}
    body.admin-on #btnAdminOff{display:inline-block}
    .btn{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:12px;padding:12px 14px;cursor:pointer;font-size:15px}

    .tabs{display:flex;gap:10px;overflow:auto;padding:8px var(--safe) 14px}
    .pill{border:1px solid #28283e;background:#13131b;color:var(--text);padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer}
    .pill[aria-pressed="true"]{background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(61,217,178,.2));border-color:var(--brand)}

    .grid-all{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;padding:16px}
    @media(min-width:1024px){.grid-all{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card-all{display:grid;gap:8px;background:linear-gradient(180deg,#171a24,#12131a 40%);border:1px solid #2a2a44;border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .18s,border-color .18s}
    .card-all:hover{transform:translateY(-3px);border-color:#3b3f5b}
    .imgbox{aspect-ratio:4/3;display:block;background:#0a0a10}
    .imgbox > img.thumb{width:100%;height:100%;object-fit:cover;display:block}
    .title-only{padding:0 10px 12px;font-weight:900;font-size:16px;color:#fff;text-align:center}
    .thumb.loading{background:#222;opacity:0;animation:pulse 1.2s ease-in-out infinite}
    .thumb.loaded{opacity:1;animation:none;transition:opacity .4s}
    @keyframes pulse{0%{opacity:.4}50%{opacity:.9}100%{opacity:.4}}

    .section{margin:18px var(--safe)}
    .section-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0 10px;padding:10px 12px;border:1px solid #2a2a44;border-radius:12px;background:linear-gradient(180deg,#12131a,#11121a);position:sticky;top:56px;z-index:5;backdrop-filter:blur(6px)}
    .section-title{display:flex;gap:10px;align-items:center;font-weight:900}
    .section-sub{color:#98a0be;font-size:12px}
    .section-toggle{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px}
    .card{display:grid;grid-template-columns:140px 1fr;background:linear-gradient(180deg,#171a24,#12131a 40%);border:1px solid #282b3f;border-radius:16px;overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.35);transition:transform .18s,border-color .18s}
    .card:hover{transform:translateY(-3px);border-color:#3b3f5b}
    .imgbox.small{aspect-ratio:4/3;background:#0a0b10}
    .imgbox.small > img.thumb{width:100%;height:100%;object-fit:cover;display:block}
    .content{padding:14px 14px 16px;display:grid;gap:8px}
    .name{font-size:18px;font-weight:900;margin:2px 0 0;color:#fff}
    .desc{font-size:13px;color:#98a0be;min-height:34px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{font-size:12px;color:#c7cbe0;border:1px dashed #2a2a44;padding:4px 8px;border-radius:999px}
    .add{margin-top:2px;background:#1a1a28;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;justify-self:start}
    .add:hover{border-color:#7c5cff}

    #cartBtn{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));background:linear-gradient(135deg,#7c5cff,#ffd166);color:#0b0b0e;border:0;border-radius:16px;padding:14px 18px;font-weight:900;box-shadow:0 14px 40px rgba(0,0,0,.45);z-index:40;font-size:16px}
    #drawer{position:fixed;inset:auto 0 0 auto;right:0;width:min(420px,96vw);max-height:86vh;background:#0f0f16;border-top-left-radius:18px;border:1px solid #2a2a44;box-shadow:0 -20px 60px rgba(0,0,0,.6);transform:translateY(110%);transition:transform .25s;z-index:50}
    .drawer-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22243c}
    .drawer-ct{padding:12px 16px;max-height:60vh;overflow:auto}
    .drawer-ft{padding:14px 16px;border-top:1px solid #22243c;display:grid;gap:10px}
    .drawer-ft .btn{font-size:16px;padding:12px 14px;border-radius:12px}
    #submitOrder{font-size:20px;padding:20px 18px;min-height:72px;border-radius:14px}
    #admin .btn{font-size:16px;padding:12px 14px;border-radius:12px}

    footer{margin:28px 0 120px;text-align:center;color:var(--muted);font-size:12px}
    #toast{position:fixed;top:14px;right:14px;z-index:60;display:grid;gap:8px}
    .toast{background:rgba(20,22,30,.95);border:1px solid #2a2a44;color:#e9e9f2;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.45);font-size:14px}
  </style>
</head>
<body>
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>ğŸ“Ÿ å®æ—¶è®¢å•</h3>
    <div class="toolbar">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input id="showPendingOnly" type="checkbox" checked><span>åªçœ‹æœªåš</span></label>
      <button id="markAllDone" class="btn">æ ‡è®°å®Œæˆ</button>
      <button id="enableNotify" class="btn">å¼€å¯æé†’</button>
    </div>
    <div id="roomInfo" style="color:#c7cbe0;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #2a2a44">
      <thead><tr><th>æ—¶é—´</th><th>æ¥æº</th><th>èœå“</th><th>æ•°é‡</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <header>
    <div class="topbar">
      <div class="brand"><div class="logo"></div><div class="title">æ·±å¤œé£Ÿå ‚</div></div>
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#8086a3" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="æœç´¢èœå/æ ‡ç­¾â€¦" />
      </div>
    </div>

    <div class="tabs">
      <button class="pill" data-filter="all" aria-pressed="true">å…¨éƒ¨</button>
      <button class="pill" data-filter="Main">çƒ­èœ</button>
      <button class="pill" data-filter="Rice">ä¸»é£Ÿ</button>
      <button class="pill" data-filter="Cold">å‡‰æ‹Œèœ</button>
    </div>
  </header>

  <div id="toast" aria-live="polite"></div>
  <main id="menu-root"></main>

  <button id="cartBtn">ğŸ›’ è´­ç‰©è½¦ <small id="cartCount">(0)</small></button>
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-hd"><strong>ğŸ›’ è´­ç‰©è½¦</strong><button class="btn" id="closeDrawer">å…³é—­</button></div>
    <div class="drawer-ct" id="cartList"></div>
    <div class="drawer-ft">
      <input id="nickname" placeholder="å¤‡æ³¨ / æ¡Œå· (é€‰å¡«)" class="btn" style="padding:12px;border-radius:12px;background:#161622" />
      <div style="display:grid;gap:8px;margin-top:8px">
        <div style="font-weight:700;opacity:.9">âœï¸ è‡ªå®šä¹‰ç‚¹èœ</div>
        <input id="cName" placeholder="èœåï¼ˆå¿…å¡«ï¼‰" class="btn" style="padding:12px;border-radius:12px;background:#161622">
        <input id="cIngs" placeholder="é£Ÿæï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼‰" class="btn" style="padding:12px;border-radius:12px;background:#161622">
        <button id="addCustom" class="btn">åŠ å…¥è´­ç‰©è½¦ï¼ˆè‡ªå®šä¹‰ï¼‰</button>
      </div>
      <button class="btn" id="submitOrder" style="background:linear-gradient(135deg,#7c5cff,#ffd166);color:#0b0b0e">æäº¤è®¢å•</button>
      <button class="btn" id="clearCart">æ¸…ç©º</button>
    </div>
  </aside>

  <footer>Â© 2025 æ·±å¤œé£Ÿå ‚ Â· å®‰è£…åˆ°ä¸»å±å¹•åç¦»çº¿å¯ç”¨ã€‚</footer>

  <script>
    /* å›ºå®šèœå• URLï¼Œé¿å…è·¯å¾„ä¸ç¡®å®šæ€§ */
    var MENU_URL = 'https://linshizhanghao00.github.io/shenyeshitang/menu.json';

    var ROOM_LOCK = 'å®¶åº­èšé¤';
    var qs = new URLSearchParams(location.search);
    var isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);
    var savedAdmin = localStorage.getItem('adminMode')==='1';
    var ADMIN = qs.get('admin')==='1' || (isPWA && savedAdmin);
    var ROOM_EFFECTIVE = ROOM_LOCK;
    if (ADMIN) document.body.classList.add('admin-on');

    var root=document.getElementById('menu-root');
    var pills=document.querySelectorAll('.pill');
    var searchInput=document.getElementById('search');
    var cartBtn=document.getElementById('cartBtn');
    var drawer=document.getElementById('drawer');
    var cartList=document.getElementById('cartList');
    var cartCount=document.getElementById('cartCount');
    var closeDrawer=document.getElementById('closeDrawer');
    var submitOrder=document.getElementById('submitOrder');
    var clearCart=document.getElementById('clearCart');
    var nickname=document.getElementById('nickname');
    var cName=document.getElementById('cName');
    var cIngs=document.getElementById('cIngs');
    var addCustom=document.getElementById('addCustom');

    function iconSVG(e,label){
      var svg=encodeURIComponent(
        "<?xml version='1.0'?>"
        +"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'>"
        +"<defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#7c5cff'/><stop offset='100%' stop-color='#3dd9b2'/></linearGradient></defs>"
        +"<rect width='220' height='220' rx='28' fill='url(#g)'/>"
        +"<circle cx='110' cy='118' r='72' fill='white'/><circle cx='110' cy='118' r='58' fill='#f4f4f4'/>"
        +"<text x='110' y='124' font-size='72' text-anchor='middle'>"+(e||'ğŸ½ï¸')+"</text>"
        +"<rect x='60' y='168' width='100' height='28' rx='14' fill='rgba(0,0,0,.45)'/>"
        +"<text x='110' y='184' font-size='14' text-anchor='middle' fill='white' font-weight='700'>"+label+"</text>"
        +"</svg>"
      );
      var im=new Image(); im.className='thumb loaded'; im.alt=label; im.src='data:image/svg+xml;utf8,'+svg; return im;
    }
    function mediaFor(item){ return iconSVG(item.emoji,item.name_cn); }

    var MENU=[];

    function groupSection(title, items){
      var sec=document.createElement('section'); sec.className='section'; sec.setAttribute('aria-expanded','true');
      var header=document.createElement('div'); header.className='section-header';
      header.innerHTML="<div class=\"section-title\"><span>"+title+"</span><span class=\"section-sub\">å…± "+items.length+" é“</span></div>";
      var btn=document.createElement('button'); btn.className='section-toggle'; btn.textContent='æ”¶èµ·';
      btn.onclick=function(){ var now=sec.getAttribute('aria-expanded')==='true'; sec.setAttribute('aria-expanded',now?'false':'true'); btn.textContent=now?'å±•å¼€':'æ”¶èµ·'; };
      header.appendChild(btn);
      var grid=document.createElement('div'); grid.className='grid';
      items.forEach(function(it){
        var card=document.createElement('article'); card.className='card';
        var imgbox=document.createElement('div'); imgbox.className='imgbox small'; imgbox.appendChild(mediaFor(it));
        var content=document.createElement('div'); content.className='content';
        content.innerHTML="<h3 class=\"name\">"+it.name_cn+(it.name_en?' Â· '+it.name_en:'')+"</h3>"
          +"<p class=\"desc\">"+(it.desc||'')+"</p>"
          +"<div class=\"tags\">"+((it.tags||[]).map(function(t){return '<span class=\"tag\">'+t+'</span>';}).join(''))+"</div>"
          +"<button class=\"add\" data-item=\""+it.name_cn+"\">åŠ å…¥</button>";
        content.querySelector('.add').onclick=function(){ cart[it.name_cn]=(cart[it.name_cn]||0)+1; saveCart(); };
        card.appendChild(imgbox); card.appendChild(content); grid.appendChild(card);
      });
      sec.appendChild(header); sec.appendChild(grid); return sec;
    }

    function gridAll(items){
      var grid=document.createElement('div'); grid.className='grid-all';
      var q=(searchInput.value||'').trim().toLowerCase();
      items.filter(function(it){
        var hay=(it.name_cn+' '+(it.name_en||'')+' '+(it.tags||[]).join(' ')).toLowerCase();
        return !q || hay.includes(q);
      }).forEach(function(it){
        var card=document.createElement('article'); card.className='card-all';
        var imgbox=document.createElement('div'); imgbox.className='imgbox'; imgbox.appendChild(mediaFor(it));
        var t=document.createElement('div'); t.className='title-only'; t.textContent=it.name_cn;
        card.appendChild(imgbox); card.appendChild(t);
        card.onclick=function(){ cart[it.name_cn]=(cart[it.name_cn]||0)+1; saveCart(); };
        grid.appendChild(card);
      });
      return grid;
    }

    function renderMenu(){
      root.innerHTML='';
      var q=(searchInput.value||'').trim().toLowerCase();
      var activeEl=document.querySelector('.pill[aria-pressed="true"]');
      var active = activeEl ? activeEl.dataset.filter : 'all';

      function matchQ(it){
        var hay=(it.name_cn+' '+(it.name_en||'')+' '+(it.tags||[]).join(' ')).toLowerCase();
        return !q || hay.includes(q);
      }

      if (active === 'all') { root.appendChild(gridAll(MENU)); return; }

      if (active === 'Main') {
        var meat = MENU.filter(function(it){ return matchQ(it) && it.category==='Main' && !(it.tags||[]).includes('Soup'); });
        var veg  = MENU.filter(function(it){ return matchQ(it) && it.category==='Veg'  && !(it.tags||[]).includes('Cold'); });
        var soup = MENU.filter(function(it){ return matchQ(it) && (it.tags||[]).includes('Soup'); });
        if (meat.length) root.appendChild(groupSection('ğŸ¥© è‚‰èœ', meat));
        if (veg.length)  root.appendChild(groupSection('ğŸ¥¦ ç´ èœ', veg));
        if (soup.length) root.appendChild(groupSection('ğŸ² æ±¤', soup));
        return;
      }

      if (active === 'Rice') {
        var rice   = MENU.filter(function(it){ return matchQ(it) && it.category==='Rice' && it.name_cn.indexOf('é¥­')>-1; });
        var noodle = MENU.filter(function(it){ return matchQ(it) && it.category==='Rice' && it.name_cn.indexOf('é¢')>-1; });
        var pastry = MENU.filter(function(it){ return matchQ(it) && it.category==='Rice' && it.name_cn.indexOf('é¥­')===-1 && it.name_cn.indexOf('é¢')===-1; });
        if (rice.length)   root.appendChild(groupSection('ğŸš é¥­', rice));
        if (noodle.length) root.appendChild(groupSection('ğŸœ é¢', noodle));
        if (pastry.length) root.appendChild(groupSection('ğŸ¥Ÿ é¢é£Ÿ', pastry));
        return;
      }

      if (active === 'Cold') {
        var cold = MENU.filter(function(it){ return matchQ(it) && (it.tags||[]).includes('Cold'); });
        root.appendChild(groupSection('ğŸ¥’ å‡‰æ‹Œèœ', cold));
        return;
      }
    }

    pills.forEach(function(btn){
      btn.addEventListener('click', function(){
        pills.forEach(function(b){ b.setAttribute('aria-pressed','false'); });
        btn.setAttribute('aria-pressed','true');
        renderMenu();
      });
    });
    searchInput.addEventListener('input', renderMenu);

    /* ===== è´­ç‰©è½¦ ===== */
    var cart; try { cart = JSON.parse(localStorage.getItem('yd_cart') || '{}'); } catch { cart = {}; }
    function saveCart(){ localStorage.setItem('yd_cart', JSON.stringify(cart)); renderCart(); }
    function renderCart(){
      var list=document.getElementById('cartList'); var count=document.getElementById('cartCount');
      list.innerHTML=''; var total=0;
      Object.keys(cart).forEach(function(name){
        var qty=cart[name]; total+=qty;
        var row=document.createElement('div');
        row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='10px';
        row.style.alignItems='center'; row.style.padding='10px 0'; row.style.borderBottom='1px dashed #2a2a44';
        row.innerHTML='<strong>'+name+'</strong><div></div>'
          +'<div class="qty"><button class="btn" data-op="-">-</button> <span>'+qty+'</span> <button class="btn" data-op="+">+</button></div>';
        row.querySelector('[data-op="-"]').onclick=function(){ cart[name]=Math.max(0,(cart[name]||0)-1); if(cart[name]===0) delete cart[name]; saveCart(); };
        row.querySelector('[data-op="+"]').onclick=function(){ cart[name]=(cart[name]||0)+1; saveCart(); };
        list.appendChild(row);
      });
      count.textContent='('+total+')';
    }
    cartBtn.onclick=function(){ drawer.style.transform='translateY(0)'; drawer.setAttribute('aria-hidden','false'); };
    closeDrawer.onclick=function(){ drawer.style.transform='translateY(110%)'; drawer.setAttribute('aria-hidden','true'); };
    clearCart.onclick=function(){ cart={}; saveCart(); };
    addCustom.onclick=function(){
      var name=(cName.value||'').trim(); var ings=(cIngs.value||'').trim();
      if(!name){ alert('è¯·å…ˆè¾“å…¥èœå'); return; }
      var display=ings ? ('è‡ªå®šä¹‰ Â· '+name+'ï¼ˆ'+ings+'ï¼‰') : ('è‡ªå®šä¹‰ Â· '+name);
      cart[display]=(cart[display]||0)+1; saveCart();
    };
    renderCart();

    /* ===== å…³é”®ï¼šå›ºå®šä½¿ç”¨çº¿ä¸Š URL åŠ è½½èœå• ===== */
    (function(){
      fetch(MENU_URL, { cache:'no-store' })
        .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
        .then(function(d){
          console.log('[menu] loaded', Array.isArray(d)?d.length:d);
          if (!Array.isArray(d) || d.length===0) {
            root.innerHTML='<div style="padding:16px;color:#98a0be">èœå•ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ menu.json</div>'; return;
          }
          MENU = d;               // ä½ å·²æ›´æ–° JSONï¼Œä¸åšå‰ç«¯æ›´å
          renderMenu();           // é»˜è®¤æ˜¾ç¤ºâ€œå…¨éƒ¨â€
        })
        .catch(function(e){
          console.error('[menu] load failed', e);
          root.innerHTML='<div style="padding:16px;color:#ffb4b4">èœå•åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
        });
    })();

    /* ===== Firestore + æé†’ï¼ˆä¿æŒä¸å˜ï¼Œä»…ç»Ÿä¸€æˆ¿é—´ï¼‰ ===== */
    var firebaseConfig={apiKey:"AIzaSyA45H7MVPejI-09EmX3Y9RP0G-BzxKUA0M",authDomain:"shenyeshitang-9a3c2.firebaseapp.com",projectId:"shenyeshitang-9a3c2",storageBucket:"shenyeshitang-9a3c2.firebasestorage.app",messagingSenderId:"293937999981",appId:"1:293937999981:web:364b69c1ea61b48e8acf64"};
    var db=null; var fbReady=false;

    var toastWrap=document.getElementById('toast')||document.body.appendChild(Object.assign(document.createElement('div'),{id:'toast',style:'position:fixed;top:14px;right:14px;z-index:60;display:grid;gap:8px'}));
    function showToast(msg){ var el=document.createElement('div'); el.className='toast'; el.textContent=msg; toastWrap.appendChild(el); setTimeout(function(){el.style.opacity='0'; el.style.transition='opacity .4s';},2600); setTimeout(function(){toastWrap.removeChild(el);},3000); }
    var ding=new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAgAAAASAAAAGZmZmZmZmZmZmY=");
    function softAlert(title,body){ try{ ding.currentTime=0; ding.play().catch(function(){});}catch(e){} if(navigator.vibrate){ try{navigator.vibrate(120);}catch(e){} } showToast(title+' Â· '+body); }

    (function(){
      try{
        var s1=document.createElement('script'); s1.src='https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        var s2=document.createElement('script'); s2.src='https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
        s1.onload=function(){
          s2.onload=function(){
            try{
              var app=firebase.initializeApp(firebaseConfig);
              db=firebase.firestore(); fbReady=true;

              if (ADMIN) {
                document.body.classList.add('admin-on');
                var adminSection=document.getElementById('admin'); adminSection.style.display='block';
                var headerEl=document.querySelector('header'); document.body.insertBefore(adminSection, headerEl);

                var enableBtn=document.getElementById('enableNotify');
                function upd(){ if(!('Notification'in window)){ enableBtn.textContent='æé†’å·²å¯ç”¨ï¼ˆå£°éŸ³/éœ‡åŠ¨ï¼‰'; return; } enableBtn.textContent=(Notification.permission==='granted')?'æé†’å·²å¼€å¯':'å¼€å¯æé†’'; }
                upd(); enableBtn.onclick=function(){ if('Notification'in window){ Notification.requestPermission().then(upd);} else{ showToast('è¯¥ç¯å¢ƒä¸æ”¯æŒç³»ç»Ÿé€šçŸ¥'); } };

                var qLines = db.collection('yd_order_lines').where('room','==',ROOM_EFFECTIVE);
                var firstLoad=true;
                qLines.onSnapshot(function(snap){
                  var tbody=document.getElementById('adminRows'); tbody.innerHTML='';
                  var rows=[]; snap.forEach(function(d){ var data=d.data(); var ts=data.createdAt && data.createdAt.toMillis ? data.createdAt.toMillis() : 0; rows.push({id:d.id,data:data,ts:ts}); });
                  rows.sort(function(a,b){return b.ts-a.ts;});
                  rows.forEach(function(row){
                    var data=row.data; var isDone=data.status==='done';
                    if(document.getElementById('showPendingOnly').checked && isDone) return;
                    var when = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : '';
                    var tr=document.createElement('tr'); tr.style.opacity=isDone?'0.55':'1';
                    tr.innerHTML='<td>'+when+'</td><td>'+(data.nick||'-')+'</td><td>'+data.name+'</td><td>'+data.qty+'</td>';
                    var tdOp=document.createElement('td'); var btn=document.createElement('button'); btn.className='btn'; btn.textContent=isDone?'æ’¤é”€':'å®Œæˆ';
                    btn.onclick=function(){ db.collection('yd_order_lines').doc(row.id).update({status:isDone?'pending':'done',doneAt:isDone?null:new Date()}); };
                    tdOp.appendChild(btn); tr.appendChild(tdOp); tbody.appendChild(tr);
                  });
                  if(firstLoad){ firstLoad=false; return; }
                  snap.docChanges().forEach(function(ch){ if(ch.type==='added'){ var d=ch.doc.data(); if(d.status!=='done') softAlert('æ–°è®¢å•', d.name+' Ã— '+d.qty); } });
                }, function(err){ console.error('å®æ—¶è®¢å•ç›‘å¬å¤±è´¥ï¼š', err); showToast('å®æ—¶è®¢å•ç›‘å¬å¤±è´¥ï¼š'+err.message); });

                document.getElementById('markAllDone').onclick=function(){
                  if(!confirm('å°†å½“å‰æ˜¾ç¤ºçš„è®¢å•å…¨éƒ¨æ ‡è®°ä¸ºå®Œæˆï¼Ÿ')) return;
                  db.collection('yd_order_lines').where('room','==',ROOM_EFFECTIVE).get().then(function(s){
                    var batch=[]; s.forEach(function(d){ var data=d.data(); if(document.getElementById('showPendingOnly').checked && data.status==='done') return; if(data.status!=='done'){ batch.push(d.ref.update({status:'done',doneAt:new Date()})); } });
                    return Promise.all(batch);
                  }).then(function(){ showToast('å·²æ ‡è®°å®Œæˆ'); });
                };

                document.getElementById('roomInfo').textContent = 'æˆ¿é—´ï¼š'+ROOM_EFFECTIVE+'ï¼ˆå›ºå®šï¼‰';
              }
            }catch(e){ console.warn('Firebase åˆå§‹åŒ–å¤±è´¥ï¼š', e.message); }
          };
          document.body.appendChild(s2);
        };
        document.body.appendChild(s1);
      }catch(e){ console.warn('åŠ è½½ Firebase è„šæœ¬å¤±è´¥', e.message); }
    })();

    function submitOrder(){
      if(Object.keys(cart).length===0){ alert('è¯·å…ˆåŠ å…¥èœå“'); return; }
      if(!db){ alert('Firebase æœªé…ç½®æˆ–ä¸å¯ç”¨ã€‚'); return; }
      var items=[]; for(var k in cart){ items.push({name:k, qty:cart[k]}); }
      db.collection('yd_orders').add({
        room: ROOM_EFFECTIVE, nick:(nickname&&nickname.value||''), items:items,
        status:'pending', doneAt:null, createdAt: new Date()
      }).then(function(ref){
        var ops=[]; items.forEach(function(it){
          ops.push(db.collection('yd_order_lines').add({
            room: ROOM_EFFECTIVE, nick:(nickname&&nickname.value||''), orderId: ref.id,
            name: it.name, qty: it.qty, status:'pending', doneAt:null, createdAt:new Date()
          }));
        });
        return Promise.all(ops);
      }).then(function(){
        cart={}; saveCart(); drawer.style.transform='translateY(110%)'; showToast('å·²æäº¤');
      }).catch(function(err){ alert('æäº¤å¤±è´¥ï¼š'+err.message); });
    }
    document.getElementById('submitOrder').onclick=submitOrder;
  </script>
</body>
</html>