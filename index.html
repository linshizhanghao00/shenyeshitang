<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- manifest / touch icon -->
  <link id="manifestLink" rel="manifest" href="/shenyeshitang/manifest.webmanifest?iv=v7">
  <link rel="apple-touch-icon" sizes="180x180" href="/shenyeshitang/icons/moon-180.png?v=99">
  <title>æ·±å¤œé£Ÿå ‚</title>

  <script>
    /* å…¨å±€ */
    window.ROOM_LOCK = 'å®¶åº­èšé¤';
    window.__APP_VERSION__ = 'v3';

    /* ç®¡ç†å‘˜ manifest åˆ‡æ¢ / A2HS ä¸¢ query å…œåº• */
    (function () {
      try {
        var p = new URLSearchParams(location.search);
        var isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);
        var savedAdmin = localStorage.getItem('adminMode') === '1';
        if (p.get('admin') === '1' || savedAdmin) {
          localStorage.setItem('adminMode','1');
          localStorage.setItem('adminRoom', window.ROOM_LOCK);
          var link = document.getElementById('manifestLink');
          if (link) link.setAttribute('href','/shenyeshitang/manifest.admin.webmanifest?v='+(window.__APP_VERSION__||''));
        } else if (isPWA && savedAdmin) {
          var base = location.pathname.replace(/\/index\.html$/, '/');
          location.replace(base + '?admin=1&r=' + encodeURIComponent(window.ROOM_LOCK) + '&v=' + (window.__APP_VERSION__||''));
          return;
        }
      } catch(e) {}
    })();
  </script>

  <style>
    :root{
      --paper:#f6f3ea; --ink:#2b2b2b;
      --sage-0:#cfd8cf; --sage-1:#bfc9c0; --sage-2:#aebaaf; --sage-3:#3d413b;
      --beige-bd:#cfc5b3; --beige-tab:#c5baa8;
      --warm-0:#f4d089; --warm-1:#e6bb6a; --warm-bd:#d1ac67;
      --safe:max(env(safe-area-inset-left),16px); --safeTop:env(safe-area-inset-top,0px)
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }

    /* ===== æµ…è‰²æ‰‹ç»˜é£ä¸»åº• clean ===== */
    body{
      margin:0; font-family:ui-sans-serif,-apple-system,"PingFang SC","Microsoft YaHei",sans-serif; letter-spacing:.2px;
      background:var(--paper) !important; color:var(--ink) !important;
    }

    /* PWA é¡¶éƒ¨å®‰å…¨ç•™ç™½ï¼ˆç®¡ç†å‘˜ï¼‰ */
    body.admin-on::before{content:"";display:block;height:calc(env(safe-area-inset-top,0px)+22px)}
    body.pwa-on.admin-on::before{content:"";display:block;height:calc(env(safe-area-inset-top,0px)+26px)}
    body.pwa-on:not(.admin-on)::before{content:"";display:block;height:calc(env(safe-area-inset-top,0px)+10px)}

    /* é¡¶æ  clean */
    header{
      position:sticky; top:0; z-index:20;
      background:rgba(255,255,255,.78) !important;
      -webkit-backdrop-filter:blur(14px) saturate(150%) !important;
      backdrop-filter:blur(14px) saturate(150%) !important;
      border-bottom:2px solid #d7d0c1 !important;
      box-shadow:0 3px 6px rgba(0,0,0,.08) !important;
    }
    .topbar{ display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; padding:14px var(--safe) 8px !important }

    /* å“ç‰Œä¸¤è¡Œï¼ˆè´´çº¸æœˆäº®ï¼‰ clean */
    .brand{ display:flex; flex-wrap:wrap; align-items:center; gap:6px; max-width:120px; line-height:1.1; margin-bottom:2px }
    .logo{ width:32px; height:32px; border-radius:8px; background:url('/shenyeshitang/icons/moon-180.png?v=99') center/cover no-repeat; border:2px solid #d3c8b6; box-shadow:0 2px 2px rgba(0,0,0,.10) }
    .logo::after{ content:none !important; } /* ç§»é™¤é‡å¤emoji */
    .title{ font-size:20px; font-weight:800; color:#2b2b2b !important; white-space:normal; word-break:keep-all; text-align:left; line-height:1.15; text-shadow:0 1px 0 rgba(255,255,255,.55) }
    @media (max-width:420px){ .brand{max-width:100px; gap:4px} .logo{width:28px; height:28px} .title{font-size:18px} }

    /* æœç´¢æ çº¸æ¡ clean */
    .search{ display:flex; align-items:center; gap:8px; background:linear-gradient(180deg,#fdfcf9,#f4efe5 85%) !important; border:2px solid #cec5b4 !important; color:var(--ink); padding:8px 12px !important; border-radius:12px !important; box-shadow:0 2px 0 #c0b6a3, 0 2px 6px rgba(0,0,0,.08) !important; min-width:min(260px,40vw) }
    .search input{ flex:1; background:transparent; border:0; outline:none; color:#2b2b2b !important; font-size:15px }
    .search input::placeholder{ color:#8d8678 !important }

    /* åˆ†ç»„/èƒ¶å›Š clean */
    .tabs{ display:flex; gap:10px; overflow:auto; padding:10px var(--safe) 12px !important }
    .pill{ border:2px solid var(--beige-tab) !important; border-radius:16px !important; background:linear-gradient(180deg,#fbfaf7,#efe6db) !important; color:#343434 !important; font-weight:700 !important; padding:8px 12px !important; box-shadow:0 2px 0 var(--beige-tab) !important; cursor:pointer }
    .pill[aria-pressed="true"]{ background:linear-gradient(180deg,var(--sage-0),#b8c6b9) !important; border-color:var(--sage-2) !important; color:#1f1f1f !important; box-shadow:0 2px 0 var(--sage-2) !important }

    /* åˆ†ç»„æ¡ clean */
    .section{ margin:18px var(--safe) }
    .section-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:6px 0 10px; padding:10px 12px; background:linear-gradient(180deg,#fff,#f6efe4) !important; border:2px solid var(--beige-bd) !important; border-radius:12px; position:sticky; top:56px; z-index:5; cursor:pointer }
    .section-title{ display:flex; gap:10px; align-items:center; font-weight:900; color:#2b2b2b }
    .section-sub{ color:#5e5a54; font-size:12px }
    /* æ”¶èµ·/å±•å¼€è§†è§‰ä¸é€»è¾‘ */
    .section[aria-expanded="false"] .grid{ display:none !important }
    .section[aria-expanded="false"]{ margin-bottom:10px }
    .section[aria-expanded="false"] .section-header{ border-bottom-left-radius:12px; border-bottom-right-radius:12px }

    /* å¡ç‰‡ï¼ˆæµ…ç±³ + ç»†æè¾¹ï¼‰ clean */
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:22px }
    .card{ display:grid; grid-template-columns:140px 1fr; background:linear-gradient(145deg,#ffffff,#fbf6ee 70%), radial-gradient(420px 260px at 80% 0%,rgba(203,216,206,.35),transparent 60%) !important; border:2px solid var(--beige-bd) !important; border-radius:14px; overflow:hidden; box-shadow:0 3px 0 var(--beige-bd), 0 1px 10px rgba(0,0,0,.08) }
    .content{ padding:14px 14px 16px; display:grid; gap:8px }
    .name{ font-size:18px; font-weight:900; margin:2px 0 0; color:#2b2b2b }
    .desc{ font-size:13px; color:#5e5a54 !important; min-height:34px; font-weight:500 }
    .tags{ display:flex; flex-wrap:wrap; gap:8px }
    .tag{ font-size:12px; color:#5c5851 !important; border:1px dashed #a49d8e !important; background:rgba(255,255,255,.6) !important; padding:4px 8px; border-radius:999px }

    /* ç¼©ç•¥å›¾ï¼šé¼ å°¾è‰ç»¿æ¸å˜åº• + å±…ä¸­ emoji clean */
    .imgbox.small, .imgbox{ aspect-ratio:4/3; display:block; background:linear-gradient(160deg,#96a99a 0%, #c7d1c8 100%) !important; border-bottom:1px solid rgba(0,0,0,.04) }
    .imgbox > img.thumb{ width:100%; height:100%; object-fit:contain !important; display:block !important; margin:0 auto !important; filter:saturate(1.04) brightness(1.05) !important; mix-blend-mode:normal !important; padding:12px 0 !important }

    /* è´­ç‰©è½¦æŒ‰é’® & æäº¤æŒ‰é’®ï¼ˆæš–è‰²ï¼‰ clean */
    #cartBtn{ position:fixed; right:16px; bottom:calc(16px + env(safe-area-inset-bottom)); background:linear-gradient(180deg,var(--warm-0),var(--warm-1)) !important; color:#1a1a1a !important; border:2px solid var(--warm-bd) !important; border-radius:16px; padding:14px 18px; font-weight:900; box-shadow:0 3px 0 var(--warm-bd) !important; z-index:40; font-size:16px }
    #submitOrder{ font-size:20px; padding:20px 18px; min-height:72px; border-radius:14px; background:linear-gradient(180deg,var(--warm-0),var(--warm-1)) !important; color:#3c372f !important; border:2px solid var(--warm-bd) !important }
    #cartBtn{ color:#3e3b35 !important; font-weight:800 !important }

    /* é€šç”¨æŒ‰é’®ï¼ˆç±³ç™½ï¼‰ + æ¸…ç©ºï¼ˆghostï¼‰ clean */
    .btn{ border:2px solid var(--beige-tab) !important; border-radius:12px !important; background:linear-gradient(180deg,#fff,#f4ece1) !important; color:#2b2b2b !important; font-weight:800 !important; box-shadow:0 2px 0 var(--beige-tab) !important }
    .btn.ghost{ background:linear-gradient(180deg,#fbfaf7,#f3eee6) !important; border:1px solid var(--beige-bd) !important; color:#6a655b !important; box-shadow:0 1px 2px rgba(0,0,0,.08) !important; font-weight:700 !important }

    /* â€œæ”¶èµ·â€æŒ‰é’®ä¿ç•™ä½ çš„ç°çŠ¶ï¼ˆä¸æ”¹ï¼‰ */
    .section-toggle{ padding:6px 12px; border-radius:10px; font-weight:700 }

    /* ä»…â€œåŠ å…¥â€æŒ‰é’®ï¼šæµ…é¼ å°¾è‰ç»¿ï¼ˆä¸æ”¶èµ·ä¸€è‡´ç³»ï¼‰ clean */
    .card .btn.add, .card .add{
      background:linear-gradient(180deg,var(--sage-0),var(--sage-1)) !important;
      border:1px solid var(--sage-2) !important; color:var(--sage-3) !important;
      font-weight:700 !important; font-size:14px !important; padding:8px 18px !important; border-radius:8px !important; box-shadow:0 2px 3px rgba(0,0,0,.12) !important; transition:all .15s ease
    }
    .card .btn.add:hover, .card .add:hover{ background:linear-gradient(180deg,#d8e0d8,#c8d2c8) !important }
    .card .btn.add:active, .card .add:active{ background:linear-gradient(180deg,#b8c2b8,#aeb8ae) !important; transform:translateY(1px); box-shadow:0 1px 2px rgba(0,0,0,.18) inset !important }

    /* æŠ½å±‰è´´åº• + ä¸‰æ®µå¼ + å¯æ»šåŠ¨ cleanï¼ˆåˆå¹¶å”¯ä¸€ç‰ˆæœ¬ï¼‰ */
    #drawer{
      position:fixed !important; inset:auto 0 0 0 !important; width:100% !important;
      /* é»˜è®¤ç”± JS è®¾ä¸º translateY(110%) æ”¶èµ·ï¼›å±•å¼€æ—¶ JS è®¾ä¸º translateY(0) */
      max-height:calc(92vh - env(safe-area-inset-top,0px)) !important;
      margin:0 !important; border-top-left-radius:18px !important; border-top-right-radius:18px !important;
      border-bottom-left-radius:0 !important; border-bottom-right-radius:0 !important;
      background:#fbf6ee !important; border:2px solid var(--beige-bd) !important; box-shadow:0 -4px 12px rgba(0,0,0,.10) !important; color:#4a463f !important; overflow:hidden !important; z-index:50
    }
    .drawer-hd{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #d4cdbf }
    .drawer-ct{ flex:1 1 auto !important; padding:12px 16px; overflow:auto !important; -webkit-overflow-scrolling:touch !important; overscroll-behavior:contain !important }
    .drawer-ft{ position:sticky !important; bottom:0 !important; background:inherit !important; padding:14px 16px calc(14px + env(safe-area-inset-bottom,0px)) !important; border-top:1px solid #d4cdbf }

    /* åˆ—è¡¨ç½‘æ ¼ï¼ˆå…¨éƒ¨è§†å›¾ï¼‰ */
    .grid-all{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; padding:16px }
    @media(min-width:1024px){ .grid-all{ grid-template-columns:repeat(3,minmax(0,1fr)) } }

    footer{ margin:28px 0 120px; text-align:center; color:#847c6b; font-size:12px }
    #toast{ position:fixed; top:14px; right:14px; z-index:60; display:grid; gap:8px }
    .toast{ background:rgba(20,22,30,.95); border:1px solid #2a2a44; color:#e9e9f2; padding:10px 12px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.45); font-size:14px }
  </style>
</head>
<body>
  <!-- ç®¡ç†å‘˜é¢æ¿ -->
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>ğŸ“Ÿ å®æ—¶è®¢å•</h3>
    <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 10px">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input id="showPendingOnly" type="checkbox" checked><span>åªçœ‹æœªåš</span></label>
      <button id="markAllDone" class="btn">æ ‡è®°å®Œæˆ</button>
      <button id="enableNotify" class="btn">å¼€å¯æé†’</button>
      <button id="purgeAll" class="btn danger" style="display:none">ğŸ—‘ï¸ æ¸…ç©ºæœ¬æˆ¿é—´è®¢å•</button>
    </div>
    <div id="roomInfo" style="color:#666;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #d4cdbf">
      <thead><tr><th>æ—¶é—´</th><th>æ¥æº</th><th>èœå“</th><th>æ•°é‡</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <header>
    <div class="topbar">
      <div class="brand"><div class="logo"></div><div class="title">æ·±å¤œ<br>é£Ÿå ‚</div></div>
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#8086a3" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="æœç´¢èœå/æ ‡ç­¾â€¦" />
      </div>
      <div class="adminToggle"><button id="toggleAdmin" class="btn">ğŸ‘¨â€ğŸ³ å¨æˆ¿å±</button></div>
    </div>
    <div class="tabs">
      <button class="pill" data-filter="all" aria-pressed="true">å…¨éƒ¨</button>
      <button class="pill" data-filter="Main">çƒ­èœ</button>
      <button class="pill" data-filter="Rice">ä¸»é£Ÿ</button>
      <button class="pill" data-filter="Cold">å‡‰æ‹Œèœ</button>
    </div>
  </header>

  <div id="toast" aria-live="polite"></div>
  <main id="menu-root"></main>

  <!-- è´­ç‰©è½¦ -->
  <button id="cartBtn">ğŸ›’ è´­ç‰©è½¦ <small id="cartCount">(0)</small></button>
  <aside id="drawer" aria-hidden="true" style="transform:translateY(110%);">
    <div class="drawer-hd"><strong>ğŸ›’ è´­ç‰©è½¦</strong><button class="btn" id="closeDrawer">å…³é—­</button></div>
    <div class="drawer-ct" id="cartList"></div>
    <div class="drawer-ft">
      <button id="clearCart" class="btn ghost">æ¸…ç©º</button>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div style="font-weight:700;opacity:.9">âœï¸ è‡ªå®šä¹‰ç‚¹èœ</div>
        <input id="cName" placeholder="èœåï¼ˆå¿…å¡«ï¼‰" class="btn">
        <input id="cIngs" placeholder="é£Ÿæï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼‰" class="btn">
        <button id="addCustom" class="btn">åŠ å…¥è´­ç‰©è½¦ï¼ˆè‡ªå®šä¹‰ï¼‰</button>
      </div>
      <button class="btn" id="submitOrder">æäº¤è®¢å•</button>
    </div>
  </aside>

  <footer>Â© 2025 æ·±å¤œé£Ÿå ‚ Â· å®‰è£…åˆ°ä¸»å±å¹•åç¦»çº¿å¯ç”¨ã€‚</footer>

  <script>
    /* èœå• JSON */
    var MENU_URL = 'https://linshizhanghao00.github.io/shenyeshitang/menu.json';

    /* çŠ¶æ€åˆ¤å®š */
    var qs = new URLSearchParams(location.search);
    var isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);
    var savedAdmin = localStorage.getItem('adminMode')==='1';
    var ADMIN = (qs.get('admin')==='1') || savedAdmin;
    if (ADMIN) document.body.classList.add('admin-on');
    if (isPWA) document.body.classList.add('pwa-on');

    /* DOM */
    var root=document.getElementById('menu-root');
    var pills=document.querySelectorAll('.pill');
    var searchInput=document.getElementById('search');
    var cartBtn=document.getElementById('cartBtn');
    var drawer=document.getElementById('drawer');
    var cartList=document.getElementById('cartList');
    var cartCount=document.getElementById('cartCount');
    var closeDrawer=document.getElementById('closeDrawer');
    var submitOrder=document.getElementById('submitOrder');
    var clearCart=document.getElementById('clearCart');
    var cName=document.getElementById('cName');
    var cIngs=document.getElementById('cIngs');
    var addCustom=document.getElementById('addCustom');
    var toggleAdmin=document.getElementById('toggleAdmin');

    /* åˆå§‹å¼ºåˆ¶æ”¶èµ·è´­ç‰©è½¦ï¼ˆé»˜è®¤å…³é—­ï¼‰ */
    drawer.style.transform='translateY(110%)';
    drawer.setAttribute('aria-hidden','true');

    /* PWA ç®¡ç†å‘˜ä¸€é”®åˆ‡æ¢ */
    if (toggleAdmin) {
      function refreshAdminButton(){ toggleAdmin.textContent = ADMIN ? 'ğŸ› è¿”å›ç‚¹å•' : 'ğŸ‘¨â€ğŸ³ å¨æˆ¿å±'; }
      refreshAdminButton();
      toggleAdmin.onclick = function(){
        var base = location.pathname.replace(/\/index\.html$/, '/');
        if (ADMIN) { localStorage.removeItem('adminMode'); location.href = base + '?v=' + (window.__APP_VERSION__||''); }
        else { localStorage.setItem('adminMode','1'); location.href = base + '?admin=1&r=' + encodeURIComponent(window.ROOM_LOCK) + '&v=' + (window.__APP_VERSION__||''); }
      };
    }

    /* å ä½å›¾ï¼ˆé€æ˜èƒŒæ™¯ï¼Œä»… emojiï¼‰ clean */
    function iconSVG(e,label){
      var svg = encodeURIComponent(
        "<?xml version='1.0'?>"
       +"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'>"
       +"<rect width='220' height='220' fill='none'/>"
       +"<text x='110' y='115' font-size='96' text-anchor='middle'>"+(e||'ğŸ½ï¸')+"</text>"
       +"</svg>"
      );
      var im=new Image(); im.className='thumb loaded'; im.alt=label; im.src='data:image/svg+xml;utf8,'+svg; return im;
    }
    function mediaFor(item){ return iconSVG(item.emoji,item.name_cn); }

    /* ============== åˆ†ç»„ / æ¸²æŸ“ ============== */
    var MENU=[];
    function groupSection(title, items){
      var sec=document.createElement('section'); sec.className='section'; sec.setAttribute('aria-expanded','true');
      var header=document.createElement('div'); header.className='section-header';
      header.innerHTML="<div class='section-title'><span>"+title+"</span><span class='section-sub'>å…± "+items.length+" é“</span></div>";
      var btn=document.createElement('button'); btn.className='section-toggle btn add'; btn.textContent='æ”¶èµ·'; /* å¤ç”¨æµ…ç»¿å¤–è§‚ */
      header.appendChild(btn);

      function toggle(){
        var open = sec.getAttribute('aria-expanded') !== 'false';
        sec.setAttribute('aria-expanded', open ? 'false' : 'true');
        btn.textContent = open ? 'å±•å¼€' : 'æ”¶èµ·';
      }
      btn.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
      header.addEventListener('click', function(e){ if (e.target === btn) return; toggle(); });

      var grid=document.createElement('div'); grid.className='grid';
      items.forEach(function(it){
        var card=document.createElement('article'); card.className='card';
        var imgbox=document.createElement('div'); imgbox.className='imgbox small'; imgbox.appendChild(mediaFor(it));
        var content=document.createElement('div'); content.className='content';
        content.innerHTML="<h3 class='name'>"+it.name_cn+(it.name_en?' Â· '+it.name_en:'')+"</h3>"
          +"<p class='desc'>"+(it.desc||'')+"</p>"
          +"<div class='tags'>"+((it.tags||[]).map(function(t){return '<span class=\"tag\">'+t+'</span>';}).join(''))+"</div>"
          +"<button class='btn add' data-item='"+it.name_cn+"'>åŠ å…¥</button>";
        content.querySelector('.btn.add').onclick=function(){ cart[it.name_cn]=(cart[it.name_cn]||0)+1; saveCart(); };
        card.appendChild(imgbox); card.appendChild(content); grid.appendChild(card);
      });
      sec.appendChild(header); sec.appendChild(grid); return sec;
    }

    function gridAll(items){
      var grid=document.createElement('div'); grid.className='grid-all';
      var q=(searchInput.value||'').trim().toLowerCase();
      items.filter(function(it){
        var hay=(it.name_cn+' '+(it.name_en||'')+' '+(it.tags||[]).join(' ')).toLowerCase();
        return !q || hay.includes(q);
      }).forEach(function(it){
        var card=document.createElement('article'); card.className='card';
        var imgbox=document.createElement('div'); imgbox.className='imgbox'; imgbox.appendChild(mediaFor(it));
        var content=document.createElement('div'); content.className='content';
        content.innerHTML="<h3 class='name'>"+it.name_cn+"</h3>"
          +"<div class='tags'></div>"
          +"<button class='btn add' data-item='"+it.name_cn+"'>åŠ å…¥</button>";
        content.querySelector('.btn.add').onclick=function(){ cart[it.name_cn]=(cart[it.name_cn]||0)+1; saveCart(); };
        card.appendChild(imgbox); card.appendChild(content); grid.appendChild(card);
      });
      return grid;
    }

    function renderMenu(){
      root.innerHTML='';
      var q=(searchInput.value||'').trim().toLowerCase();
      function matchQ(it){ var hay=(it.name_cn+' '+(it.name_en||'')+' '+(it.category||'')+' '+(it.tags||[]).join(' ')).toLowerCase(); return !q || hay.includes(q); }
      function hasTag(it, tag){ return (it.tags||[]).indexOf(tag)>-1; }
      function nameHas(it, kwCN){ return (it.name_cn||'').indexOf(kwCN)>-1; }

      var activeEl=document.querySelector('.pill[aria-pressed="true"]');
      var active = activeEl ? activeEl.dataset.filter : 'all';
      if (active === 'all') { root.appendChild(gridAll(MENU)); return; }

      if (active === 'Main') {
        var soup = MENU.filter(function(it){ return matchQ(it) && hasTag(it,'Soup'); });
        var veg  = MENU.filter(function(it){ return matchQ(it) && it.category==='Veg'  && !hasTag(it,'Cold'); });
        var meat = MENU.filter(function(it){ return matchQ(it) && it.category==='Main' && !hasTag(it,'Soup'); });
        if (meat.length) root.appendChild(groupSection('ğŸ¥© è‚‰èœ', meat));
        if (veg.length)  root.appendChild(groupSection('ğŸ¥¦ ç´ èœ', veg));
        if (soup.length) root.appendChild(groupSection('ğŸ² æ±¤ç±»', soup));
        return;
      }

      if (active === 'Rice') {
        var rice   = MENU.filter(function(it){ return matchQ(it) && (it.category==='Rice' && nameHas(it,'é¥­')); });
        var noodle = MENU.filter(function(it){ return matchQ(it) && (it.category==='Rice' && nameHas(it,'é¢')); });
        var pastry = MENU.filter(function(it){ return matchQ(it) && (it.category==='Rice' && !nameHas(it,'é¥­') && !nameHas(it,'é¢')); });
        if (rice.length)   root.appendChild(groupSection('ğŸš é¥­', rice));
        if (noodle.length) root.appendChild(groupSection('ğŸœ é¢', noodle));
        if (pastry.length) root.appendChild(groupSection('ğŸ¥Ÿ é¢é£Ÿ', pastry));
        return;
      }

      if (active === 'Cold') {
        var cold = MENU.filter(function(it){ return matchQ(it) && hasTag(it,'Cold'); });
        if (cold.length) root.appendChild(groupSection('ğŸ¥’ å‡‰æ‹Œèœ', cold));
        return;
      }
    }

    pills.forEach(function(btn){
      btn.addEventListener('click', function(){
        pills.forEach(function(b){ b.setAttribute('aria-pressed','false'); });
        btn.setAttribute('aria-pressed','true');
        renderMenu();
      });
    });
    searchInput.addEventListener('input', renderMenu);

    /* è´­ç‰©è½¦åŸºç¡€ */
    var cart; try { cart = JSON.parse(localStorage.getItem('yd_cart') || '{}'); } catch { cart = {}; }
    function saveCart(){ localStorage.setItem('yd_cart', JSON.stringify(cart)); renderCart(); }
    function renderCart(){
      var list=document.getElementById('cartList'); var count=document.getElementById('cartCount');
      list.innerHTML=''; var total=0;
      Object.keys(cart).forEach(function(name){
        var qty=cart[name]; total+=qty;
        var row=document.createElement('div');
        row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='12px';
        row.style.alignItems='center'; row.style.padding='12px 0'; row.style.borderBottom='1px dashed #d4cdbf';
        row.innerHTML='<strong class="row-name">'+name+'</strong><div></div>'
          +'<div class="qty row-qty"><button class="btn" data-op="-">-</button> <span>'+qty+'</span> <button class="btn" data-op="+">+</button></div>';
        row.querySelector('[data-op="-"]').onclick=function(){ cart[name]=Math.max(0,(cart[name]||0)-1); if(cart[name]===0) delete cart[name]; saveCart(); };
        row.querySelector('[data-op="+"]').onclick=function(){ cart[name]=(cart[name]||0)+1; saveCart(); };
        list.appendChild(row);
      });
      count.textContent='('+total+')';
    }

    /* æŠ½å±‰å¼€åˆ */
    cartBtn.onclick=function(){ drawer.style.transform='translateY(0)'; drawer.setAttribute('aria-hidden','false'); };
    closeDrawer.onclick=function(){ drawer.style.transform='translateY(110%)'; drawer.setAttribute('aria-hidden','true'); };
    clearCart.onclick=function(){ cart={}; saveCart(); };
    addCustom.onclick=function(){
      var name=(cName.value||'').trim(); var ings=(cIngs.value||'').trim();
      if(!name){ alert('è¯·å…ˆè¾“å…¥èœå'); return; }
      var display=ings ? ('è‡ªå®šä¹‰ Â· '+name+'ï¼ˆ'+ings+'ï¼‰') : ('è‡ªå®šä¹‰ Â· '+name);
      cart[display]=(cart[display]||0)+1; saveCart();
    };
    renderCart();

    /* åŠ è½½èœå• */
    fetch(MENU_URL, { cache:'no-store' })
      .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(function(d){ MENU = Array.isArray(d)? d : []; renderMenu(); })
      .catch(function(e){ console.error('[menu] load failed', e); });

    /* Firestore */
    const _firebaseConfig = { apiKey:"AIzaSyA45H7MVPejI-09EmX3Y9RP0G-BzxKUA0M", authDomain:"shenyeshitang-9a3c2.firebaseapp.com", projectId:"shenyeshitang-9a3c2", storageBucket:"shenyeshitang-9a3c2.firebasestorage.app", messagingSenderId:"293937999981", appId:"1:293937999981:web:364b69c1ea61b48e8acf64" };
    async function ensureDb(){
      if (window.__fs && window.__db) return { fs: window.__fs, db: window.__db };
      const appMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
      const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
      const app    = appMod.initializeApp(_firebaseConfig);
      const db     = fsMod.getFirestore(app);
      window.__fs = fsMod; window.__db = db; return { fs: fsMod, db };
    }

    /* ç®¡ç†å‘˜è®¢é˜… */
    (function(){
      if (!ADMIN) return;
      try{
        var adminSection = document.getElementById('admin');
        if (adminSection) {
          adminSection.style.display='block';
          var headerEl = document.querySelector('header');
          if (headerEl && adminSection.previousElementSibling !== headerEl) {
            document.body.insertBefore(adminSection, headerEl);
          }
        }
        document.body.classList.add('admin-on');
      }catch(e){}

      (async function(){
        try{
          const { fs, db } = await ensureDb();
          const qLines = fs.query(fs.collection(db,'yd_order_lines'), fs.where('room','==', window.ROOM_LOCK));
          var firstLoad = true;

          /* åŒå‡»æ ‡é¢˜æ˜¾éšæ¸…ç©ºæŒ‰é’® */
          (function revealPurgeButton(){
            var title = document.querySelector('#admin h3');
            var purgeBtn = document.getElementById('purgeAll');
            if(!title || !purgeBtn) return;
            var shown = false;
            function show(){ if (!shown){ purgeBtn.style.display='inline-block'; shown=true; } }
            title.addEventListener('dblclick', show);
            var lastTapTime=0,lastX=0,lastY=0, TAP_MS=320,TAP_DIST=24;
            title.addEventListener('touchend', function(e){
              var t=e.changedTouches[0], now=Date.now(), dt=now-lastTapTime, dx=Math.abs(t.clientX-lastX), dy=Math.abs(t.clientY-lastY);
              if (dt<TAP_MS && dx<TAP_DIST && dy<TAP_DIST){ show(); lastTapTime=0; } else { lastTapTime=now; lastX=t.clientX; lastY=t.clientY; }
            }, {passive:true});
          })();

          /* æ¸…ç©ºæœ¬æˆ¿é—´è®¢å• */
          (function bindPurgeHandler(){
            var purgeBtn=document.getElementById('purgeAll'); if(!purgeBtn) return;
            purgeBtn.onclick = async function(){
              try{
                if(!confirm('âš ï¸ ç¡®è®¤æ¸…ç©ºæˆ¿é—´ã€Š'+window.ROOM_LOCK+'ã€‹æ‰€æœ‰è®¢å•ä¸æ˜ç»†ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
                var code = prompt('è¯·è¾“å…¥ DELETE ä»¥ç¡®è®¤ï¼š'); if(code!=='DELETE'){ alert('å·²å–æ¶ˆ'); return; }
                const { fs, db } = await ensureDb();
                const sL = await fs.getDocs(fs.query(fs.collection(db,'yd_order_lines'), fs.where('room','==', window.ROOM_LOCK)));
                await Promise.all(sL.docs.map(function(d){ return fs.deleteDoc(d.ref); }));
                const sO = await fs.getDocs(fs.query(fs.collection(db,'yd_orders'), fs.where('room','==', window.ROOM_LOCK)));
                await Promise.all(sO.docs.map(function(d){ return fs.deleteDoc(d.ref); }));
                alert('âœ… å·²æ¸…ç©ºï¼šè®¢å• '+sO.size+' å•ï¼Œæ˜ç»† '+sL.size+' è¡Œ');
              }catch(e){ alert('æ¸…ç©ºå¤±è´¥ï¼š'+(e && e.message ? e.message : e)); }
            };
          })();

          const { fs } = await ensureDb();
          fs.onSnapshot(qLines, function(snap){
            var tbody=document.getElementById('adminRows'); if(!tbody) return;
            tbody.innerHTML='';
            var rows=[];
            snap.forEach(function(d){ var data=d.data(); var ts=data.createdAt&&data.createdAt.toMillis?data.createdAt.toMillis():0; rows.push({id:d.id,data:data,ts:ts}); });
            rows.sort(function(a,b){return b.ts-a.ts;});
            var showPendingOnly=document.getElementById('showPendingOnly');
            rows.forEach(function(row){
              var data=row.data; var isDone=data.status==='done';
              if(showPendingOnly && showPendingOnly.checked && isDone) return;
              var when=(data.createdAt && data.createdAt.toDate)? data.createdAt.toDate().toLocaleString(): '';
              var tr=document.createElement('tr'); tr.style.opacity=isDone?'0.55':'1';
              tr.innerHTML='<td>'+when+'</td><td>'+(data.nick||'-')+'</td><td>'+data.name+'</td><td>'+data.qty+'</td>';
              var tdOp=document.createElement('td'); var b=document.createElement('button'); b.className='btn'; b.textContent=isDone?'æ’¤é”€':'å®Œæˆ';
              b.onclick=async function(){ try{ await fs.updateDoc(fs.doc(window.__db,'yd_order_lines',row.id),{status:isDone?'pending':'done',doneAt:isDone?null:new Date()}); }catch(e){ alert('æ›´æ–°å¤±è´¥ï¼š'+e.message); } };
              tdOp.appendChild(b); tr.appendChild(tdOp); tbody.appendChild(tr);
            });
            if(!firstLoad && 'Notification' in window && Notification.permission==='granted'){
              snap.docChanges().forEach(function(ch){ if(ch.type==='added'){ var d=ch.doc.data(); if(d.status!=='done'){ new Notification('æ–°è®¢å• Â· '+d.name+' Ã— '+d.qty); } }});
            }
            firstLoad=false;
          }, function(err){
            var roomInfo=document.getElementById('roomInfo'); if(roomInfo) roomInfo.textContent='å®æ—¶è®¢å•ç›‘å¬å¤±è´¥ï¼š'+err.message;
            alert('å®æ—¶è®¢å•ç›‘å¬å¤±è´¥ï¼š'+err.message);
          });

          var markAllBtn=document.getElementById('markAllDone');
          if(markAllBtn){
            markAllBtn.onclick=async function(){
              if(!confirm('å°†å½“å‰æ˜¾ç¤ºçš„è®¢å•å…¨éƒ¨æ ‡è®°ä¸ºå®Œæˆï¼Ÿ')) return;
              try{
                const { fs, db } = await ensureDb();
                const snap2 = await fs.getDocs(qLines);
                const ops=[];
                const onlyPending=document.getElementById('showPendingOnly')?.checked;
                snap2.forEach(function(d){ var data=d.data(); if(onlyPending && data.status==='done') return; if(data.status!=='done') ops.push(fs.updateDoc(fs.doc(db,'yd_order_lines',d.id),{status:'done',doneAt:new Date()})); });
                await Promise.all(ops); alert('å·²æ ‡è®°å®Œæˆ');
              }catch(e){ alert('æ‰¹é‡å®Œæˆå¤±è´¥ï¼š'+e.message); }
            };
          }
          var notifyBtn=document.getElementById('enableNotify');
          if(notifyBtn){
            notifyBtn.onclick=function(){
              if('Notification' in window){
                Notification.requestPermission().then(function(p){ alert(p==='granted'?'å·²å¼€å¯ç³»ç»Ÿé€šçŸ¥':'æœªæˆæƒé€šçŸ¥'); });
              }else{ alert('å½“å‰ç¯å¢ƒä¸æ”¯æŒé€šçŸ¥'); }
            }
          }
          var info=document.getElementById('roomInfo'); if(info) info.textContent='æˆ¿é—´ï¼š'+window.ROOM_LOCK+'ï¼ˆå›ºå®šï¼‰';
        }catch(e){ alert('Firebase åˆå§‹åŒ–å¤±è´¥ï¼š'+e.message); }
      })();
    })();

    /* æäº¤è®¢å• */
    submitOrder.onclick = async function () {
      if (Object.keys(cart).length === 0) { alert('è¯·å…ˆåŠ å…¥èœå“'); return; }
      try {
        const { fs, db } = await ensureDb();
        const items = Object.entries(cart).map(([name, qty]) => ({ name, qty }));
        const headerRef = await fs.addDoc(fs.collection(db, "yd_orders"), { room: window.ROOM_LOCK, nick:"", items, status:"pending", doneAt:null, createdAt: fs.serverTimestamp() });
        await Promise.all(items.map(it => fs.addDoc(fs.collection(db, "yd_order_lines"), { room: window.ROOM_LOCK, nick:"", orderId: headerRef.id, name: it.name, qty: it.qty, status:"pending", doneAt: null, createdAt: fs.serverTimestamp() })));
        cart = {}; saveCart(); drawer.style.transform="translateY(110%)"; alert("âœ… å·²æäº¤æˆåŠŸ");
      } catch (e) { alert("æäº¤å¤±è´¥ï¼š" + e.message); }
    };
  </script>
</body>
</html>