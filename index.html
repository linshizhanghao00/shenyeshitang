<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- é»˜è®¤ç”¨æˆ· manifestï¼›è¿è¡Œæ—¶æŒ‰ç®¡ç†å‘˜åˆ‡æ¢ -->
  <link id="manifestLink" rel="manifest" href="/shenyeshitang/manifest.webmanifest?iv=v7">
  <link rel="apple-touch-icon" sizes="180x180" href="/shenyeshitang/icons/moon-180.png?v=99">
  <title>æ·±å¤œé£Ÿå ‚</title>

  <!-- å…¨å±€ï¼šæˆ¿é—´ & ç‰ˆæœ¬ï¼ˆç”¨äº PWA å¼ºåˆ¶åˆ·æ–°ï¼‰ -->
  <script>
    window.ROOM_LOCK = 'å®¶åº­èšé¤';
    window.__APP_VERSION__ = 'v3';
  </script>

  <!-- ç®¡ç†å‘˜è®°å¿† + iOS A2HS ä¸¢ query å…œåº• + manifest åˆ‡æ¢ -->
  <script>
  (function () {
    try {
      var p = new URLSearchParams(location.search);
      var isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);
      var savedAdmin = localStorage.getItem('adminMode') === '1';

      if (p.get('admin') === '1' || savedAdmin) {
        localStorage.setItem('adminMode','1');
        localStorage.setItem('adminRoom', window.ROOM_LOCK);
        var link = document.getElementById('manifestLink');
        if (link) link.setAttribute('href','/shenyeshitang/manifest.admin.webmanifest?v='+(window.__APP_VERSION__||''));
      } else {
        if (isPWA && savedAdmin) {
          var base = location.pathname.replace(/\/index\.html$/, '/');
          location.replace(base + '?admin=1&r=' + encodeURIComponent(window.ROOM_LOCK) + '&v=' + (window.__APP_VERSION__||''));
          return;
        }
      }
    } catch(e) {}
  })();
  </script>

  <style>
    :root{
      --bg:#0c0c0f;--panel:#121218;--text:#e9e9f2;--muted:#98a0be;
      --brand:#7c5cff;--brand2:#3dd9b2;--accent:#ffd166;
      --safe:max(env(safe-area-inset-left),16px);--safeTop:env(safe-area-inset-top,0px)
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;font-family:ui-sans-serif,-apple-system,"PingFang SC","Microsoft YaHei",sans-serif;letter-spacing:.2px;color:var(--text);
      background:radial-gradient(1200px 600px at 70% -10%,rgba(124,92,255,.15),transparent 60%),
                 radial-gradient(1000px 500px at 0% 100%,rgba(61,217,178,.12),transparent 60%),var(--bg)
    }
    body.pwa-on header{ padding-top: calc(var(--safeTop) + 10px); }
    body.admin-on header{ padding-top: calc(var(--safeTop) + 22px); }
    body.pwa-on.admin-on header{ padding-top: calc(var(--safeTop) + 26px); }

    header{position:sticky;top:0;z-index:20;background:rgba(12,12,15,.85);backdrop-filter:blur(8px)}
    .topbar{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:18px var(--safe) 10px}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-size:24px}
    .logo::after{content:none !important;}
    .title{font-size:26px;font-weight:800}

    .search{display:flex;align-items:center;gap:8px;background:#0f0f15;border:1px solid #242438;color:var(--text);padding:10px 12px;border-radius:12px;min-width:min(260px,40vw)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;font-size:15px}

    .adminToggle{display:none}
    body.pwa-on .adminToggle{display:inline-flex}
    .adminToggle .btn{background:#1a1b26;border:1px solid #2a2a44;color:#e9e9f2;padding:10px 12px;border-radius:12px;cursor:pointer;font-size:14px}

    .tabs{display:flex;gap:10px;overflow:auto;padding:8px var(--safe) 14px}
    .pill{border:1px solid #28283e;background:#13131b;color:var(--text);padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer}
    .pill[aria-pressed="true"]{background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(61,217,178,.2));border-color:var(--brand)}

    /* åˆ†ç»„å¡ç‰‡ï¼ˆé»˜è®¤å±•å¼€ï¼Œå¯æŠ˜å ï¼‰ */
    .section{margin:18px var(--safe)}
    .section-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0 10px;padding:10px 12px;border:1px solid #2a2a44;border-radius:12px;background:linear-gradient(180deg,#12131a,#11121a);position:sticky;top:56px;z-index:5;backdrop-filter:blur(6px)}
    .section-title{display:flex;gap:10px;align-items:center;font-weight:900}
    .section-sub{color:#98a0be;font-size:12px}
    .section-toggle{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px}
    .card{display:grid;grid-template-columns:140px 1fr;background:linear-gradient(180deg,#171a24,#12131a 40%);border:1px solid #282b3f;border-radius:16px;overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .imgbox.small{aspect-ratio:4/3;background:#0a0b10}
    .imgbox.small > img.thumb{width:100%;height:100%;object-fit:cover;display:block}
    .content{padding:14px 14px 16px;display:grid;gap:8px}
    .name{font-size:18px;font-weight:900;margin:2px 0 0;color:#fff}
    .desc{font-size:13px;color:#98a0be;min-height:34px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{font-size:12px;color:#c7cbe0;border:1px dashed #2a2a44;padding:4px 8px;border-radius:999px}
    .add{margin-top:2px;background:#1a1a28;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;justify-self:start}

    /* â€œå…¨éƒ¨â€ç½‘æ ¼ */
    .grid-all{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;padding:16px}
    @media(min-width:1024px){.grid-all{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card-all{display:grid;gap:8px;background:linear-gradient(180deg,#171a24,#12131a 40%);border:1px solid #2a2a44;border-radius:16px;overflow:hidden;cursor:pointer}
    .imgbox{aspect-ratio:4/3;display:block;background:#0a0a10}
    .imgbox > img.thumb{width:100%;height:100%;object-fit:cover;display:block}
    .title-only{padding:0 10px 12px;font-weight:900;font-size:16px;color:#fff;text-align:center}

    /* è´­ç‰©è½¦ä¸è¾“å…¥ UI ä¿®å¤ */
    #cartBtn{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));background:linear-gradient(135deg,#7c5cff,#ffd166);color:#0b0b0e;border:0;border-radius:16px;padding:14px 18px;font-weight:900;box-shadow:0 14px 40px rgba(0,0,0,.45);z-index:40;font-size:16px}
    /* å›ºå®šè´´åº• + iOS ç¨³å®šæ€§å¢å¼º */
#drawer{
  position: fixed !important;
  left: 0; right: 0; bottom: 0; top: auto;   /* é’‰æ­»åº•éƒ¨ */
  width: 100% !important;                    /* å®½åº¦éšå±å¹• */
  max-height: 92vh !important;               /* è§†å£é«˜åº¦é™åˆ¶ */
  margin: 0 !important;
  border-top-left-radius: 18px !important;
  border-top-right-radius: 18px !important;
  border-bottom-left-radius: 0 !important;
  border-bottom-right-radius: 0 !important;

  /* ä½ åŸæ¥çš„è§†è§‰å¯ä»¥ç»§ç»­ä¿ç•™ï¼ˆæˆ‘åªä¿ç•™å¿…è¦é¡¹ï¼Œå‰©ä¸‹ä½ å·²æœ‰çš„æµ…è‰²é£æ ¼æ ·å¼ä¸æ”¹ï¼‰ */
  transform: translateY(110%);               /* é»˜è®¤æ”¶èµ·ï¼Œç”± JS å±•å¼€ */
  transition: transform .25s ease;
  z-index: 50;

  /* iOS æŠ–åŠ¨/å›å¼¹ä¿æŠ¤ */
  will-change: transform;
  transform: translateY(110%) translateZ(0); /* å¼ºåˆ¶ GPU åˆæˆå±‚ */
  overscroll-behavior: contain;              /* é˜²æ­¢æŠ½å±‰æœ¬ä½“è¢«æµè§ˆå™¨å›å¼¹æ‹–åŠ¨ */
}
    .drawer-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22243c}
    .drawer-ct{padding:12px 16px;max-height:60vh;overflow:auto}
    .drawer-ct{
  padding:12px 16px;
  max-height:60vh;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior: contain;   /* é˜²æ­¢æ»‘åŠ¨ç©¿é€å¡ä½ */
}
    .drawer-ft{padding:14px 16px;border-top:1px solid #22243c;display:grid;gap:10px}
    .drawer-ft .btn{font-size:16px;padding:12px 14px;border-radius:12px}
    #submitOrder{font-size:20px;padding:20px 18px;min-height:72px;border-radius:14px}
    .drawer-ft input.btn,.drawer-ft input.btn:focus{color:#fff !important;background:#161622 !important;border:1px solid #2a2a44 !important}
    .drawer-ft input.btn::placeholder{color:#c7cbe0;opacity:.85}
    .btn{background:#1a1b26;border:1px solid #2a2a44;color:#e9e9f2;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:active{transform:scale(.98)}
    #clearCart{font-size:18px;padding:14px 16px;border-radius:12px}
    .qty .btn{font-size:20px;line-height:1;padding:10px 14px;min-width:44px}
    #cartList .row-name{font-size:18px;font-weight:800}
    #cartList .row-qty{font-size:18px;font-weight:800}

    footer{margin:28px 0 120px;text-align:center;color:#98a0be;font-size:12px}
    #toast{position:fixed;top:14px;right:14px;z-index:60;display:grid;gap:8px}
    .toast{background:rgba(20,22,30,.95);border:1px solid #2a2a44;color:#e9e9f2;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.45);font-size:14px}

    /* é¡¶éƒ¨å ä½ï¼Œé¿å…åˆ˜æµ·é®æŒ¡ */
    body.admin-on::before{content:"";display:block;height:calc(env(safe-area-inset-top,0px)+22px)}
    body.pwa-on.admin-on::before{content:"";display:block;height:calc(env(safe-area-inset-top,0px)+26px)}
    body.pwa-on:not(.admin-on)::before{content:"";display:block;height:calc(env(safe-area-inset-top,0px)+10px)}

    /* å±é™©æŒ‰é’®æ ·å¼ï¼ˆæ¸…ç©ºæ•°æ®ï¼‰ */
    .btn.danger{ background:#2b1214; border-color:#5e1a1f; color:#ffb7bf; }
    .btn.danger:hover{ border-color:#e74856; color:#ffdbe0; }
    /* â€”â€” å…œåº•ï¼šç®¡ç†å‘˜åŒºæœ¬èº«å†åŠ å®‰å…¨åŒºé¡¶éƒ¨ç•™ç™½ â€”â€” */
body.admin-on #admin{
  padding-top: calc(env(safe-area-inset-top, 0px) + 22px) !important;
}
body.pwa-on.admin-on #admin{
  padding-top: calc(env(safe-area-inset-top, 0px) + 26px) !important;
}
/* é˜²æ­¢ h3 é»˜è®¤ margin-top æŠŠ padding åƒæ‰ï¼ˆå¤–è¾¹è·å¡Œé™·ï¼‰ */
#admin > *:first-child{ margin-top: 0 !important; }
/* ===== é¡¶éƒ¨å“ç‰ŒåŒºï¼šæ¨ªæ’ + è‡ªåŠ¨æ¢è¡Œ ===== */
.brand {
  display: flex;
  flex-direction: row;       /* æ¨ªå‘æ’åˆ— logo ä¸æ ‡é¢˜ */
  align-items: center;       /* å‚ç›´å±…ä¸­ */
  flex-wrap: wrap;           /* å…è®¸æ¢è¡Œï¼Œå½¢æˆä¸¤è¡Œç»“æ„ */
  gap: 6px;                  /* logo ä¸æ–‡å­—ä¹‹é—´çš„é—´è· */
  max-width: 120px;          /* æ§åˆ¶å“ç‰ŒåŒºæ€»å®½åº¦ï¼Œé˜²æ­¢è¿‡å®½ */
  line-height: 1.1;
  margin-bottom: 2px;
}

/* logoï¼šç¼©å°å°ºå¯¸ï¼Œè®©æ•´ä½“ç´§å‡‘ */
.logo {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: url('/shenyeshitang/icons/moon-180.png?v=99') center/cover no-repeat;
}

/* æ ‡é¢˜ï¼šå…è®¸æ¢è¡Œï¼Œå­—ä½“æ”¾å¤§ä¸€ç‚¹ç¡®ä¿å¯è¯» */
.title {
  font-size: 20px;
  font-weight: 800;
  color: #fff;
  white-space: normal;       /* å…è®¸è‡ªåŠ¨æ¢è¡Œ */
  word-break: keep-all;
  text-align: left;
  line-height: 1.15;
}

/* å°å±æ—¶ç¨å¾®å†ç´§å‡‘ä¸€ç‚¹ */
@media (max-width: 420px) {
  .brand { max-width: 100px; gap: 4px; }
  .logo { width: 28px; height: 28px; }
  .title { font-size: 18px; }
}
/* ================== Light Sage æ‰‹ç»˜ç³»è¦†ç›–ï¼ˆä¸å›¾æ ‡åŒç³»ï¼‰ ================== */
/* å‚è€ƒè‰²ç³»ï¼šé¼ å°¾è‰ç»¿ #8fa394 / ç±³è‰²çº¸é¢ #f6f3ea / ä½é¥±å’Œç™½ #f7f5f0 */

body{
  background:#f6f3ea !important;
  color:#2b2b2b !important;
}

/* é¡¶æ æµ…è‰²æ¯›ç»ç’ƒ + çº¸é¢æè¾¹ */
header{
  background:rgba(255,255,255,.78) !important;
  -webkit-backdrop-filter:blur(14px) saturate(150%) !important;
  backdrop-filter:blur(14px) saturate(150%) !important;
  border-bottom:2px solid #d7d0c1 !important;
  box-shadow:0 3px 6px rgba(0,0,0,.08) !important;
}

/* å“ç‰Œä¸¤è¡Œï¼ˆä¿ç•™ä½ å·²æœ‰çš„ç»“æ„ï¼‰ï¼Œé¢œè‰²åŒç³» */
.title{ color:#2b2b2b !important; text-shadow:0 1px 0 rgba(255,255,255,.55); }
.logo{
  border:2px solid #d3c8b6;               /* è½»æè¾¹ï¼Œè´´çº¸æ„Ÿ */
  box-shadow:0 2px 2px rgba(0,0,0,.10);
}

/* æœç´¢æ ï¼šçº¸æ¡è´¨æ„Ÿï¼ˆåŒç³»ç±³ç™½ï¼‰ */
.search{
  background:linear-gradient(180deg,#fdfcf9,#f4efe5 85%) !important;
  border:2px solid #cec5b4 !important;
  border-radius:12px !important;
  box-shadow:0 2px 0 #c0b6a3, 0 2px 6px rgba(0,0,0,.08) !important;
  padding:8px 12px !important;
}
.search input{ color:#2b2b2b !important; }
.search input::placeholder{ color:#8d8678 !important; }

/* åˆ†ç±»èƒ¶å›Šï¼šç±³ç™½/ç±³æï¼Œé€‰ä¸­ç”¨é¼ å°¾è‰ç»¿ */
.pill{
  border:2px solid #c5baa8 !important;
  border-radius:16px !important;
  background:linear-gradient(180deg,#fbfaf7,#efe6db) !important;
  color:#343434 !important; font-weight:700 !important;
  box-shadow:0 2px 0 #c5baa8 !important;
  padding:8px 12px !important;
}
.pill[aria-pressed="true"]{
  background:linear-gradient(180deg,#cfd8cf,#b8c6b9) !important; /* sage æ˜åº¦æ¢¯åº¦ */
  color:#1f1f1f !important; border-color:#aebaaf !important;
  box-shadow:0 2px 0 #aebaaf !important;
}

/* åˆ†ç»„æ¡ï¼šæµ…ç±³çº¸é¢ + ç»†æè¾¹ */
.section-header{
  background:linear-gradient(180deg,#fff,#f6efe4) !important;
  border:2px solid #cfc5b3 !important;
  color:#2b2b2b !important;
}

/* å¡ç‰‡ï¼šå»æ·±è‰²ï¼Œæ”¹æˆæµ…ç±³ + ç»†æè¾¹ + æŸ”å’ŒæŠ•å½± */
.card-all,.card{
  background:linear-gradient(145deg,#ffffff,#fbf6ee 70%),
             radial-gradient(420px 260px at 80% 0%,rgba(203,216,206,.35),transparent 60%) !important;
  border:2px solid #cfc5b3 !important;
  border-radius:14px !important;
  box-shadow:0 3px 0 #cfc5b3, 0 1px 10px rgba(0,0,0,.08) !important;
}
.name,.title-only{ color:#2b2b2b !important; }

/* â€”â€” ç¼©ç•¥å›¾å®¹å™¨ï¼šä¸å›¾æ ‡åŒç³»çš„é¼ å°¾è‰ç»¿æ¸å˜ï¼›ä¸å†æœ‰ç™½è‰²åœ†ç›˜ â€”â€” */
.imgbox{
  background:linear-gradient(160deg,#96a99a 0%, #c7d1c8 100%) !important; /* sage ç³»åˆ— */
  border-bottom:1px solid rgba(0,0,0,.04);
}
.imgbox > img.thumb{
  filter:saturate(1.04) brightness(1.05) !important;
  mix-blend-mode:normal !important;
}

/* è´­ç‰©è½¦/ä¸»æ“ä½œï¼šç±³ææš–è‰²ï¼Œç»Ÿä¸€è§†è§‰ */
#submitOrder,
#cartBtn{
  background:linear-gradient(180deg,#f4d089,#e6bb6a) !important;
  color:#1a1a1a !important;
  border:2px solid #d1ac67 !important;
  box-shadow:0 3px 0 #d1ac67 !important;
}

/* é€šç”¨æŒ‰é’®ï¼šä½é¥±å’Œç±³ç™½ */
.btn{
  border:2px solid #c5baa8 !important;
  border-radius:12px !important;
  background:linear-gradient(180deg,#fff,#f4ece1) !important;
  color:#2b2b2b !important; font-weight:800 !important;
  box-shadow:0 2px 0 #c5baa8 !important;
}
.drawer-ft input.btn,.drawer-ft input.btn:focus{
  background:#fff !important; color:#2b2b2b !important;
  border:2px solid #cfc5b3 !important;
}

/* æŠ½å±‰ä¸è¡¨æ ¼ï¼šæµ…ç±³çº¸é¢ + æµ…å¢¨çº¿ */
#drawer{
  background:#fbf6ee !important;
  border:2px solid #cfc5b3 !important;
  box-shadow:0 -4px 12px rgba(0,0,0,.10) !important;
  color:#2b2b2b !important;
}
table, th, td{ border-color:#cfc5b3 !important; color:#2b2b2b !important; }
thead{ background:#f2e8d9 !important; }

/* é¡¶éƒ¨å†ç•¥å¾®ç´§å‡‘ç‚¹ */
.topbar{ padding:14px var(--safe) 8px !important; }
.tabs{ padding:10px var(--safe) 12px !important; }
/* ========== å¾®è°ƒä¿®æ­£ç‰ˆï¼ˆemoji å±…ä¸­ + æè¿°åŠ æ·± + è¾“å…¥æ¡†ç°è‰²å¼ºåŒ–ï¼‰ ========== */

/* 1ï¸âƒ£ emoji å±…ä¸­å¯¹é½ */
.imgbox > img.thumb {
  object-fit: contain !important;
  display: block !important;
  margin: 0 auto !important;
  filter: saturate(1.05) brightness(1.05) !important;
  mix-blend-mode: normal !important;
  padding: 12px 0 !important; /* è®©emojiä¸Šä¸‹ç•™ç™½ç›¸ç­‰ */
}

/* 2ï¸âƒ£ èœå“æè¿°æ–‡å­—ã€tag é¢œè‰²åŠ æ·± */
.desc {
  color: #5e5a54 !important;     /* æŸ”å’Œæ·±ç°ï¼ˆæ¯”åŸè‰²ç•¥æ·±ï¼‰ */
  font-weight: 500 !important;
}
.tag {
  border: 1px dashed #a49d8e !important;
  color: #5c5851 !important;
  background: rgba(255,255,255,0.6) !important;
}

/* 3ï¸âƒ£ è´­ç‰©è½¦è¾“å…¥åŒºæ–‡å­—ä¸å ä½ç¬¦é¢œè‰²åŠ æ·± */
.drawer-ft input.btn,
.drawer-ft input.btn:focus {
  color: #4f4a44 !important;
  border-color: #bfb4a1 !important;
  background: #fffdfa !important;
}
.drawer-ft input.btn::placeholder {
  color: #857e72 !important; /* æ·±ç°ç±³è‰² */
  opacity: 1 !important;
}

/* æŠ½å±‰æ•´ä½“æ–‡å­—ç¨åŠ æ·±ï¼ˆè´­ç‰©è½¦æ ‡é¢˜ç­‰ï¼‰ */
#drawer {
  color: #4a463f !important;
}

/* â€œè´­ç‰©è½¦â€ä¸»æŒ‰é’®å­—ä½“é¢œè‰²ç»Ÿä¸€ */
#cartBtn {
  color: #3e3b35 !important;
  font-weight: 800 !important;
}

/* æäº¤æŒ‰é’®æ–‡å­—é¢œè‰²ä¿æŒæš–ç° */
#submitOrder {
  color: #3c372f !important;
}
/* æ”¶èµ·/å±•å¼€ï¼šå½“ aria-expanded="false" æ—¶éšè—åˆ—è¡¨ */
.section[aria-expanded="false"] .grid{
  display: none !important;
}

/* æ”¶èµ·æ—¶çš„å¤–è§‚å¾®è°ƒï¼ˆå¯æ”¹/å¯åˆ ï¼‰ */
.section[aria-expanded="false"]{
  margin-bottom: 10px;
}
.section[aria-expanded="false"] .section-header{
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
}
.section .section-header{
  cursor: pointer; /* æç¤ºå¯ç‚¹ */
}
/* ===== æµ…é¼ å°¾è‰ç»¿æŒ‰é’®é£æ ¼ï¼ˆåŠ å…¥ & æ”¶èµ·ï¼‰ ===== */

/* ä¸»æŒ‰é’®åº•è‰²æµ…ç»¿ï¼Œé…åˆå½“å‰ä¸»é¢˜ */
.btn,
.section-toggle {
  background: linear-gradient(180deg,#cfd8cf,#bfc9c0) !important; /* æµ…é¼ å°¾è‰ç»¿ */
  border: 1px solid #aebaaf !important;
  color: #3d413b !important;  /* æ·±ç°æ–‡å­—ï¼Œä¸æ˜¯é»‘ */
  box-shadow: 0 2px 3px rgba(0,0,0,.12) !important;
  transition: all .15s ease;
}

/* hover å’Œ active çŠ¶æ€ */
.btn:hover,
.section-toggle:hover {
  background: linear-gradient(180deg,#d8e0d8,#c8d2c8) !important;
}
.btn:active,
.section-toggle:active {
  background: linear-gradient(180deg,#b8c2b8,#aeb8ae) !important;
  transform: translateY(1px);
  box-shadow: 0 1px 2px rgba(0,0,0,.18) inset !important;
}

/* æ”¶èµ·æŒ‰é’®ï¼šæ›´è½»ã€æ›´å°åœ†è§’ */
.section-toggle {
  padding: 6px 12px !important;
  border-radius: 10px !important;
  font-weight: 700 !important;
}

/* åŠ å…¥æŒ‰é’®ï¼šå¡ç‰‡æ¯”ä¾‹é€‚é… */
.card .btn.add {
  font-size: 14px !important;
  padding: 8px 18px !important;
  border-radius: 8px !important;
  background: linear-gradient(180deg,#cfd8cf,#bfc9c0) !important;
}
/* ===== ä»…è°ƒæ•´ â€œåŠ å…¥â€ æŒ‰é’®é…è‰²ï¼Œä¿æŒä¸æ”¶èµ·ä¸€è‡´ä½†æ›´å°å·§ ===== */
.card .btn.add {
  background: linear-gradient(180deg, #cfd8cf, #bfc9c0) !important; /* æµ…é¼ å°¾è‰ç»¿ */
  border: 1px solid #aebaaf !important;
  color: #3d413b !important;  /* æ·±ç°æ–‡å­— */
  font-weight: 700 !important;
  font-size: 14px !important;
  padding: 8px 18px !important;
  border-radius: 8px !important;
  box-shadow: 0 2px 3px rgba(0,0,0,.12) !important;
  transition: all .15s ease;
}

/* hover / active çŠ¶æ€ */
.card .btn.add:hover {
  background: linear-gradient(180deg, #d8e0d8, #c8d2c8) !important;
}
.card .btn.add:active {
  background: linear-gradient(180deg, #b8c2b8, #aeb8ae) !important;
  transform: translateY(1px);
  box-shadow: 0 1px 2px rgba(0,0,0,.18) inset !important;
}
/* ç»Ÿä¸€ â€œåŠ å…¥â€ æŒ‰é’®é…è‰²ä¸ºæµ…é¼ å°¾è‰ç»¿ */
.card .add,
.card .btn.add {
  background: linear-gradient(180deg, #cfd8cf, #bfc9c0) !important;
  border: 1px solid #aebaaf !important;
  color: #3d413b !important;          /* æ·±ä¸€ç‚¹çš„ç°ï¼Œä¸æ˜¯é»‘ */
  font-weight: 700 !important;
  font-size: 14px !important;
  padding: 8px 18px !important;
  border-radius: 8px !important;
  box-shadow: 0 2px 3px rgba(0,0,0,.12) !important;
  transition: all .15s ease;
}
.card .add:hover,
.card .btn.add:hover {
  background: linear-gradient(180deg, #d8e0d8, #c8d2c8) !important;
}
.card .add:active,
.card .btn.add:active {
  background: linear-gradient(180deg, #b8c2b8, #aeb8ae) !important;
  transform: translateY(1px);
  box-shadow: 0 1px 2px rgba(0,0,0,.18) inset !important;
}
/* æŠ½å±‰æ”¹ä¸ºä¸‰æ®µå¼ï¼šå¤´éƒ¨å›ºå®š + ä¸­é—´æ»šåŠ¨ + åº•éƒ¨å›ºå®š */
#drawer{
  display: flex !important;
  flex-direction: column !important;
  max-height: calc(100vh - 20px) !important;   /* æ›´è´´è¿‘å…¨å± */
}
.drawer-ct{
  flex: 1 1 auto !important;
  overflow: auto !important;
  -webkit-overflow-scrolling: touch !important; /* iOS æƒ¯æ€§æ»šåŠ¨ */
  overscroll-behavior: contain !important;      /* é˜²æ­¢ç©¿é€åˆ°åº•å±‚é¡µé¢ */
}
.drawer-ft{
  position: sticky;
  bottom: 0;
  background: inherit;    /* è§†è§‰è¿è´¯ */
  padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px)) !important;
}
/* è´­ç‰©è½¦â€œæ¸…ç©ºâ€æŒ‰é’®ï¼ˆè½»é‡å¤–è§‚ï¼‰ */
.btn.ghost{
  background: linear-gradient(180deg, #fbfaf7, #f3eee6) !important;
  border: 1px solid #cfc5b3 !important;
  color: #6a655b !important;
  box-shadow: 0 1px 2px rgba(0,0,0,.08) !important;
  font-weight: 700 !important;
}
.btn.ghost:hover{
  background: linear-gradient(180deg, #ffffff, #f7f2ea) !important;
}
.btn.ghost:active{
  background: linear-gradient(180deg, #f0e9df, #e7dfd3) !important;
}
/* ===== ä¼˜åŒ–è´­ç‰©è½¦é«˜åº¦ï¼Œé¿å…ä¸çŠ¶æ€æ é‡å  ===== */
#drawer {
  top: calc(env(safe-area-inset-top, 0px) + 12px) !important; /* æ•´ä½“ä¸‹ç§»ä¸€ç‚¹ */
  max-height: calc(90vh - env(safe-area-inset-top, 0px)) !important; /* ä¿ç•™é¡¶éƒ¨ç•™ç™½ */
  border-top-left-radius: 18px !important;
  border-top-right-radius: 18px !important;
  overflow: hidden !important;
}

/* è°ƒæ•´æŠ½å±‰å†…éƒ¨å¸ƒå±€ï¼šä¿æŒå¯æ»šåŠ¨åŒºåŸŸå’Œåº•éƒ¨æŒ‰é’®ç¨³å®š */
.drawer-ct {
  flex: 1 1 auto !important;
  overflow: auto !important;
  -webkit-overflow-scrolling: touch !important;
  overscroll-behavior: contain !important;
}
.drawer-ft {
  position: sticky !important;
  bottom: 0 !important;
  background: inherit !important;
  padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px)) !important;
}
/* ===== ä¿®æ­£è´­ç‰©è½¦æŠ½å±‰åº•éƒ¨æ‚¬ç©ºé—®é¢˜ ===== */
#drawer {
  position: fixed !important;
  inset: auto 0 0 0 !important;        /* è´´åˆå±å¹•åº•éƒ¨ */
  width: 100% !important;
  max-height: calc(92vh - env(safe-area-inset-top, 0px)) !important;
  margin: 0 !important;
  border-top-left-radius: 18px !important;
  border-top-right-radius: 18px !important;
  border-bottom-left-radius: 0 !important;
  border-bottom-right-radius: 0 !important;
  bottom: 0 !important;
  transform: translateY(0);            /* ç¡®ä¿å±•å¼€åè´´åº• */
}

/* åº•éƒ¨åŒºåŸŸè´´åˆå®‰å…¨åŒºï¼Œæ¶ˆé™¤é¢å¤–ç©ºéš™ */
.drawer-ft {
  position: sticky !important;
  bottom: 0 !important;
  background: inherit !important;
  padding-bottom: env(safe-area-inset-bottom, 0px) !important;
  border-top: 1px solid #d4cdbf;
}
    /* ç¦ç”¨æ•´é¡µé¡¶éƒ¨/åº•éƒ¨æ©¡çš®ç­‹å›å¼¹ï¼ˆä»å¯æ­£å¸¸æ»šåŠ¨ï¼‰ */
html, body {
  height: 100%;
  overscroll-behavior-y: none;   /* é¡¶/åº•ä¸è¢«â€œæ‹‰å¼€â€ */
}

/* ä¸»å†…å®¹ä½œä¸ºå¯æ»šå®¹å™¨ï¼Œé˜²æ­¢â€œæ•´é¡µæ‹‰æ‰¯â€ */
main {
  overscroll-behavior: contain;  /* å‘ä¸Š/å‘ä¸‹çš„æ»šåŠ¨ä¸ä¼šä¼ é€’åˆ°å¤–å±‚äº§ç”Ÿå›å¼¹ */
}

/* ç®¡ç†å‘˜è¡¨æ ¼åŒºåŸŸä¹Ÿé¿å…å›å¼¹ */
#admin {
  overscroll-behavior: contain;
}

/* è´­ç‰©è½¦å¤´ã€å°¾é¿å…è§¦å‘é»˜è®¤å›å¼¹ï¼ˆä½ å·²è´´åº•å›ºå®šï¼‰ */
#drawer .drawer-hd,
#drawer .drawer-ft{
  touch-action: none;
  -webkit-user-select: none;
  user-select: none;
}
/* ========== é¡µé¢åº•éƒ¨ç•™ç™½è°ƒæ•´ï¼ˆè‡ªé€‚åº”ä¸åŒå±å¹•é«˜åº¦ï¼‰ ========== */

/* ä¸»å†…å®¹åº•éƒ¨ç•™ç™½ï¼Œé¿å…å’Œè´­ç‰©è½¦æŒ‰é’®è´´å¤ªè¿‘ */
main {
  padding-bottom: calc(
    max(60px, 8vh) + env(safe-area-inset-bottom, 0px)
  ) !important;
}

/* é¡µè„šç•™ç™½ï¼ˆç¡®ä¿åº•éƒ¨è¯´æ˜æ–‡å­—ä¸ä¼šè¢«æŒ¡ä½ï¼‰ */
footer {
  margin-bottom: calc(
    max(80px, 10vh) + env(safe-area-inset-bottom, 0px)
  ) !important;
}

/* è°ƒæ•´è´­ç‰©è½¦æŒ‰é’®ä¸åº•è¾¹çš„è·ç¦»ï¼Œè®©æŒ‰é’®åœ¨ä¸åŒè®¾å¤‡ä¸Šéƒ½è‡ªç„¶å±…ä¸­æ‚¬æµ® */
#cartBtn {
  bottom: calc(
    max(24px, 4vh) + env(safe-area-inset-bottom, 0px)
  ) !important;
}

  </style>
</head>
<body>
  <!-- ç®¡ç†å‘˜é¢æ¿ -->
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>ğŸ“Ÿ å®æ—¶è®¢å•</h3>
    <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 10px">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input id="showPendingOnly" type="checkbox" checked><span>åªçœ‹æœªåš</span></label>
      <button id="markAllDone" class="btn">æ ‡è®°å®Œæˆ</button>
      <button id="enableNotify" class="btn">å¼€å¯æé†’</button>
      <!-- é»˜è®¤éšè—çš„æ¸…ç©ºæŒ‰é’® -->
      <button id="purgeAll" class="btn danger" style="display:none">ğŸ—‘ï¸ æ¸…ç©ºæœ¬æˆ¿é—´è®¢å•</button>
    </div>
    <div id="roomInfo" style="color:#c7cbe0;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #2a2a44">
      <thead><tr><th>æ—¶é—´</th><th>æ¥æº</th><th>èœå“</th><th>æ•°é‡</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <header>
    <div class="topbar">
      <div class="brand"><div class="logo"></div><div class="title">æ·±å¤œ<br>é£Ÿå ‚</div></div>
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#8086a3" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="æœç´¢èœå/æ ‡ç­¾â€¦" />
      </div>
      <div class="adminToggle"><button id="toggleAdmin" class="btn">ğŸ‘¨â€ğŸ³ å¨æˆ¿å±</button></div>
    </div>

    <div class="tabs">
      <button class="pill" data-filter="all" aria-pressed="true">å…¨éƒ¨</button>
      <button class="pill" data-filter="Main">çƒ­èœ</button>
      <button class="pill" data-filter="Rice">ä¸»é£Ÿ</button>
      <button class="pill" data-filter="Cold">å‡‰æ‹Œèœ</button>
    </div>
  </header>

  <div id="toast" aria-live="polite"></div>
  <main id="menu-root"></main>

  <!-- è´­ç‰©è½¦ -->
  <button id="cartBtn">ğŸ›’ è´­ç‰©è½¦ <small id="cartCount">(0)</small></button>
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-hd"><strong>ğŸ›’ è´­ç‰©è½¦</strong><button class="btn" id="closeDrawer">å…³é—­</button></div>
    <div class="drawer-ct" id="cartList"></div>
    <div class="drawer-ft">
      <button id="clearCart" class="btn ghost">æ¸…ç©º</button>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div style="font-weight:700;opacity:.9">âœï¸ è‡ªå®šä¹‰ç‚¹èœ</div>
        <input id="cName" placeholder="èœåï¼ˆå¿…å¡«ï¼‰" class="btn">
        <input id="cIngs" placeholder="é£Ÿæï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼‰" class="btn">
        <button id="addCustom" class="btn">åŠ å…¥è´­ç‰©è½¦ï¼ˆè‡ªå®šä¹‰ï¼‰</button>
      </div>
      <button class="btn" id="submitOrder" style="background:linear-gradient(135deg,#7c5cff,#ffd166);color:#0b0b0e">æäº¤è®¢å•</button>
      
    </div>
  </aside>

  <footer>Â© 2025 æ·±å¤œé£Ÿå ‚ Â· å®‰è£…åˆ°ä¸»å±å¹•åç¦»çº¿å¯ç”¨ã€‚</footer>

  <script>
    /* èœå• JSONï¼ˆç»Ÿä¸€çº¿ä¸Šè·¯å¾„ï¼‰ */
    var MENU_URL = 'https://linshizhanghao00.github.io/shenyeshitang/menu.json';

    /* çŠ¶æ€åˆ¤å®š */
    var qs = new URLSearchParams(location.search);
    var isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);
    var savedAdmin = localStorage.getItem('adminMode')==='1';
    var ADMIN = (qs.get('admin')==='1') || savedAdmin;
    if (ADMIN) document.body.classList.add('admin-on');
    if (isPWA) document.body.classList.add('pwa-on');

    /* DOM */
    var root=document.getElementById('menu-root');
    var pills=document.querySelectorAll('.pill');
    var searchInput=document.getElementById('search');
    var cartBtn=document.getElementById('cartBtn');
    var drawer=document.getElementById('drawer');
    var cartList=document.getElementById('cartList');
    // ç¡®ä¿è´­ç‰©è½¦é»˜è®¤å…³é—­çŠ¶æ€
    drawer.style.transform='translateY(110%)';
    drawer.setAttribute('aria-hidden','true');
    var cartCount=document.getElementById('cartCount');
    var closeDrawer=document.getElementById('closeDrawer');
    var submitOrder=document.getElementById('submitOrder');
    var clearCart=document.getElementById('clearCart');
    var nickname=document.getElementById('nickname');
    var cName=document.getElementById('cName');
    var cIngs=document.getElementById('cIngs');
    var addCustom=document.getElementById('addCustom');
    var toggleAdmin=document.getElementById('toggleAdmin');

    /* PWA ä¸€é”®åˆ‡æ¢ç®¡ç†å‘˜/ç”¨æˆ· */
    if (toggleAdmin) {
      function refreshAdminButton(){ toggleAdmin.textContent = ADMIN ? 'ğŸ› è¿”å›ç‚¹å•' : 'ğŸ‘¨â€ğŸ³ å¨æˆ¿å±'; }
      refreshAdminButton();
      toggleAdmin.onclick = function(){
        var base = location.pathname.replace(/\/index\.html$/, '/');
        if (ADMIN) {
          localStorage.removeItem('adminMode');
          location.href = base + '?v=' + (window.__APP_VERSION__||'');
        } else {
          localStorage.setItem('adminMode','1');
          location.href = base + '?admin=1&r=' + encodeURIComponent(window.ROOM_LOCK) + '&v=' + (window.__APP_VERSION__||'');
        }
      };
    }

    /* SVG å ä½å›¾ */
    /* âœ¨ æ›¿æ¢åŸæ¥çš„ iconSVG â€”â€” ä¸å†ç»˜åˆ¶ç™½è‰²åœ†ç›˜ï¼Œåªæ”¾ emoji */
function iconSVG(e, label){
  var svg = encodeURIComponent(
    "<?xml version='1.0'?>"
   +"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'>"
   /* èƒŒæ™¯é€æ˜ï¼Œç”± .imgbox æä¾›é¼ å°¾è‰ç»¿æ¸å˜ */
   +"<rect width='220' height='220' fill='none'/>"
   /* ä»…ç»˜åˆ¶ emojiï¼Œä½ç½®ç•¥é ä¸Šæ›´åè°ƒ */
   +"<text x='110' y='115' font-size='96' text-anchor='middle'>"+(e||'ğŸ½ï¸')+"</text>"
   /* å¯é€‰ï¼šä¸‹é¢è¿™è¡Œå¦‚æœä½ æƒ³ä¿ç•™ä¸­æ–‡æ ‡é¢˜å°è´´çº¸å°±ç•™ï¼Œä¸æƒ³è¦å¯ä»¥åˆ  */
   // +"<text x='110' y='190' font-size='0' text-anchor='middle'>"+label+"</text>"
   +"</svg>"
  );
  var im = new Image();
  im.className = 'thumb loaded';
  im.alt = label;
  im.src = 'data:image/svg+xml;utf8,' + svg;
  return im;
}
    function mediaFor(item){ return iconSVG(item.emoji,item.name_cn); }

    /* ============== åˆ†ç±» / åˆ†ç»„æ¸²æŸ“ï¼ˆæŒ‰ä½ çš„â€œé€»è¾‘æ”¹è¿›æ‘˜è¦â€ï¼‰ ============== */
    var MENU=[];

    function groupSection(title, items){
  var sec=document.createElement('section'); sec.className='section'; sec.setAttribute('aria-expanded','true');
  var header=document.createElement('div'); header.className='section-header';
  header.innerHTML="<div class='section-title'><span>"+title+"</span><span class='section-sub'>å…± "+items.length+" é“</span></div>";
  var btn=document.createElement('button'); btn.className='section-toggle'; btn.textContent='æ”¶èµ·';
  header.appendChild(btn);

  // âœ… æ–°å¢ï¼šæ•´æ¡æ ‡é¢˜æ éƒ½å¯ç‚¹å‡»æ”¶èµ·/å±•å¼€
  function toggle(){
    var open = sec.getAttribute('aria-expanded') !== 'false';
    sec.setAttribute('aria-expanded', open ? 'false' : 'true');
    btn.textContent = open ? 'å±•å¼€' : 'æ”¶èµ·';
  }
  btn.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
  header.addEventListener('click', function(e){
    if (e.target === btn) return;
    toggle();
  });

      var grid=document.createElement('div'); grid.className='grid';
      items.forEach(function(it){
        var card=document.createElement('article'); card.className='card';
        var imgbox=document.createElement('div'); imgbox.className='imgbox small'; imgbox.appendChild(mediaFor(it));
        var content=document.createElement('div'); content.className='content';
        content.innerHTML="<h3 class='name'>"+it.name_cn+(it.name_en?' Â· '+it.name_en:'')+"</h3>"
          +"<p class='desc'>"+(it.desc||'')+"</p>"
          +"<div class='tags'>"+((it.tags||[]).map(function(t){return '<span class=\"tag\">'+t+'</span>';}).join(''))+"</div>"
          +"<button class='add' data-item='"+it.name_cn+"'>åŠ å…¥</button>";
        content.querySelector('.add').onclick=function(){ cart[it.name_cn]=(cart[it.name_cn]||0)+1; saveCart(); };
        card.appendChild(imgbox); card.appendChild(content); grid.appendChild(card);
      });
      sec.appendChild(header); sec.appendChild(grid); return sec;
    }

    function gridAll(items){
      var grid=document.createElement('div'); grid.className='grid-all';
      var q=(searchInput.value||'').trim().toLowerCase();
      items.filter(function(it){
        var hay=(it.name_cn+' '+(it.name_en||'')+' '+(it.category||'')+' '+(it.tags||[]).join(' ')).toLowerCase();
        return !q || hay.includes(q);
      }).forEach(function(it){
        var card=document.createElement('article'); card.className='card-all';
        var imgbox=document.createElement('div'); imgbox.className='imgbox'; imgbox.appendChild(mediaFor(it));
        var t=document.createElement('div'); t.className='title-only'; t.textContent=it.name_cn;
        card.appendChild(imgbox); card.appendChild(t);
        card.onclick=function(){ cart[it.name_cn]=(cart[it.name_cn]||0)+1; saveCart(); };
        grid.appendChild(card);
      });
      return grid;
    }

    function renderMenu(){
      root.innerHTML='';
      var q=(searchInput.value||'').trim().toLowerCase();
      function matchQ(it){
        var hay=(it.name_cn+' '+(it.name_en||'')+' '+(it.category||'')+' '+(it.tags||[]).join(' ')).toLowerCase();
        return !q || hay.includes(q);
      }
      function hasTag(it, tag){ return (it.tags||[]).indexOf(tag)>-1; }
      function nameHas(it, kwCN){ return (it.name_cn||'').indexOf(kwCN)>-1; }

      var activeEl=document.querySelector('.pill[aria-pressed="true"]');
      var active = activeEl ? activeEl.dataset.filter : 'all';

      if (active === 'all') { root.appendChild(gridAll(MENU)); return; }

      /* â€”â€” çƒ­èœï¼ˆMainï¼‰ ä¸‰ç»„ â€”â€” */
      if (active === 'Main') {
        var soup = MENU.filter(function(it){ return matchQ(it) && hasTag(it,'Soup'); });
        var veg  = MENU.filter(function(it){ return matchQ(it) && it.category==='Veg'  && !hasTag(it,'Cold'); });
        var meat = MENU.filter(function(it){ return matchQ(it) && it.category==='Main' && !hasTag(it,'Soup'); });

        if (meat.length) root.appendChild(groupSection('ğŸ¥© è‚‰èœ', meat));
        if (veg.length)  root.appendChild(groupSection('ğŸ¥¦ ç´ èœ', veg));
        if (soup.length) root.appendChild(groupSection('ğŸ² æ±¤ç±»', soup));
        return;
      }

      /* â€”â€” ä¸»é£Ÿï¼ˆRiceï¼‰ ä¸‰ç»„ â€”â€” */
      if (active === 'Rice') {
        var rice   = MENU.filter(function(it){ return matchQ(it) && it.category==='Rice' && nameHas(it,'é¥­'); });
        var noodle = MENU.filter(function(it){ return matchQ(it) && it.category==='Rice' && nameHas(it,'é¢'); });
        var pastry = MENU.filter(function(it){ return matchQ(it) && it.category==='Rice' && !nameHas(it,'é¥­') && !nameHas(it,'é¢'); });

        if (rice.length)   root.appendChild(groupSection('ğŸš é¥­', rice));
        if (noodle.length) root.appendChild(groupSection('ğŸœ é¢', noodle));
        if (pastry.length) root.appendChild(groupSection('ğŸ¥Ÿ é¢é£Ÿ', pastry));
        return;
      }

      /* â€”â€” å‡‰æ‹Œèœï¼ˆColdï¼‰ ä¸ç»†åˆ† â€”â€” */
      if (active === 'Cold') {
        var cold = MENU.filter(function(it){ return matchQ(it) && hasTag(it,'Cold'); });
        if (cold.length) root.appendChild(groupSection('ğŸ¥’ å‡‰æ‹Œèœ', cold));
        return;
      }
    }

    pills.forEach(function(btn){
      btn.addEventListener('click', function(){
        pills.forEach(function(b){ b.setAttribute('aria-pressed','false'); });
        btn.setAttribute('aria-pressed','true');
        renderMenu();
      });
    });
    searchInput.addEventListener('input', renderMenu);

    /* è´­ç‰©è½¦ */
    var cart; try { cart = JSON.parse(localStorage.getItem('yd_cart') || '{}'); } catch { cart = {}; }
    function saveCart(){ localStorage.setItem('yd_cart', JSON.stringify(cart)); renderCart(); }
    function renderCart(){
      var list=document.getElementById('cartList'); var count=document.getElementById('cartCount');
      list.innerHTML=''; var total=0;
      Object.keys(cart).forEach(function(name){
        var qty=cart[name]; total+=qty;
        var row=document.createElement('div');
        row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='12px';
        row.style.alignItems='center'; row.style.padding='12px 0'; row.style.borderBottom='1px dashed #2a2a44';
        row.innerHTML='<strong class="row-name">'+name+'</strong><div></div>'
          +'<div class="qty row-qty"><button class="btn" data-op="-">-</button> <span>'+qty+'</span> <button class="btn" data-op="+">+</button></div>';
        row.querySelector('[data-op="-"]').onclick=function(){ cart[name]=Math.max(0,(cart[name]||0)-1); if(cart[name]===0) delete cart[name]; saveCart(); };
        row.querySelector('[data-op="+"]').onclick=function(){ cart[name]=(cart[name]||0)+1; saveCart(); };
        list.appendChild(row);
      });
      count.textContent='('+total+')';
    }
    cartBtn.onclick=function(){ drawer.style.transform='translateY(0)'; drawer.setAttribute('aria-hidden','false'); };
    closeDrawer.onclick=function(){ drawer.style.transform='translateY(110%)'; drawer.setAttribute('aria-hidden','true'); };
    clearCart.onclick=function(){ cart={}; saveCart(); };
    // è‡ªå®šä¹‰åŠ å…¥ï¼šæˆåŠŸåæ¸…ç©ºè¾“å…¥å¹¶ç»™ä¸€ç‚¹è½»åé¦ˆ
addCustom.onclick = function () {
  var name = (cName.value || '').trim();
  var ings = (cIngs.value || '').trim();

  if (!name) {
    alert('è¯·å…ˆè¾“å…¥èœå');
    cName.focus();
    return;
  }

  // ç»Ÿä¸€ key çš„æ ¼å¼ï¼Œé¿å…â€œç©ºæ ¼/å¤§å°å†™å·®å¼‚â€å¯¼è‡´é‡å¤é¡¹
  var display = ings ? ('è‡ªå®šä¹‰ Â· ' + name + 'ï¼ˆ' + ings + 'ï¼‰') : ('è‡ªå®šä¹‰ Â· ' + name);

  cart[display] = (cart[display] || 0) + 1;
  saveCart();

  // âœ… æ¸…ç©ºè¾“å…¥
  cName.value = '';
  cIngs.value = '';

  // å¯é€‰ï¼šæ”¶èµ·é”®ç›˜/è½»æŒ¯åŠ¨åé¦ˆ
  cName.blur(); cIngs.blur();
  if (navigator.vibrate) { try { navigator.vibrate(16); } catch(e){} }
};
    renderCart();

    /* åŠ è½½èœå• JSON */
    fetch(MENU_URL, { cache:'no-store' })
      .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(function(d){ MENU = Array.isArray(d)? d : []; renderMenu(); })
      .catch(function(e){ console.error('[menu] load failed', e); });

    /* Firestoreï¼ˆæ¨¡å—æ–¹å¼ï¼‰ */
    const _firebaseConfig = {
      apiKey: "AIzaSyA45H7MVPejI-09EmX3Y9RP0G-BzxKUA0M",
      authDomain: "shenyeshitang-9a3c2.firebaseapp.com",
      projectId: "shenyeshitang-9a3c2",
      storageBucket: "shenyeshitang-9a3c2.firebasestorage.app",
      messagingSenderId: "293937999981",
      appId: "1:293937999981:web:364b69c1ea61b48e8acf64"
    };
    async function ensureDb(){
      if (window.__fs && window.__db) return { fs: window.__fs, db: window.__db };
      const appMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
      const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
      const app    = appMod.initializeApp(_firebaseConfig);
      const db     = fsMod.getFirestore(app);
      window.__fs = fsMod; window.__db = db; return { fs: fsMod, db };
    }

    /* ç®¡ç†å‘˜è®¢é˜… */
    (function(){
      if (!ADMIN) return;
      try{
        var adminSection = document.getElementById('admin');
        if (adminSection) {
          adminSection.style.display='block';
          var headerEl = document.querySelector('header');
          if (headerEl && adminSection.previousElementSibling !== headerEl) {
            document.body.insertBefore(adminSection, headerEl);
          }
        }
        document.body.classList.add('admin-on');
      }catch(e){}

      (async function(){
        try{
          const { fs, db } = await ensureDb();
          // === Admin rows cache + instant filter render ===
let __ADMIN_LAST_ROWS__ = [];

function renderAdminRowsCached(){
  const tbody = document.getElementById('adminRows');
  if (!tbody) return;
  const only = document.getElementById('showPendingOnly');

  tbody.innerHTML = '';
  __ADMIN_LAST_ROWS__.forEach(row => {
    const d = row.data;
    const isDone = d.status === 'done';
    if (only && only.checked && isDone) return;

    const when = (d.createdAt && d.createdAt.toDate)
      ? d.createdAt.toDate().toLocaleString()
      : '';

    const tr = document.createElement('tr');
    tr.style.opacity = isDone ? '0.55' : '1';
    tr.innerHTML =
      `<td>${when}</td><td>${d.nick || '-'}</td><td>${d.name}</td><td>${d.qty}</td>`;

    const tdOp = document.createElement('td');
    const btn  = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = isDone ? 'æ’¤é”€' : 'å®Œæˆ';
    btn.onclick = async () => {
      try{
        await fs.updateDoc(fs.doc(db,'yd_order_lines',row.id), {
          status: isDone ? 'pending' : 'done',
          doneAt: isDone ? null : new Date()
        });
      }catch(e){ alert('æ›´æ–°å¤±è´¥ï¼š' + e.message); }
    };
    tdOp.appendChild(btn);
    tr.appendChild(tdOp);
    tbody.appendChild(tr);
  });
}

// å‹¾é€‰â€œåªçœ‹æœªåšâ€æ—¶ç«‹å³åˆ·æ–°
const _chkOnly = document.getElementById('showPendingOnly');
if (_chkOnly) _chkOnly.addEventListener('change', renderAdminRowsCached);

          const qLines = fs.query(fs.collection(db,'yd_order_lines'), fs.where('room','==', window.ROOM_LOCK));
          var firstLoad = true;

          /* ===== æ”¹ä¸ºï¼šåŒå‡» æ˜¾ç¤ºéšè—æŒ‰é’® ===== */
          (function revealPurgeButton(){
            var title = document.querySelector('#admin h3');
            var purgeBtn = document.getElementById('purgeAll');
            if(!title || !purgeBtn) return;

            var shown = false;
            function show(){
              if (!shown) { purgeBtn.style.display = 'inline-block'; shown = true; }
            }

            // é¼ æ ‡/è§¦æ§æ¿ï¼šåŒå‡»
            title.addEventListener('dblclick', show);

            // è§¦å±åŒå‡»ï¼ˆä¸¤æ¬¡ tap é—´éš”ä¸ä½ç§»é˜ˆå€¼ï¼‰
            var lastTapTime = 0, lastX = 0, lastY = 0;
            var TAP_MS = 320, TAP_DIST = 24;
            title.addEventListener('touchend', function(e){
              var t = e.changedTouches[0];
              var now = Date.now();
              var dt = now - lastTapTime;
              var dx = Math.abs(t.clientX - lastX);
              var dy = Math.abs(t.clientY - lastY);
              if (dt < TAP_MS && dx < TAP_DIST && dy < TAP_DIST) {
                show();
                lastTapTime = 0;
              } else {
                lastTapTime = now; lastX = t.clientX; lastY = t.clientY;
              }
            }, { passive: true });
          })();

          /* ===== æ¸…ç©ºæœ¬æˆ¿é—´è®¢å•ï¼ˆéœ€è¾“å…¥ DELETEï¼‰ ===== */
          (function bindPurgeHandler(){
            var purgeBtn = document.getElementById('purgeAll');
            if(!purgeBtn) return;
            purgeBtn.onclick = async function(){
              try{
                if(!confirm('âš ï¸ ç¡®è®¤æ¸…ç©ºæˆ¿é—´ã€Š'+window.ROOM_LOCK+'ã€‹æ‰€æœ‰è®¢å•ä¸æ˜ç»†ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
                var code = prompt('è¯·è¾“å…¥ DELETE ä»¥ç¡®è®¤ï¼š');
                if(code!=='DELETE'){ alert('å·²å–æ¶ˆ'); return; }

                // å…ˆåˆ æ˜ç»†
                const qL = fs.query(fs.collection(db,'yd_order_lines'), fs.where('room','==', window.ROOM_LOCK));
                const sL = await fs.getDocs(qL);
                await Promise.all(sL.docs.map(function(d){ return fs.deleteDoc(d.ref); }));

                // å†åˆ è®¢å•å¤´
                const qO = fs.query(fs.collection(db,'yd_orders'), fs.where('room','==', window.ROOM_LOCK));
                const sO = await fs.getDocs(qO);
                await Promise.all(sO.docs.map(function(d){ return fs.deleteDoc(d.ref); }));

                alert('âœ… å·²æ¸…ç©ºï¼šè®¢å• '+sO.size+' å•ï¼Œæ˜ç»† '+sL.size+' è¡Œ');
              }catch(e){
                console.error('æ¸…ç©ºå¤±è´¥ï¼š', e);
                alert('æ¸…ç©ºå¤±è´¥ï¼š'+(e && e.message ? e.message : e));
              }
            };
          })();

  fs.onSnapshot(qLines, function(snap){
  // æ”¶é›†å¹¶æ’åº
  const rows = [];
  snap.forEach(function(d){
    const data = d.data();
    const ts = (data.createdAt && data.createdAt.toMillis) ? data.createdAt.toMillis() : 0;
    rows.push({ id:d.id, data, ts });
  });
  rows.sort((a,b)=> b.ts - a.ts);

  // ç¼“å­˜å¹¶æ¸²æŸ“ï¼ˆä½¿â€œåªçœ‹æœªåšâ€èƒ½å³ç‚¹å³åˆ·ï¼‰
  __ADMIN_LAST_ROWS__ = rows;
  renderAdminRowsCached();

  // ===== ä¸‹é¢ä¿ç•™ä½ åŸæœ‰â€œæ–°å¢æé†’/firstLoadâ€é€»è¾‘ =====
  if(!firstLoad && 'Notification' in window && Notification.permission==='granted'){
    snap.docChanges().forEach(function(ch){
      if(ch.type==='added'){
        const d=ch.doc.data();
        if(d.status!=='done'){ new Notification('æ–°è®¢å• Â· '+d.name+' Ã— '+d.qty); }
      }
    });
  }
  firstLoad=false;
}, function(err){
  console.error('å®æ—¶è®¢å•ç›‘å¬å¤±è´¥ï¼š', err);
  const roomInfo=document.getElementById('roomInfo');
  if(roomInfo) roomInfo.textContent='å®æ—¶è®¢å•ç›‘å¬å¤±è´¥ï¼š'+err.message;
  alert('å®æ—¶è®¢å•ç›‘å¬å¤±è´¥ï¼š'+err.message);
});


          var markAllBtn=document.getElementById('markAllDone');
          if(markAllBtn){
            markAllBtn.onclick=async function(){
              if(!confirm('å°†å½“å‰æ˜¾ç¤ºçš„è®¢å•å…¨éƒ¨æ ‡è®°ä¸ºå®Œæˆï¼Ÿ')) return;
              try{
                const snap2 = await fs.getDocs(qLines);
                const ops=[];
                const onlyPending=document.getElementById('showPendingOnly')?.checked;
                snap2.forEach(function(d){ var data=d.data(); if(onlyPending && data.status==='done') return; if(data.status!=='done') ops.push(fs.updateDoc(fs.doc(db,'yd_order_lines',d.id),{status:'done',doneAt:new Date()})); });
                await Promise.all(ops); alert('å·²æ ‡è®°å®Œæˆ');
              }catch(e){ alert('æ‰¹é‡å®Œæˆå¤±è´¥ï¼š'+e.message); }
            };
          }

          var notifyBtn=document.getElementById('enableNotify');
          if(notifyBtn){
            notifyBtn.onclick=function(){
              if('Notification' in window){
                Notification.requestPermission().then(function(p){ alert(p==='granted'?'å·²å¼€å¯ç³»ç»Ÿé€šçŸ¥':'æœªæˆæƒé€šçŸ¥'); });
              }else{
                alert('å½“å‰ç¯å¢ƒä¸æ”¯æŒé€šçŸ¥');
              }
            }
          }

          var info=document.getElementById('roomInfo');
          if(info) info.textContent='æˆ¿é—´ï¼š'+window.ROOM_LOCK+'ï¼ˆå›ºå®šï¼‰';

        }catch(e){
          console.warn('Firebase åˆå§‹åŒ–å¤±è´¥ï¼š', e);
          alert('Firebase åˆå§‹åŒ–å¤±è´¥ï¼š'+e.message);
        }
      })();
    })();

    /* æäº¤è®¢å• */
    submitOrder.onclick = async function () {
      if (Object.keys(cart).length === 0) { alert('è¯·å…ˆåŠ å…¥èœå“'); return; }
      try {
        const { fs, db } = await ensureDb();
        const nick = (nickname && nickname.value ? nickname.value.trim() : '');
        const items = Object.entries(cart).map(([name, qty]) => ({ name, qty }));

        const headerRef = await fs.addDoc(fs.collection(db, "yd_orders"), {
          room: window.ROOM_LOCK, nick, items,
          status: "pending", doneAt: null, createdAt: fs.serverTimestamp()
        });
        await Promise.all(items.map(it => fs.addDoc(fs.collection(db, "yd_order_lines"), {
          room: window.ROOM_LOCK, nick, orderId: headerRef.id,
          name: it.name, qty: it.qty, status: "pending", doneAt: null, createdAt: fs.serverTimestamp()
        })));

        cart = {}; saveCart(); drawer.style.transform = "translateY(110%)"; alert("âœ… å·²æäº¤æˆåŠŸ");
      } catch (e) {
        console.error("æäº¤å¤±è´¥ï¼š", e); alert("æäº¤å¤±è´¥ï¼š" + e.message);
      }
    };
  </script>
</body>
</html>
