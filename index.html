<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <!-- GitHub Pages å­è·¯å¾„ -->
  <link rel="manifest" href="/shenyeshitang/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/shenyeshitang/icons/icon-192.png">
  <title>æ·±å¤œé£Ÿå ‚</title>
  <style>
    :root{ --bg:#0c0c0f;--panel:#121218;--muted:#8a8fa3;--text:#e9e9f2;--brand:#7c5cff;--brand2:#3dd9b2;--accent:#ffd166;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35);--safe:max(env(safe-area-inset-left),16px); }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif;letter-spacing:.2px;color:var(--text);background:
      radial-gradient(1200px 600px at 70% -10%, rgba(124,92,255,.15), transparent 60%),
      radial-gradient(1000px 500px at 0% 100%, rgba(61,217,178,.12), transparent 60%),var(--bg)}

    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(12,12,15,.9), rgba(12,12,15,.6) 70%, transparent);backdrop-filter:blur(8px)}
    .topbar{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;padding:18px var(--safe) 10px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;position:relative;box-shadow:var(--shadow);background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:900;font-size:24px}
    .logo::after{content:'ğŸŒ™'}
    .title{font-size:clamp(22px,3.2vw,30px);font-weight:800}

    .search{display:flex;align-items:center;gap:8px;background:#0f0f15;border:1px solid #242438;color:var(--text);padding:10px 12px;border-radius:12px;min-width:min(360px,60vw)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;font-size:15px}

    .tabs{display:flex;gap:10px;overflow:auto;padding:8px var(--safe) 14px}
    .pill{border:1px solid #28283e;background:#13131b;color:var(--text);padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer;flex:0 0 auto}
    .pill[aria-pressed="true"]{background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(61,217,178,.2));border-color:var(--brand)}

    /* â€”â€” è¯¦ç»†å¡ç‰‡ï¼ˆçƒ­èœ/ä¸»é£Ÿ/å‡‰æ‹Œèœä½¿ç”¨ï¼‰ â€”â€” */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px}
    .card{
      display:grid; grid-template-columns:140px 1fr; gap:0;
      background:linear-gradient(180deg,#171a24,#12131a 40%);
      border:1px solid #282b3f; border-radius:16px; overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,.35); transition:transform .18s ease,border-color .18s;
    }
    .card:hover{ transform:translateY(-3px); border-color:#3b3f5b; }
    .imgbox{ position:relative; background:#0a0b10; aspect-ratio:4/3; overflow:hidden; }
    .thumb{ width:100%; height:100%; object-fit:cover; transform:scale(1.02); transition:transform .25s ease; }
    .card:hover .thumb{ transform:scale(1.05); }
    .content{ padding:14px 14px 16px; display:grid; align-content:start; gap:8px }
    .name{ font-size:18px; font-weight:900; margin:2px 0 0; color:#fff }
    .desc{ font-size:13px; color:#98a0be; min-height:34px }
    .tags{ display:flex; flex-wrap:wrap; gap:8px }
    .tag{ font-size:12px; color:#c7cbe0; border:1px dashed #2d2d44; padding:4px 8px; border-radius:999px }
    .add{margin-top:2px;background:#1a1a28;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer;justify-self:start}
    .add:hover{border-color:var(--brand)}

    /* â€”â€” â€œå…¨éƒ¨â€é¡µï¼šå¤§å›¾ä¸¤åˆ— â€”â€” */
    .grid-all{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr)); /* ä¸¤åˆ— */
      gap:14px;
      padding:0 16px 16px;
    }
    @media (min-width:1024px){ .grid-all{grid-template-columns:repeat(3,minmax(0,1fr));} }
    .card-all{
      display:grid; gap:8px;
      background:linear-gradient(180deg,#171a24,#12131a 40%);
      border:1px solid #2a2a44; border-radius:16px; overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      cursor:pointer; user-select:none;
      transition:transform .18s ease,border-color .18s;
    }
    .card-all:hover{ transform:translateY(-3px); border-color:#3b3f5b; }
    .card-all .imgbox{ aspect-ratio:4/3; }
    .title-only{
      padding:0 10px 12px;
      font-weight:900; font-size:16px; color:#fff;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* â€”â€” åˆ†ç»„æ ‡é¢˜ + æŠ˜å ï¼ˆç”¨äºçƒ­èœ/ä¸»é£Ÿ/å‡‰æ‹Œèœï¼‰ â€”â€” */
    .section{ margin:18px var(--safe); }
    .section-header{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin:6px 0 10px;padding:10px 12px;border:1px solid #2a2a44;
      border-radius:12px;background:linear-gradient(180deg,#12131a,#11121a);
      position:sticky;top:56px;z-index:5;backdrop-filter:blur(6px);
    }
    .section-title{display:flex;align-items:center;gap:10px;font-weight:900}
    .section-sub{color:#8a8fa3;font-size:12px}
    .section-toggle{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .section[aria-expanded="false"] .grid{ display:none }

    /* â€”â€” ç®¡ç†å‘˜å·¥å…·æ¡ â€”â€” */
    #admin .toolbar{display:flex;gap:12px;align-items:center;margin:8px 0 10px;position:sticky;top:56px;z-index:5;background:rgba(12,12,15,.85);backdrop-filter:blur(6px);padding:6px 8px;border-radius:10px;border:1px solid #2a2a44}

    /* â€”â€” è´­ç‰©è½¦æŠ½å±‰ â€”â€” */
    #cartBtn{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));background:linear-gradient(135deg,var(--brand),var(--accent));color:#0b0b0e;border:0;border-radius:16px;padding:12px 16px;font-weight:900;box-shadow:0 14px 40px rgba(0,0,0,.45);z-index:40}
    #cartBtn small{opacity:.8}
    #drawer{position:fixed;inset:auto 0 0 auto;right:0;width:min(420px,96vw);max-height:86vh;background:#0f0f16;border-top-left-radius:18px;border:1px solid #2a2a44;box-shadow:0 -20px 60px rgba(0,0,0,.6);transform:translateY(110%);transition:transform .25s ease;z-index:50}
    #drawer.open{transform:translateY(0)}
    .drawer-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22243c}
    .drawer-ct{padding:12px 16px;max-height:60vh;overflow:auto}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:10px 0;border-bottom:1px dashed #2a2a44}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:28px;height:28px;border-radius:8px;background:#19192a;border:1px solid #2a2a44;color:#fff;cursor:pointer}
    .drawer-ft{padding:14px 16px;border-top:1px solid #22243c;display:grid;gap:8px}
    .primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:#0b0b0e;border:0;border-radius:12px;padding:12px;font-weight:900;cursor:pointer}
    .muted{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:12px;padding:10px;cursor:pointer}
    input.muted{background:#161622;border:1px solid #2a2a44;color:#fff}
    footer{margin:28px 0 120px;text-align:center;color:#98a0be;font-size:12px}
  </style>
</head>
<body>
  <!-- ç®¡ç†å‘˜é¢æ¿ï¼ˆadmin=1 æ—¶é¡¶éƒ¨å±•ç¤ºï¼‰ -->
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>ğŸ“Ÿ å®æ—¶è®¢å•</h3>
    <div class="toolbar">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
        <input id="showPendingOnly" type="checkbox" checked>
        <span>åªçœ‹æœªåš</span>
      </label>
      <button id="markAllDone" class="muted">å°†å½“å‰æ˜¾ç¤ºçš„å…¨éƒ¨æ ‡è®°ä¸ºå®Œæˆ</button>
    </div>
    <div id="roomInfo" style="color:#c7cbe0;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #2a2a44">
      <thead>
        <tr>
          <th style="border:1px solid #2a2a44;padding:8px 10px">æ—¶é—´</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">æ¥æº</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">èœå“</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">æ•°é‡</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="moon"></div>
        <div><div class="title">æ·±å¤œé£Ÿå ‚</div></div>
      </div>
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#8086a3" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="æœç´¢èœå/æ ‡ç­¾â€¦" aria-label="æœç´¢èœå•" />
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="åˆ†ç±»ç­›é€‰">
      <button class="pill" data-filter="all" aria-pressed="true">å…¨éƒ¨</button>
      <button class="pill" data-filter="Main">çƒ­èœ</button>
      <button class="pill" data-filter="Rice">ä¸»é£Ÿ</button>
      <button class="pill" data-filter="Cold">å‡‰æ‹Œèœ</button>
    </div>
  </header>

  <!-- æ¸²æŸ“æ ¹èŠ‚ç‚¹ -->
  <main id="menu-root"></main>

  <!-- è´­ç‰©è½¦æŠ½å±‰ -->
  <button id="cartBtn">ğŸ›’ è´­ç‰©è½¦ <small id="cartCount">(0)</small></button>
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-hd">
      <strong>ğŸ›’ è´­ç‰©è½¦</strong>
      <button class="muted" id="closeDrawer">å…³é—­</button>
    </div>

    <!-- è‡ªå®šä¹‰ç‚¹èœ -->
    <div id="customDish" style="display:grid;gap:8px;margin:6px 16px 6px">
      <div style="font-weight:700;opacity:.9">âœï¸ è‡ªå®šä¹‰ç‚¹èœ</div>
      <input id="cName" placeholder="èœåï¼ˆå¿…å¡«ï¼‰" class="muted" style="padding:10px;border-radius:10px">
      <input id="cIngs" placeholder="é£Ÿæï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼šå¦‚ ç‰›è‚‰, æ´‹è‘± ï¼‰" class="muted" style="padding:10px;border-radius:10px">
      <button id="addCustom" class="primary">åŠ å…¥è´­ç‰©è½¦ï¼ˆè‡ªå®šä¹‰ï¼‰</button>
    </div>

    <div class="drawer-ct" id="cartList"></div>
    <div class="drawer-ft">
      <input id="nickname" placeholder="å¤‡æ³¨ / æ¡Œå· (é€‰å¡«)" class="muted" style="padding:10px;border-radius:10px" />
      <button class="primary" id="submitOrder">æäº¤è®¢å•</button>
      <button class="muted" id="clearCart">æ¸…ç©º</button>
    </div>
  </aside>

  <footer>Â© 2025 æ·±å¤œé£Ÿå ‚ Â· å®‰è£…åˆ°ä¸»å±å¹•åç¦»çº¿å¯ç”¨ã€‚åº—ä¸»åœ¨é“¾æ¥ååŠ  <code>?admin=1</code> å¯æŸ¥çœ‹å®æ—¶è®¢å•ã€‚</footer>

  <script>
    const BASE = '/shenyeshitang';

    const iconSVG = (emoji, label) => {
      const svg = encodeURIComponent(`<?xml version='1.0' encoding='UTF-8'?>
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#7c5cff'/><stop offset='100%' stop-color='#3dd9b2'/></linearGradient></defs>
  <rect width='220' height='220' rx='28' fill='url(#g)'/>
  <circle cx='110' cy='118' r='72' fill='white'/><circle cx='110' cy='118' r='58' fill='#f4f4f4'/>
  <text x='110' y='124' font-size='72' text-anchor='middle' dominant-baseline='middle'>${emoji || 'ğŸ½ï¸'}</text>
  <rect x='60' y='168' width='100' height='28' rx='14' fill='rgba(0,0,0,.45)'/>
  <text x='110' y='184' font-size='14' text-anchor='middle' fill='white' font-weight='700'>${label}</text>
</svg>`);
      return `<img class="thumb" alt="${label}" src="data:image/svg+xml;utf8,${svg}">`;
    };
    const mediaFor = (item) => {
      // è‹¥ä»¥åç”¨å›¾ç‰‡ï¼šif (item.img) return `<img class="thumb" src="${item.img}" alt="${item.name_cn}" loading="lazy">`;
      return iconSVG(item.emoji, item.name_cn);
    };

    const root = document.getElementById('menu-root');
    const pills = document.querySelectorAll('.pill');
    const searchInput = document.getElementById('search');
    const cartBtn = document.getElementById('cartBtn');
    const drawer = document.getElementById('drawer');
    const cartList = document.getElementById('cartList');
    const cartCount = document.getElementById('cartCount');
    const nickname = document.getElementById('nickname');
    const closeDrawer = document.getElementById('closeDrawer');
    const submitOrder = document.getElementById('submitOrder');
    const clearCart = document.getElementById('clearCart');
    const cName = document.getElementById('cName');
    const cIngs = document.getElementById('cIngs');
    const addCustom = document.getElementById('addCustom');

    const qs = new URLSearchParams(location.search);
    const localYYYYMMDD = new Date().toLocaleDateString('sv-SE'); // æœ¬åœ° YYYY-MM-DD
    const ROOM = qs.get('r') || localYYYYMMDD;
    const ADMIN = qs.get('admin') === '1';
    let activeFilter = 'all';
    let MENU = [];
    let cart = JSON.parse(localStorage.getItem('yd_cart')||'{}');

    // â€”â€” å­åˆ†ç»„ï¼ˆçƒ­èœé¡µï¼‰ä¸ç‹¬ç«‹é¡µï¼ˆä¸»é£Ÿ/å‡‰æ‹Œèœï¼‰ â€”â€”
    const groupHotHot  = { key:'hot-hot',  title:'ğŸ”¥ çƒ­èœ',  filter: it => it.category === 'Main' && !(it.tags||[]).includes('Soup') };
    const groupHotVeg  = { key:'hot-veg',  title:'ğŸ¥¦ ç´ èœ',  filter: it => it.category === 'Veg' && !(it.tags||[]).includes('Cold') }; // ä¸å«å‡‰æ‹Œ
    const groupHotSoup = { key:'hot-soup', title:'ğŸ² æ±¤ç±»',  filter: it => (it.tags||[]).includes('Soup') };
    const groupStaple  = { key:'staple',   title:'ğŸš ä¸»é£Ÿ',  filter: it => it.category === 'Rice' };
    const groupCold    = { key:'cold',     title:'ğŸ¥’ å‡‰æ‹Œèœ', filter: it => (it.tags||[]).includes('Cold') };

    // é¡¶å±‚åˆ†ç±»å¯¹åº”çš„æ¸²æŸ“é¡ºåº
    function getRenderOrder(){
      if (activeFilter === 'Main') return [groupHotHot, groupHotVeg, groupHotSoup];
      if (activeFilter === 'Rice') return [groupStaple];
      if (activeFilter === 'Cold') return [groupCold];
      // å…¨éƒ¨ï¼šä¸åˆ†ç»„ï¼Œæ”¹ç”¨å¤§å›¾ä¸¤åˆ—
      return [];
    }

    // è¯¦ç»†åˆ†ç»„å¡ç‰‡ï¼ˆçƒ­èœ/ä¸»é£Ÿ/å‡‰æ‹Œï¼‰
    function renderSection(title, items, expanded = true){
      const sec = document.createElement('section');
      sec.className = 'section';
      sec.setAttribute('aria-expanded', expanded ? 'true' : 'false');

      const header = document.createElement('div'); header.className = 'section-header';
      const left = document.createElement('div'); left.className = 'section-title';
      left.innerHTML = `<span>${title}</span><span class="section-sub">å…± ${items.length} é“</span>`;
      const btn = document.createElement('button'); btn.type='button'; btn.className='section-toggle';
      btn.textContent = expanded ? 'æ”¶èµ·' : 'å±•å¼€';
      btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); const now=sec.getAttribute('aria-expanded')==='true'; sec.setAttribute('aria-expanded', now?'false':'true'); btn.textContent= now?'å±•å¼€':'æ”¶èµ·'; });
      header.addEventListener('click', ()=>btn.click());

      const grid = document.createElement('div'); grid.className = 'grid';
      items.forEach(item=>{
        const card = document.createElement('article'); card.className='card'; card.dataset.category=item.category;
        card.innerHTML = `
          <div class="imgbox">${mediaFor(item)}</div>
          <div class="content">
            <h3 class="name">${item.name_cn}${item.name_en ? ' Â· ' + item.name_en : ''}</h3>
            <p class="desc">${item.desc || ''}</p>
            <div class="tags">${(item.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
            <button class="add" data-item="${item.name_cn}">åŠ å…¥</button>
          </div>`;
        card.querySelector('.add').addEventListener('click', ()=>{ cart[item.name_cn]=(cart[item.name_cn]||0)+1; saveCart(); drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); });
        grid.appendChild(card);
      });
      header.append(left, btn); sec.append(header, grid); return sec;
    }

    // â€œå…¨éƒ¨â€é¡µçš„å¤§å›¾ä¸¤åˆ—å¡ç‰‡ï¼ˆåªæ˜¾ç¤ºä¸­æ–‡åï¼‰
    function renderAllSimple(items){
      const grid = document.createElement('div'); grid.className = 'grid-all';
      items.forEach(item=>{
        const card = document.createElement('article'); card.className='card-all'; card.dataset.category=item.category;
        card.innerHTML = `
          <div class="imgbox">${mediaFor(item)}</div>
          <div class="title-only">${item.name_cn}</div>`;
        // ç‚¹å‡»æ•´å¡åŠ å…¥è´­ç‰©è½¦
        card.addEventListener('click', ()=>{ cart[item.name_cn]=(cart[item.name_cn]||0)+1; saveCart(); });
        grid.appendChild(card);
      });
      return grid;
    }

    function renderMenu(){
      root.innerHTML = '';
      const q = (searchInput?.value || '').trim().toLowerCase();

      // é¡¶å±‚åˆ†ç±»é¢„è¿‡æ»¤
      const filtered = MENU.filter(it => {
        const matchTop =
          activeFilter === 'all' ||
          (activeFilter === 'Main' && (it.category === 'Main' || it.category === 'Veg' || (it.tags||[]).includes('Soup'))) ||
          (activeFilter === 'Rice' && it.category === 'Rice') ||
          (activeFilter === 'Cold' && (it.tags||[]).includes('Cold'));
        const hay = (it.name_cn + ' ' + (it.name_en||'') + ' ' + (it.tags||[]).join(' ')).toLowerCase();
        const matchText = !q || hay.includes(q);
        return matchTop && matchText;
      });

      // â€œå…¨éƒ¨â€â†’ ç›´æ¥å¤§å›¾ä¸¤åˆ—
      if (activeFilter === 'all') {
        root.appendChild(renderAllSimple(filtered));
        return;
      }

      // å…¶å®ƒé¡¶å±‚â†’ æŒ‰å®šä¹‰åˆ†ç»„æ¸²æŸ“
      getRenderOrder().forEach(g => {
        const items = filtered.filter(g.filter);
        if (!items.length) return;
        root.appendChild(renderSection(g.title, items, true));
      });
    }

    // è´­ç‰©è½¦
    function saveCart(){ localStorage.setItem('yd_cart', JSON.stringify(cart)); renderCart(); }
    function renderCart(){
      cartList.innerHTML = '';
      let totalQty = 0;
      Object.entries(cart).forEach(([name, qty])=>{
        totalQty += qty;
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<strong>${name}</strong><div></div>
          <div class='qty'><button data-op='-'>-</button><span>${qty}</span><button data-op='+'>+</button></div>`;
        row.querySelector('[data-op="-"]').onclick = ()=>{ cart[name]=Math.max(0,(cart[name]||0)-1); if(cart[name]===0) delete cart[name]; saveCart(); };
        row.querySelector('[data-op="+"]').onclick = ()=>{ cart[name]=(cart[name]||0)+1; saveCart(); };
        cartList.appendChild(row);
      });
      cartCount.textContent = `(${totalQty})`;
    }

    // é¡¶éƒ¨ç­›é€‰ & æœç´¢
    pills.forEach(btn => btn.addEventListener('click', () => {
      pills.forEach(b => b.setAttribute('aria-pressed','false'));
      btn.setAttribute('aria-pressed','true');
      activeFilter = btn.dataset.filter; renderMenu();
    }));
    searchInput?.addEventListener('input', renderMenu);

    // è´­ç‰©è½¦æŒ‰é’®
    cartBtn.onclick = ()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); };
    closeDrawer.onclick = ()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };
    clearCart.onclick = ()=>{ cart = {}; saveCart(); };
    renderCart();

    // è‡ªå®šä¹‰ç‚¹èœ
    addCustom.onclick = () => {
      const name = (cName.value || '').trim();
      const ings = (cIngs.value || '').trim();
      if (!name) { alert('è¯·å…ˆè¾“å…¥èœå'); cName.focus(); return; }
      const display = ings ? `è‡ªå®šä¹‰ Â· ${name}ï¼ˆ${ings}ï¼‰` : `è‡ªå®šä¹‰ Â· ${name}`;
      cart[display] = (cart[display] || 0) + 1;
      saveCart();
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
      cName.value = ''; cIngs.value = '';
    };

    // è½½å…¥èœå•
    fetch(`${BASE}/menu.json`, { cache: 'no-store' })
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(data => { MENU = data; renderMenu(); })
      .catch(err => { console.error('åŠ è½½èœå•å¤±è´¥ï¼š', err); alert('åŠ è½½èœå•å¤±è´¥ï¼šè¯·æ£€æŸ¥ menu.json è·¯å¾„'); });

    // Firestoreï¼ˆç®¡ç†å‘˜ä¸é€è¡Œè®¢é˜…ï¼Œå’Œä¸Šä¸€ç‰ˆä¸€è‡´ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyA45H7MVPejI-09EmX3Y9RP0G-BzxKUA0M",
      authDomain: "shenyeshitang-9a3c2.firebaseapp.com",
      projectId: "shenyeshitang-9a3c2",
      storageBucket: "shenyeshitang-9a3c2.firebasestorage.app",
      messagingSenderId: "293937999981",
      appId: "1:293937999981:web:364b69c1ea61b48e8acf64"
    };
    let db=null; let fbReady=false;
    (async () => {
      try{
        const appMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
        const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        const app = appMod.initializeApp(firebaseConfig);
        db = fsMod.getFirestore(app); fbReady = true;

        if (ADMIN) {
          const adminSection = document.getElementById('admin');
          adminSection.style.display = 'block';
          const headerEl = document.querySelector('header');
          document.body.insertBefore(adminSection, headerEl); // ç½®é¡¶
        }

        if(ADMIN){
          const showPendingOnly = document.getElementById('showPendingOnly');
          const markAllDoneBtn  = document.getElementById('markAllDone');
          document.getElementById('roomInfo').textContent = `æˆ¿é—´/æ—¥æœŸ: ${ROOM} Â· å°†é“¾æ¥åˆ†äº«ä¸º ?r=${ROOM}`;

          const { query, collection, where, onSnapshot, getDocs, updateDoc, doc } =
            await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');

          const qLines = query(collection(db, 'yd_order_lines'), where('room', '==', ROOM));

          onSnapshot(qLines, snap => {
            const tbody = document.getElementById('adminRows');
            tbody.innerHTML = '';
            const rows = [];
            snap.forEach(d => {
              const data = d.data();
              const ts = data.createdAt?.toMillis?.() ? data.createdAt.toMillis() : 0;
              rows.push({ id: d.id, data, ts });
            });
            rows.sort((a, b) => b.ts - a.ts);

            rows.forEach(({ id, data }) => {
              const isDone = data.status === 'done';
              if (showPendingOnly.checked && isDone) return;

              const when = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : '';
              const m = /^(.+?)ï¼ˆ(.+)ï¼‰$/.exec(data.name);
              const nameCell = m ? `${m[1]}<div style="font-size:12px;color:#c7cbe0">ğŸ§¾ ${m[2]}</div>` : data.name;

              const tr = document.createElement('tr');
              tr.style.opacity = isDone ? '0.55' : '1';
              tr.innerHTML = `
                <td style="border:1px solid #2a2a44;padding:8px 10px">${when}</td>
                <td style="border:1px solid #2a2a44;padding:8px 10px">${data.nick || '-'}</td>
                <td style="border:1px solid #2a2a44;padding:8px 10px">${nameCell}</td>
                <td style="border:1px solid #2a2a44;padding:8px 10px">${data.qty}</td>`;
              const tdOp = document.createElement('td'); tdOp.style.border='1px solid #2a2a44'; tdOp.style.padding='6px 8px';
              const btn = document.createElement('button'); btn.className = isDone ? 'muted' : 'primary'; btn.textContent = isDone ? 'æ’¤é”€' : 'å®Œæˆ';
              btn.onclick = async ()=>{ await updateDoc(doc(db,'yd_order_lines',id), { status: isDone?'pending':'done', doneAt: isDone?null:new Date() }); };
              tdOp.appendChild(btn); tr.appendChild(tdOp); tbody.appendChild(tr);
            });
          }, err => { console.error('å®æ—¶è®¢å•ç›‘å¬å¤±è´¥ï¼š', err); alert('å®æ—¶è®¢å•ç›‘å¬å¤±è´¥ï¼š'+err.message); });

          showPendingOnly.addEventListener('change', ()=>location.reload());
          markAllDoneBtn.onclick = async () => {
            if (!confirm('å°†å½“å‰æ˜¾ç¤ºçš„è®¢å•å…¨éƒ¨æ ‡è®°ä¸ºå®Œæˆï¼Ÿ')) return;
            const snap2 = await getDocs(qLines);
            const ops = [];
            snap2.forEach(d => {
              const data = d.data();
              if (showPendingOnly.checked && data.status === 'done') return;
              if (data.status !== 'done') ops.push(updateDoc(doc(db,'yd_order_lines', d.id), { status:'done', doneAt:new Date() }));
            });
            await Promise.all(ops);
            alert('å·²æ ‡è®°å®Œæˆ');
          };
        }
      }catch(e){ console.warn('Firebase åˆå§‹åŒ–å¤±è´¥ï¼š', e.message); }
    })();

    // æäº¤è®¢å•ï¼ˆå¤´æ¡£ + é€è¡Œï¼‰
    submitOrder.onclick = async () => {
      if(Object.keys(cart).length===0){ alert('è¯·å…ˆåŠ å…¥èœå“'); return; }
      if(!fbReady){ alert('Firebase æœªé…ç½®æˆ–ä¸å¯ç”¨ã€‚'); return; }
      const items = Object.entries(cart).map(([name, qty])=>({name, qty}));
      try{
        const { addDoc, collection, serverTimestamp } =
          await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');

        const headerRef = await addDoc(collection(db,'yd_orders'), {
          room: ROOM, nick: nickname.value.trim(), items,
          status: 'pending', doneAt: null, createdAt: serverTimestamp()
        });

        const linesCol = collection(db,'yd_order_lines');
        const ops = items.map(it => addDoc(linesCol, {
          room: ROOM, nick: nickname.value.trim(), orderId: headerRef.id,
          name: it.name, qty: it.qty, status: 'pending', doneAt: null, createdAt: serverTimestamp()
        }));
        await Promise.all(ops);

        cart = {}; saveCart(); drawer.classList.remove('open'); alert('å·²æäº¤ï¼');
      }catch(err){ alert('æäº¤å¤±è´¥ï¼š'+err.message); }
    };

    if('serviceWorker' in navigator){ navigator.serviceWorker.register(`${BASE}/sw.js`); }
  </script>
</body>
</html>