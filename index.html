<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="/shenyeshitang/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/shenyeshitang/icons/icon-192.png">
  <title>深夜食堂</title>

  <!-- 早期重定向：PWA + 记忆管理员 → 启动即进入 admin=1&r=家庭聚餐 -->
  <script>
  (function () {
    try {
      var ROOM_LOCK = '家庭聚餐';
      var params    = new URLSearchParams(location.search);

      if (params.get('admin') === '1') {
        localStorage.setItem('adminMode','1');
        localStorage.setItem('adminRoom', ROOM_LOCK);
        return;
      }
      var isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)
               || (navigator.standalone === true);
      var savedAdmin = localStorage.getItem('adminMode') === '1';
      if (isPWA && savedAdmin && !params.get('admin')) {
        var base = location.pathname.replace(/\/index\.html$/, '/');
        location.replace(base + '?admin=1&r=' + encodeURIComponent(ROOM_LOCK));
      }
    } catch(e) {}
  })();
  </script>

  <style>
    :root{
      --bg:#0c0c0f;--text:#e9e9f2;--brand:#7c5cff;--brand2:#3dd9b2;--accent:#ffd166;--muted:#98a0be;
      --safe:max(env(safe-area-inset-left),16px); --safeTop: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;font-family:ui-sans-serif,-apple-system,"PingFang SC","Microsoft YaHei",sans-serif;
      color:var(--text);
      background:radial-gradient(1200px 600px at 70% -10%,rgba(124,92,255,.15),transparent 60%),
                 radial-gradient(1000px 500px at 0% 100%,rgba(61,217,178,.12),transparent 60%),var(--bg)
    }
    /* 管理员模式：顶部安全距离 + 与下方间距 */
    body.admin-on{padding-top:calc(var(--safeTop) + 10px);}
    #admin{margin-bottom:14px;}
    body.admin-on #admin .toolbar{top:calc(8px + var(--safeTop));}
    body.admin-on header{margin-top:8px;}

    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(12,12,15,.9),rgba(12,12,15,.6) 70%,transparent);backdrop-filter:blur(8px)}
    .topbar{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:18px var(--safe) 10px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:900;font-size:24px}
    .logo::after{content:'🌙'}
    .title{font-size:clamp(22px,3.2vw,30px);font-weight:800}
    .search{display:flex;align-items:center;gap:8px;background:#0f0f15;border:1px solid #242438;color:var(--text);padding:10px 12px;border-radius:12px;min-width:min(260px,40vw)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;font-size:15px}

    /* 管理员切换按钮区域：默认不显示；admin 模式下显示“退出” */
    .admin-actions{display:none;gap:8px}
    body.admin-on .admin-actions{display:flex}
    #btnAdminOn{display:none}      /* 非 admin 完全不展示“管理员”按钮 */
    #btnAdminOff{display:none}
    body.admin-on #btnAdminOff{display:inline-block}
    .btn{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}

    .tabs{display:flex;gap:10px;overflow:auto;padding:8px var(--safe) 14px}
    .pill{border:1px solid #28283e;background:#13131b;color:var(--text);padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer}
    .pill[aria-pressed="true"]{background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(61,217,178,.2));border-color:var(--brand)}

    /* “全部”页：大图两列 */
    .grid-all{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;padding:0 16px 16px}
    @media(min-width:1024px){.grid-all{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card-all{display:grid;gap:8px;background:linear-gradient(180deg,#171a24,#12131a 40%);border:1px solid #2a2a44;border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .18s,border-color .18s}
    .card-all:hover{transform:translateY(-3px);border-color:#3b3f5b}
    .card-all .imgbox{aspect-ratio:4/3}
    .title-only{padding:0 10px 12px;font-weight:900;font-size:16px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* 骨架屏（仅全部页） */
    .thumb.loading{background:#222;opacity:0;animation:pulse 1.2s ease-in-out infinite}
    .thumb.loaded{opacity:1;animation:none;transition:opacity .4s}
    @keyframes pulse{0%{opacity:.4}50%{opacity:.9}100%{opacity:.4}}

    /* 详情分组（热菜/主食/凉拌菜） */
    .section{margin:18px var(--safe)}
    .section-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0 10px;padding:10px 12px;border:1px solid #2a2a44;border-radius:12px;background:linear-gradient(180deg,#12131a,#11121a);position:sticky;top:56px;z-index:5;backdrop-filter:blur(6px)}
    .section-title{display:flex;align-items:center;gap:10px;font-weight:900}
    .section-sub{color:#98a0be;font-size:12px}
    .section-toggle{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px}
    .card{display:grid;grid-template-columns:140px 1fr;background:linear-gradient(180deg,#171a24,#12131a 40%);border:1px solid #282b3f;border-radius:16px;overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.35);transition:transform .18s,border-color .18s}
    .card:hover{transform:translateY(-3px);border-color:#3b3f5b}
    .imgbox{position:relative;background:#0a0b10;aspect-ratio:4/3;overflow:hidden}
    .thumb{width:100%;height:100%;object-fit:cover}
    .content{padding:14px 14px 16px;display:grid;gap:8px}
    .name{font-size:18px;font-weight:900;margin:2px 0 0;color:#fff}
    .desc{font-size:13px;color:#98a0be;min-height:34px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{font-size:12px;color:#c7cbe0;border:1px dashed #2a2a44;padding:4px 8px;border-radius:999px}

    /* 购物车按钮 / 抽屉 */
    #cartBtn{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));background:linear-gradient(135deg,#7c5cff,#ffd166);color:#0b0b0e;border:0;border-radius:16px;padding:12px 16px;font-weight:900;box-shadow:0 14px 40px rgba(0,0,0,.45);z-index:40}
    #drawer{position:fixed;inset:auto 0 0 auto;right:0;width:min(420px,96vw);max-height:86vh;background:#0f0f16;border-top-left-radius:18px;border:1px solid #2a2a44;box-shadow:0 -20px 60px rgba(0,0,0,.6);transform:translateY(110%);transition:transform .25s;z-index:50}
    .drawer-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22243c}
    .drawer-ct{padding:12px 16px;max-height:60vh;overflow:auto}
    .drawer-ft{padding:14px 16px;border-top:1px solid #22243c;display:grid;gap:8px}
    .btn{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}

    footer{margin:28px 0 120px;text-align:center;color:#98a0be;font-size:12px}

    /* toast */
    #toast{position:fixed;top:14px;right:14px;z-index:60;display:grid;gap:8px}
    .toast{background:rgba(20,22,30,.95);border:1px solid #2a2a44;color:#e9e9f2;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.45);font-size:14px}
  </style>
</head>
<body>
  <!-- 管理员面板（admin=1 时置顶） -->
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>📟 实时订单</h3>
    <div class="toolbar">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
        <input id="showPendingOnly" type="checkbox" checked><span>只看未做</span>
      </label>
      <button id="markAllDone" class="btn">标记完成</button>
      <button id="enableNotify" class="btn" title="系统通知或声音提醒">开启提醒</button>
    </div>
    <div id="roomInfo" style="color:#c7cbe0;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #2a2a44">
      <thead><tr><th>时间</th><th>来源</th><th>菜品</th><th>数量</th><th>操作</th></tr></thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <header>
    <div class="topbar">
      <div class="brand"><div class="logo"></div><div class="title">深夜食堂</div></div>
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#8086a3" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="搜索菜名/标签…" />
      </div>
      <!-- 管理员切换：非 admin 完全隐藏（上面的 CSS 已控制） -->
      <div class="admin-actions">
        <button id="btnAdminOn"  class="btn">管理员</button>
        <button id="btnAdminOff" class="btn">退出</button>
      </div>
    </div>

    <div class="tabs">
      <button class="pill" data-filter="all" aria-pressed="true">全部</button>
      <button class="pill" data-filter="Main">热菜</button>
      <button class="pill" data-filter="Rice">主食</button>
      <button class="pill" data-filter="Cold">凉拌菜</button>
    </div>
  </header>

  <div id="toast" aria-live="polite"></div>
  <main id="menu-root"></main>

  <!-- 购物车 / 自定义 -->
  <button id="cartBtn">🛒 购物车 <small id="cartCount">(0)</small></button>
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-hd"><strong>🛒 购物车</strong><button class="btn" id="closeDrawer">关闭</button></div>
    <div class="drawer-ct" id="cartList"></div>
    <div class="drawer-ft">
      <input id="nickname" placeholder="备注 / 桌号 (选填)" class="btn" style="padding:10px;border-radius:10px;background:#161622" />
      <button class="btn" id="submitOrder" style="background:linear-gradient(135deg,#7c5cff,#ffd166);color:#0b0b0e">提交订单</button>
      <button class="btn" id="clearCart">清空</button>
    </div>
  </aside>

  <footer>© 2025 深夜食堂 · 安装到主屏幕后离线可用。</footer>

  <script>
    const BASE = '/shenyeshitang';
    const ROOM_LOCK = '家庭聚餐';                      // 🔒 全站默认房间（含非 admin）

    // 环境/记忆
    const qs     = new URLSearchParams(location.search);
    const isPWA  = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);
    const savedAdmin = localStorage.getItem('adminMode') === '1';

    // 是否管理员：URL admin=1 或（PWA + 已记忆）
    const ADMIN = qs.get('admin') === '1' || (isPWA && savedAdmin);

    // —— 关键：所有提交/订阅/显示均使用 ROOM_LOCK —— //
    const ROOM_EFFECTIVE = ROOM_LOCK;

    if (ADMIN) document.body.classList.add('admin-on');

    // DOM
    const root       = document.getElementById('menu-root');
    const pills      = document.querySelectorAll('.pill');
    const searchInput= document.getElementById('search');
    const cartBtn    = document.getElementById('cartBtn');
    const drawer     = document.getElementById('drawer');
    const cartList   = document.getElementById('cartList');
    const cartCount  = document.getElementById('cartCount');
    const closeDrawer= document.getElementById('closeDrawer');
    const submitOrder= document.getElementById('submitOrder');
    const clearCart  = document.getElementById('clearCart');
    let MENU = [];
    let cart; try { cart = JSON.parse(localStorage.getItem('yd_cart') || '{}'); } catch { cart = {}; }

    // Emoji 盘子 → <img>
    function iconSVG(emoji,label){
      const svg=encodeURIComponent(`<?xml version='1.0' encoding='UTF-8'?>
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#7c5cff'/><stop offset='100%' stop-color='#3dd9b2'/></linearGradient></defs>
  <rect width='220' height='220' rx='28' fill='url(#g)'/><circle cx='110' cy='118' r='72' fill='white'/><circle cx='110' cy='118' r='58' fill='#f4f4f4'/>
  <text x='110' y='124' font-size='72' text-anchor='middle' dominant-baseline='middle'>${emoji||'🍽️'}</text>
  <rect x='60' y='168' width='100' height='28' rx='14' fill='rgba(0,0,0,.45)'/><text x='110' y='184' font-size='14' text-anchor='middle' fill='white' font-weight='700'>${label}</text>
</svg>`); const img=new Image(); img.className='thumb loaded'; img.alt=label; img.src='data:image/svg+xml;utf8,'+svg; return img;
    }
    function resolveMediaElement(item){
      if(item.img){ const im=new Image(); im.className='thumb loading'; im.alt=item.name_cn; im.loading='lazy'; im.addEventListener('load',()=>{im.classList.remove('loading'); im.classList.add('loaded');}); im.src=item.img; return im; }
      return iconSVG(item.emoji,item.name_cn);
    }

    // 分组（热菜三分组 + 主食 + 凉拌）
    const groupHotHot  = { key:'hot-hot',  title:'🔥 热菜',  filter: it => it.category==='Main' && !(it.tags||[]).includes('Soup') };
    const groupHotVeg  = { key:'hot-veg',  title:'🥦 素菜',  filter: it => it.category==='Veg'  && !(it.tags||[]).includes('Cold') };
    const groupHotSoup = { key:'hot-soup', title:'🍲 汤类',  filter: it => (it.tags||[]).includes('Soup') };
    const groupStaple  = { key:'staple',   title:'🍚 主食',  filter: it => it.category==='Rice' };
    const groupCold    = { key:'cold',     title:'🥒 凉拌菜', filter: it => (it.tags||[]).includes('Cold') };

    function section(title,items,expanded=true){
      const sec=document.createElement('section'); sec.className='section'; sec.setAttribute('aria-expanded', expanded?'true':'false');
      const header=document.createElement('div'); header.className='section-header';
      const left=document.createElement('div'); left.className='section-title'; left.innerHTML=`<span>${title}</span><span class="section-sub">共 ${items.length} 道</span>`;
      const btn=document.createElement('button'); btn.type='button'; btn.className='section-toggle'; btn.textContent=expanded?'收起':'展开';
      btn.addEventListener('click',(ev)=>{ev.stopPropagation();const now=sec.getAttribute('aria-expanded')==='true';sec.setAttribute('aria-expanded',now?'false':'true');btn.textContent=now?'展开':'收起';});
      header.addEventListener('click',()=>btn.click());

      const grid=document.createElement('div'); grid.className='grid';
      items.forEach(item=>{
        const card=document.createElement('article'); card.className='card';
        const imgbox=document.createElement('div'); imgbox.className='imgbox'; imgbox.appendChild(resolveMediaElement(item));
        const content=document.createElement('div'); content.className='content';
        content.innerHTML=`<h3 class="name">${item.name_cn}${item.name_en?' · '+item.name_en:''}</h3>
          <p class="desc">${item.desc||''}</p>
          <div class="tags">${(item.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
          <button class="btn add" data-item="${item.name_cn}">加入</button>`;
        content.querySelector('.add').addEventListener('click',()=>{ cart[item.name_cn]=(cart[item.name_cn]||0)+1; saveCart(); drawer.style.transform='translateY(0)'; drawer.setAttribute('aria-hidden','false'); });
        card.append(imgbox,content); grid.appendChild(card);
      });
      header.append(left,btn); sec.append(header,grid); return sec;
    }

    function renderAllSimple(items){
      const grid=document.createElement('div'); grid.className='grid-all';
      items.forEach(item=>{
        const card=document.createElement('article'); card.className='card-all';
        const imgbox=document.createElement('div'); imgbox.className='imgbox'; imgbox.appendChild(resolveMediaElement(item));
        const title=document.createElement('div'); title.className='title-only'; title.textContent=item.name_cn;
        card.append(imgbox,title);
        card.addEventListener('click',()=>{ cart[item.name_cn]=(cart[item.name_cn]||0)+1; saveCart(); });
        grid.appendChild(card);
      });
      return grid;
    }

    let activeFilter='all';
    function renderMenu(){
      root.innerHTML='';
      const q=(searchInput?.value||'').trim().toLowerCase();
      const filtered=MENU.filter(it=>{
        const matchTop = activeFilter==='all'
          || (activeFilter==='Main' && (it.category==='Main'||it.category==='Veg'||(it.tags||[]).includes('Soup')))
          || (activeFilter==='Rice' && it.category==='Rice')
          || (activeFilter==='Cold' && (it.tags||[]).includes('Cold'));
      const hay=(it.name_cn+' '+(it.name_en||'')+' '+(it.tags||[]).join(' ')).toLowerCase();
      return matchTop && (!q || hay.includes(q));
      });
      if (activeFilter==='all'){ root.appendChild(renderAllSimple(filtered)); return; }
      const groups=[]; if(activeFilter==='Main'){groups.push(groupHotHot,groupHotVeg,groupHotSoup)}
      if(activeFilter==='Rice'){groups.push(groupStaple)}
      if(activeFilter==='Cold'){groups.push(groupCold)}
      groups.forEach(g=>{ const items=filtered.filter(g.filter); if(items.length) root.appendChild(section(g.title,items,true)); });
    }

    // 购物车
    function saveCart(){ localStorage.setItem('yd_cart', JSON.stringify(cart)); renderCart(); }
    function renderCart(){
      cartList.innerHTML=''; let total=0;
      Object.entries(cart).forEach(([name,qty])=>{
        total+=qty;
        const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='10px'; row.style.alignItems='center'; row.style.padding='10px 0'; row.style.borderBottom='1px dashed #2a2a44';
        row.innerHTML=`<strong>${name}</strong><div></div><div class='qty'><button class="btn" data-op='-'>-</button> <span>${qty}</span> <button class="btn" data-op='+'>+</button></div>`;
        row.querySelector("[data-op='-']").onclick=()=>{ cart[name]=Math.max(0,(cart[name]||0)-1); if(cart[name]===0) delete cart[name]; saveCart(); };
        row.querySelector("[data-op='+']").onclick=()=>{ cart[name]=(cart[name]||0)+1; saveCart(); };
        cartList.appendChild(row);
      });
      cartCount.textContent=`(${total})`;
    }

    // 顶部筛选/搜索/抽屉
    pills.forEach(btn=>btn.addEventListener('click',()=>{ pills.forEach(b=>b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); activeFilter=btn.dataset.filter; renderMenu(); }));
    searchInput?.addEventListener('input', renderMenu);
    cartBtn.onclick=()=>{ drawer.style.transform='translateY(0)'; drawer.setAttribute('aria-hidden','false'); };
    closeDrawer.onclick=()=>{ drawer.style.transform='translateY(110%)'; drawer.setAttribute('aria-hidden','true'); };
    document.getElementById('clearCart').onclick=()=>{ cart={}; saveCart(); };
    let cart; try { cart = JSON.parse(localStorage.getItem('yd_cart') || '{}'); } catch{ cart = {}; }
    renderCart();

    // 加载菜单
    fetch(`${BASE}/menu.json`,{cache:'no-store'}).then(r=>{if(!r.ok)throw new Error('HTTP '+r.status);return r.json();}).then(d=>{ MENU=d; renderMenu(); }).catch(e=>{ console.error('加载菜单失败：',e); alert('加载菜单失败：请检查 menu.json 路径'); });

    // ===== Firestore + 新单提醒（系统通知 or 降级） =====
    const firebaseConfig={ apiKey:"AIzaSyA45H7MVPejI-09EmX3Y9RP0G-BzxKUA0M", authDomain:"shenyeshitang-9a3c2.firebaseapp.com", projectId:"shenyeshitang-9a3c2", storageBucket:"shenyeshitang-9a3c2.firebasestorage.app", messagingSenderId:"293937999981", appId:"1:293937999981:web:364b69c1ea61b48e8acf64" };
    let db=null; let fbReady=false;

    const toastWrap=document.getElementById('toast');
    function showToast(msg){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; toastWrap.appendChild(el); setTimeout(()=>{el.style.opacity='0'; el.style.transition='opacity .4s';},2600); setTimeout(()=>{toastWrap.removeChild(el);},3000); }
    const ding=new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAgAAAASAAAAGZmZmZmZmZmZmY=");
    function softAlert(title,body){ try{ding.currentTime=0; ding.play().catch(()=>{});}catch{} if(navigator.vibrate){try{navigator.vibrate(120);}catch{}} showToast(`${title} · ${body}`); }
    async function requestNotify(){ if(!('Notification'in window)) return false; if(Notification.permission==='granted') return true; if(Notification.permission==='denied') return false; return (await Notification.requestPermission())==='granted'; }
    function systemNotify(title,body){ if(!('Notification'in window)||Notification.permission!=='granted') return false; new Notification(title,{body}); return true; }
    function alertNewLine(d){ const title=`新订单 · ${d.name} × ${d.qty}`; const body=`${d.nick||'-'} · 房间 ${ROOM_EFFECTIVE}`; if(!systemNotify(title,body)) softAlert(title,body); }

    (async ()=>{
      try{
        const appMod=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
        const fsMod =await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        const app=appMod.initializeApp(firebaseConfig);
        db=fsMod.getFirestore(app); fbReady=true;

        if (ADMIN) {
          document.body.classList.add('admin-on');
          const adminSection=document.getElementById('admin'); adminSection.style.display='block';
          const headerEl=document.querySelector('header'); document.body.insertBefore(adminSection, headerEl);

          const enableBtn=document.getElementById('enableNotify');
          const updateBtn=()=>{ if(!('Notification'in window)){ enableBtn.textContent='提醒已启用（声音/震动）'; return; } enableBtn.textContent=(Notification.permission==='granted')?'提醒已开启':'开启提醒'; };
          updateBtn(); enableBtn.onclick=async()=>{ await requestNotify(); updateBtn(); if(Notification.permission!=='granted') showToast('系统通知未授权，已用 声音/震动 提醒'); };

          const {query,collection,where,onSnapshot,getDocs,updateDoc,doc}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
          const qLines=query(collection(db,'yd_order_lines'), where('room','==',ROOM_EFFECTIVE));
          let firstLoad=true;

          onSnapshot(qLines, snap=>{
            const tbody=document.getElementById('adminRows'); tbody.innerHTML='';
            const rows=[]; snap.forEach(d=>{ const data=d.data(); const ts=data.createdAt?.toMillis?.()?data.createdAt.toMillis():0; rows.push({id:d.id,data,ts}); });
            rows.sort((a,b)=>b.ts-a.ts);
            rows.forEach(({id,data})=>{
              const isDone=data.status==='done'; if(document.getElementById('showPendingOnly').checked && isDone) return;
              const when=data.createdAt?.toDate? data.createdAt.toDate().toLocaleString(): '';
              const m=/^(.+?)（(.+)）$/.exec(data.name); const nameCell=m?`${m[1]}<div style="font-size:12px;color:#c7cbe0">🧾 ${m[2]}</div>`:data.name;
              const tr=document.createElement('tr'); tr.style.opacity=isDone?'0.55':'1';
              tr.innerHTML=`<td>${when}</td><td>${data.nick||'-'}</td><td>${nameCell}</td><td>${data.qty}</td>`;
              const tdOp=document.createElement('td'); const btn=document.createElement('button'); btn.className='btn'; btn.textContent=isDone?'撤销':'完成';
              btn.onclick=async()=>{ await updateDoc(doc(db,'yd_order_lines',id),{status:isDone?'pending':'done',doneAt:isDone?null:new Date()}); };
              tdOp.appendChild(btn); tr.appendChild(tdOp); tbody.appendChild(tr);
            });

            if(firstLoad){ firstLoad=false; return; }
            snap.docChanges().forEach(ch=>{ if(ch.type==='added'){ const d=ch.doc.data(); if(d.status!=='done') alertNewLine(d); } });
          }, err=>{ console.error('实时订单监听失败：',err); showToast('实时订单监听失败：'+err.message); });

          document.getElementById('showPendingOnly').addEventListener('change', ()=>location.reload());
          document.getElementById('markAllDone').onclick=async()=>{
            if(!confirm('将当前显示的订单全部标记为完成？')) return;
            const {query,collection,where,getDocs,updateDoc,doc}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
            const q2=query(collection(db,'yd_order_lines'), where('room','==',ROOM_EFFECTIVE));
            const snap2=await getDocs(q2); const ops=[];
            snap2.forEach(d=>{ const data=d.data(); if(document.getElementById('showPendingOnly').checked && data.status==='done') return;
              if(data.status!=='done') ops.push(updateDoc(doc(db,'yd_order_lines',d.id),{status:'done',doneAt:new Date()})); });
            await Promise.all(ops); showToast('已标记完成');
          };

          // 房间提示
          document.getElementById('roomInfo').textContent = `房间：${ROOM_EFFECTIVE}（固定）`;
        }
      }catch(e){ console.warn('Firebase 初始化失败：', e.message); }
    })();

    // 提交订单（所有用户/页面都写入“家庭聚餐”）
    submitOrder.onclick=async()=>{
      if(Object.keys(cart).length===0){ alert('请先加入菜品'); return; }
      if(!db){ alert('Firebase 未配置或不可用。'); return; }
      const items=Object.entries(cart).map(([name,qty])=>({name,qty}));
      try{
        const {addDoc,collection,serverTimestamp}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        const headerRef=await addDoc(collection(db,'yd_orders'),{room:ROOM_EFFECTIVE,nick:'',items,status:'pending',doneAt:null,createdAt:serverTimestamp()});
        await Promise.all(items.map(it=>addDoc(collection(db,'yd_order_lines'),{room:ROOM_EFFECTIVE,nick:'',orderId:headerRef.id,name:it.name,qty:it.qty,status:'pending',doneAt:null,createdAt:serverTimestamp()})));
        cart={}; saveCart(); drawer.style.transform='translateY(110%)'; showToast('已提交');
      }catch(err){ alert('提交失败：'+err.message); }
    };

    // 滤/搜
    pills.forEach(btn=>btn.addEventListener('click',()=>{ pills.forEach(b=>b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); activeFilter=btn.dataset.filter; renderMenu(); }));
    searchInput?.addEventListener('input', renderMenu);

    // 载入菜单后首次渲染
    let cart; try{cart=JSON.parse(localStorage.getItem('yd_cart')||'{}');}catch{cart={};}
    function renderCart(){
      cartList.innerHTML=''; let total=0;
      Object.entries(cart).forEach(([name,qty])=>{
        total+=qty;
        const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='10px'; row.style.alignItems='center'; row.style.padding='10px 0'; row.style.borderBottom='1px dashed #2a2a44';
        row.innerHTML=`<strong>${name}</strong><div></div><div class='qty'><button class="btn" data-op='-'>-</button> <span>${qty}</span> <button class="btn" data-op='+'>+</button></div>`;
        row.querySelector("[data-op='-']").onclick=()=>{ cart[name]=Math.max(0,(cart[name]||0)-1); if(cart[name]===0) delete cart[name]; saveCart(); };
        row.querySelector("[data-op='+']").onclick=()=>{ cart[name]=(cart[name]||0)+1; saveCart(); };
        cartList.appendChild(row);
      });
      cartCount.textContent=`(${total})`;
    }
    function saveCart(){ localStorage.setItem('yd_cart', JSON.stringify(cart)); renderCart(); }
    renderCart();
  </script>
</body>
</html>
