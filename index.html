<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <!-- GitHub Pages 子路径 -->
  <link rel="manifest" href="/shenyeshitang/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/shenyeshitang/icons/icon-192.png">
  <title>深夜食堂</title>
  <style>
    :root{ --bg:#0c0c0f;--panel:#121218;--muted:#8a8fa3;--text:#e9e9f2;--brand:#7c5cff;--brand2:#3dd9b2;--accent:#ffd166;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35);--safe:max(env(safe-area-inset-left),16px); }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif;letter-spacing:.2px;color:var(--text);background:
      radial-gradient(1200px 600px at 70% -10%, rgba(124,92,255,.15), transparent 60%),
      radial-gradient(1000px 500px at 0% 100%, rgba(61,217,178,.12), transparent 60%),var(--bg)}

    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(12,12,15,.9), rgba(12,12,15,.6) 70%, transparent);backdrop-filter:blur(8px)}
    .topbar{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;padding:18px var(--safe) 10px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;position:relative;box-shadow:var(--shadow);background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:900;font-size:24px}
    .logo::after{content:'🌙'}
    .title{font-size:clamp(22px,3.2vw,30px);font-weight:800}

    .search{display:flex;align-items:center;gap:8px;background:#0f0f15;border:1px solid #242438;color:var(--text);padding:10px 12px;border-radius:12px;min-width:min(360px,60vw)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;font-size:15px}

    .tabs{display:flex;gap:10px;overflow:auto;padding:8px var(--safe) 14px}
    .pill{border:1px solid #28283e;background:#13131b;color:var(--text);padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer;flex:0 0 auto}
    .pill[aria-pressed="true"]{background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(61,217,178,.2));border-color:var(--brand)}

    /* 卡片与图片 */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px}
    .card{
      display:grid; grid-template-columns:140px 1fr; gap:0;
      background:linear-gradient(180deg,#171a24,#12131a 40%);
      border:1px solid #282b3f; border-radius:16px; overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,.35); transition:transform .18s ease,border-color .18s;
    }
    .card:hover{ transform:translateY(-3px); border-color:#3b3f5b; }
    .imgbox{ position:relative; background:#0a0b10; aspect-ratio:4/3; overflow:hidden; }
    .thumb{ width:100%; height:100%; object-fit:cover; transform:scale(1.02); transition:transform .25s ease; }
    .card:hover .thumb{ transform:scale(1.05); }

    .content{ padding:14px 14px 16px; display:grid; align-content:start; gap:8px }
    .name{ font-size:18px; font-weight:900; margin:2px 0 0 }
    .desc{ font-size:13px; color:#98a0be; min-height:34px }
    .tags{ display:flex; flex-wrap:wrap; gap:8px }
    .tag{ font-size:12px; color:#c7cbe0; border:1px dashed #2d2d44; padding:4px 8px; border-radius:999px }
    .add{margin-top:2px;background:#1a1a28;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer;justify-self:start}
    .add:hover{border-color:var(--brand)}

    /* 分组标题 + 折叠 */
    .section{ margin:18px var(--safe); }
    .section-header{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin:6px 0 10px;padding:10px 12px;border:1px solid #2a2a44;
      border-radius:12px;background:linear-gradient(180deg,#12131a,#11121a);
      position:sticky;top:56px;z-index:5;backdrop-filter:blur(6px);
    }
    .section-title{display:flex;align-items:center;gap:10px;font-weight:900}
    .section-sub{color:#8a8fa3;font-size:12px}
    .section-toggle{
      background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:10px;
      padding:8px 10px;cursor:pointer
    }
    .section[aria-expanded="false"] .grid{ display:none }

    /* 管理员工具条 */
    #admin .toolbar{display:flex;gap:12px;align-items:center;margin:8px 0 10px;position:sticky;top:56px;z-index:5;background:rgba(12,12,15,.85);backdrop-filter:blur(6px);padding:6px 8px;border-radius:10px;border:1px solid #2a2a44}

    /* 购物车抽屉等 */
    #cartBtn{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));background:linear-gradient(135deg,var(--brand),var(--accent));color:#0b0b0e;border:0;border-radius:16px;padding:12px 16px;font-weight:900;box-shadow:0 14px 40px rgba(0,0,0,.45);z-index:40}
    #cartBtn small{opacity:.8}
    #drawer{position:fixed;inset:auto 0 0 auto;right:0;width:min(420px,96vw);max-height:86vh;background:#0f0f16;border-top-left-radius:18px;border:1px solid #2a2a44;box-shadow:0 -20px 60px rgba(0,0,0,.6);transform:translateY(110%);transition:transform .25s ease;z-index:50}
    #drawer.open{transform:translateY(0)}
    .drawer-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22243c}
    .drawer-ct{padding:12px 16px;max-height:60vh;overflow:auto}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:10px 0;border-bottom:1px dashed #2a2a44}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:28px;height:28px;border-radius:8px;background:#19192a;border:1px solid #2a2a44;color:#fff;cursor:pointer}
    .drawer-ft{padding:14px 16px;border-top:1px solid #22243c;display:grid;gap:8px}
    .primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:#0b0b0e;border:0;border-radius:12px;padding:12px;font-weight:900;cursor:pointer}
    .muted{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:12px;padding:10px;cursor:pointer}
    input.muted{background:#161622;border:1px solid #2a2a44;color:#fff}
    footer{margin:28px 0 120px;text-align:center;color:#98a0be;font-size:12px}
  </style>
</head>
<body>
  <!-- 管理员面板（admin=1 时顶部展示） -->
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>📟 实时订单</h3>
    <div class="toolbar">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
        <input id="showPendingOnly" type="checkbox" checked>
        <span>只看未做</span>
      </label>
      <button id="markAllDone" class="muted">将当前显示的全部标记为完成</button>
    </div>
    <div id="roomInfo" style="color:#c7cbe0;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #2a2a44">
      <thead>
        <tr>
          <th style="border:1px solid #2a2a44;padding:8px 10px">时间</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">来源</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">菜品</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">数量</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">操作</th>
        </tr>
      </thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="moon"></div>
        <div><div class="title">深夜食堂</div></div>
      </div>
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#8086a3" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="搜索菜名/标签…" aria-label="搜索菜单" />
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="分类筛选">
      <button class="pill" data-filter="all" aria-pressed="true">全部</button>
      <button class="pill" data-filter="Main">热菜</button>
      <button class="pill" data-filter="Rice">主食</button>
      <button class="pill" data-filter="Cold">凉拌菜</button>
    </div>
  </header>

  <!-- 分组渲染根节点 -->
  <main id="menu-root"></main>

  <!-- 购物车抽屉 -->
  <button id="cartBtn">🛒 购物车 <small id="cartCount">(0)</small></button>
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-hd">
      <strong>🛒 购物车</strong>
      <button class="muted" id="closeDrawer">关闭</button>
    </div>

    <!-- 自定义点菜 -->
    <div id="customDish" style="display:grid;gap:8px;margin:6px 16px 6px">
      <div style="font-weight:700;opacity:.9">✍️ 自定义点菜</div>
      <input id="cName" placeholder="菜名（必填）" class="muted" style="padding:10px;border-radius:10px">
      <input id="cIngs" placeholder="食材（可选，逗号分隔：如 牛肉, 洋葱 ）" class="muted" style="padding:10px;border-radius:10px">
      <button id="addCustom" class="primary">加入购物车（自定义）</button>
    </div>

    <div class="drawer-ct" id="cartList"></div>
    <div class="drawer-ft">
      <input id="nickname" placeholder="备注 / 桌号 (选填)" class="muted" style="padding:10px;border-radius:10px" />
      <button class="primary" id="submitOrder">提交订单</button>
      <button class="muted" id="clearCart">清空</button>
    </div>
  </aside>

  <footer>© 2025 深夜食堂 · 安装到主屏幕后离线可用。店主在链接后加 <code>?admin=1</code> 可查看实时订单。</footer>

  <script>
    const BASE = '/shenyeshitang';

    const iconSVG = (emoji, label) => {
      const svg = encodeURIComponent(`<?xml version='1.0' encoding='UTF-8'?>
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#7c5cff'/><stop offset='100%' stop-color='#3dd9b2'/></linearGradient></defs>
  <rect width='220' height='220' rx='28' fill='url(#g)'/>
  <circle cx='110' cy='118' r='72' fill='white'/><circle cx='110' cy='118' r='58' fill='#f4f4f4'/>
  <text x='110' y='124' font-size='72' text-anchor='middle' dominant-baseline='middle'>${emoji || '🍽️'}</text>
  <rect x='60' y='168' width='100' height='28' rx='14' fill='rgba(0,0,0,.45)'/>
  <text x='110' y='184' font-size='14' text-anchor='middle' fill='