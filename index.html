<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <!-- GitHub Pages 子路径 -->
  <link rel="manifest" href="/shenyeshitang/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/shenyeshitang/icons/icon-192.png">
  <title>深夜食堂</title>
  <style>
    :root{ --bg:#0c0c0f;--panel:#121218;--muted:#8a8fa3;--text:#e9e9f2;--brand:#7c5cff;--brand2:#3dd9b2;--accent:#ffd166;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35);--safe:max(env(safe-area-inset-left),16px); }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif;letter-spacing:.2px;color:var(--text);background:
      radial-gradient(1200px 600px at 70% -10%, rgba(124,92,255,.15), transparent 60%),
      radial-gradient(1000px 500px at 0% 100%, rgba(61,217,178,.12), transparent 60%),var(--bg)}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(12,12,15,.9), rgba(12,12,15,.6) 70%, transparent);backdrop-filter:blur(8px)}
    .topbar{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;padding:18px var(--safe) 10px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;position:relative;box-shadow:var(--shadow);background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:900;font-size:24px}
    .logo::after{content:'🌙'}
    .title{font-size:clamp(22px,3.2vw,30px);font-weight:800}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .search{display:flex;align-items:center;gap:8px;background:#0f0f15;border:1px solid #242438;color:var(--text);padding:10px 12px;border-radius:12px;min-width:min(360px,60vw)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;font-size:15px}
    .tabs{display:flex;gap:10px;overflow:auto;padding:8px var(--safe) 14px}
    .pill{border:1px solid #28283e;background:#13131b;color:var(--text);padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer;flex:0 0 auto}
    .pill[aria-pressed="true"]{background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(61,217,178,.2));border-color:var(--brand)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;padding:10px var(--safe) 96px}
    @media (min-width: 1024px){.grid{grid-template-columns:repeat(3,minmax(320px,1fr));}}
    .card{display:flex;gap:16px;align-items:stretch;background:linear-gradient(180deg,#161621,#12121a 30%);border:1px solid #24243a;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .imgbox{flex:0 0 160px;display:grid;place-items:center;background:#0a0a10;border-right:1px solid #23233a}
    .qsvg{width:140px;height:140px}
    .content{flex:1;padding:16px}
    .name{font-size:19px;font-weight:900;margin:0 0 6px}
    .desc{font-size:14px;color:#8a8fa3;min-height:36px;margin:0 0 8px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{font-size:12px;color:#c7cbe0;border:1px dashed #2d2d44;padding:4px 8px;border-radius:999px}
    .add{margin-top:10px;background:#1a1a28;color:#fff;border:1px solid #2a2a44;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;width:fit-content}
    #cartBtn{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));background:linear-gradient(135deg,var(--brand),var(--accent));color:#0b0b0e;border:0;border-radius:16px;padding:12px 16px;font-weight:900;box-shadow:0 14px 40px rgba(0,0,0,.45);z-index:40}
    #cartBtn small{opacity:.8}
    #drawer{position:fixed;inset:auto 0 0 auto;right:0;width:min(420px,96vw);max-height:86vh;background:#0f0f16;border-top-left-radius:18px;border:1px solid #2a2a44;box-shadow:0 -20px 60px rgba(0,0,0,.6);transform:translateY(110%);transition:transform .25s ease;z-index:50}
    #drawer.open{transform:translateY(0)}
    .drawer-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22243c}
    .drawer-ct{padding:12px 16px;max-height:60vh;overflow:auto}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:10px 0;border-bottom:1px dashed #2a2a44}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:28px;height:28px;border-radius:8px;background:#19192a;border:1px solid #2a2a44;color:#fff;cursor:pointer}
    .drawer-ft{padding:14px 16px;border-top:1px solid #22243c;display:grid;gap:8px}
    .primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:#0b0b0e;border:0;border-radius:12px;padding:12px;font-weight:900;cursor:pointer}
    .muted{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:12px;padding:10px;cursor:pointer}
    footer{margin:28px 0 120px;text-align:center;color:#98a0be;font-size:12px}
    input.muted{background:#161622;border:1px solid #2a2a44;color:#fff}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="moon"></div>
        <div>
          <div class="title">深夜食堂</div>
          <div class="subtitle">可安装到主屏幕 · 内置购物车 · 实时订单（JSON 菜单，离线可用）</div>
        </div>
      </div>
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#8086a3" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="搜索菜名/标签…" aria-label="搜索菜单" />
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="分类筛选">
      <button class="pill" data-filter="all" aria-pressed="true">全部</button>
      <button class="pill" data-filter="Main">主食/热菜</button>
      <button class="pill" data-filter="Rice">炒饭/饭类</button>
      <button class="pill" data-filter="Veg">素菜/凉菜/蘸酱</button>
    </div>
  </header>

  <main class="grid" id="menu-grid"></main>

  <!-- 购物车抽屉 -->
  <button id="cartBtn">🛒 购物车 <small id="cartCount">(0)</small></button>
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-hd">
      <strong>🛒 购物车</strong>
      <button class="muted" id="closeDrawer">关闭</button>
    </div>

    <!-- 自定义点菜：菜名必填，食材可选（逗号分隔） -->
    <div id="customDish" style="display:grid;gap:8px;margin:6px 16px 6px">
      <div style="font-weight:700;opacity:.9">✍️ 自定义点菜</div>
      <input id="cName" placeholder="菜名（必填）" class="muted" style="padding:10px;border-radius:10px">
      <input id="cIngs" placeholder="食材（可选，逗号分隔：如 牛肉, 洋葱 ）" class="muted" style="padding:10px;border-radius:10px">
      <button id="addCustom" class="primary">加入购物车（自定义）</button>
    </div>

    <div class="drawer-ct" id="cartList"></div>
    <div class="drawer-ft">
      <input id="nickname" placeholder="备注 / 桌号 (选填)" class="muted" style="padding:10px;border-radius:10px" />
      <button class="primary" id="submitOrder">提交订单</button>
      <button class="muted" id="clearCart">清空</button>
    </div>
  </aside>

  <!-- 管理员面板 -->
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>📟 实时订单</h3>
    <div style="display:flex;align-items:center;gap:12px;margin:8px 0 6px">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
        <input id="showPendingOnly" type="checkbox" checked>
        <span>只看未做</span>
      </label>
      <button id="markAllDone" class="muted">将当前显示的全部标记为完成</button>
    </div>
    <div id="roomInfo" style="color:#c7cbe0;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #2a2a44">
      <thead>
        <tr>
          <th style="border:1px solid #2a2a44;padding:8px 10px">时间</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">来源</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">菜品</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">数量</th>
          <th style="border:1px solid #2a2a44;padding:8px 10px">操作</th>
        </tr>
      </thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <footer>© 2025 深夜食堂 · 安装到主屏幕后离线可用。店主在链接后加 <code>?admin=1</code> 可查看实时订单。</footer>

  <script>
    const BASE = '/shenyeshitang';

    // Emoji 盘子图标（使用模板字符串 ${}）
    const iconSVG = (emoji, label) => {
      const svg = encodeURIComponent(`<?xml version='1.0' encoding='UTF-8'?>
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#7c5cff'/><stop offset='100%' stop-color='#3dd9b2'/></linearGradient></defs>
  <rect width='220' height='220' rx='28' fill='url(#g)'/>
  <circle cx='110' cy='118' r='72' fill='white'/><circle cx='110' cy='118' r='58' fill='#f4f4f4'/>
  <text x='110' y='124' font-size='72' text-anchor='middle' dominant-baseline='middle'>${emoji}</text>
  <rect x='60' y='168' width='100' height='28' rx='14' fill='rgba(0,0,0,.45)'/>
  <text x='110' y='184' font-size='14' text-anchor='middle' fill='white' font-weight='700'>${label}</text>
</svg>`);
      return `<img class="qsvg" alt="${label}" src="data:image/svg+xml;utf8,${svg}">`;
    };

    // 元素/状态
    const grid = document.getElementById('menu-grid');
    const pills = document.querySelectorAll('.pill');
    const search = document.getElementById('search');
    const cartBtn = document.getElementById('cartBtn');
    const drawer = document.getElementById('drawer');
    const cartList = document.getElementById('cartList');
    const cartCount = document.getElementById('cartCount');
    const nickname = document.getElementById('nickname');
    const closeDrawer = document.getElementById('closeDrawer');
    const submitOrder = document.getElementById('submitOrder');
    const clearCart = document.getElementById('clearCart');
    // 自定义点菜元素
    const cName = document.getElementById('cName');
    const cIngs = document.getElementById('cIngs');
    const addCustom = document.getElementById('addCustom');

    const qs = new URLSearchParams(location.search);
    const localYYYYMMDD = new Date().toLocaleDateString('sv-SE'); // 本地 YYYY-MM-DD
    const ROOM = qs.get('r') || localYYYYMMDD;
    const ADMIN = qs.get('admin') === '1';
    let activeFilter = 'all';
    let MENU = [];
    let cart = JSON.parse(localStorage.getItem('yd_cart')||'{}');

    function renderMenu(){
      grid.innerHTML = '';
      const q = (search?.value || '').trim().toLowerCase();
      MENU.forEach(item => {
        const catOk = activeFilter === 'all' || item.category === activeFilter;
        const textOk = !q || item.name_cn.toLowerCase().includes(q) || item.name_en.toLowerCase().includes(q) || (item.tags||[]).join(' ').toLowerCase().includes(q);
        if(!(catOk && textOk)) return;
        const card = document.createElement('article');
        card.className = 'card';
        card.dataset.category = item.category;
        card.innerHTML = `
          <div class="imgbox">${iconSVG(item.emoji, item.name_cn)}</div>
          <div class="content">
            <h3 class="name">${item.name_cn}${item.name_en ? ' · ' + item.name_en : ''}</h3>
            <p class="desc">${item.desc||''}</p>
            <div class="tags">${(item.tags||[]).map(t=>`<span class='tag'>${t}</span>`).join('')}</div>
            <button class="add" data-item="${item.name_cn}">加入</button>
          </div>`;
        card.querySelector('.add').addEventListener('click', () => { cart[item.name_cn]=(cart[item.name_cn]||0)+1; saveCart(); drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); });
        grid.appendChild(card);
      });
    }
    function saveCart(){ localStorage.setItem('yd_cart', JSON.stringify(cart)); renderCart(); }
    function renderCart(){
      cartList.innerHTML = '';
      let totalQty = 0;
      Object.entries(cart).forEach(([name, qty])=>{
        totalQty += qty;
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<strong>${name}</strong><div></div>
          <div class='qty'><button data-op='-'>-</button><span>${qty}</span><button data-op='+'>+</button></div>`;
        row.querySelector('[data-op="-"]').onclick = ()=>{ cart[name]=Math.max(0,(cart[name]||0)-1); if(cart[name]===0) delete cart[name]; saveCart(); };
        row.querySelector('[data-op="+"]').onclick = ()=>{ cart[name]=(cart[name]||0)+1; saveCart(); };
        cartList.appendChild(row);
      });
      cartCount.textContent = `(${totalQty})`;
    }
    pills.forEach(btn => btn.addEventListener('click', () => { pills.forEach(b => b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); activeFilter = btn.dataset.filter; renderMenu(); }));
    search?.addEventListener('input', renderMenu);
    cartBtn.onclick = ()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); };
    closeDrawer.onclick = ()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };
    clearCart.onclick = ()=>{ cart = {}; saveCart(); };
    renderCart();

    // 自定义点菜：加入购物车
    addCustom.onclick = () => {
      const name = (cName.value || '').trim();
      const ings = (cIngs.value || '').trim();
      if (!name) { alert('请先输入菜名'); cName.focus(); return; }
      const display = ings ? `自定义 · ${name}（${ings}）` : `自定义 · ${name}`;
      cart[display] = (cart[display] || 0) + 1;
      saveCart();
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
      cName.value = ''; cIngs.value = '';
    };

    // 加载菜单（绝对路径 + no-store 避免缓存）
    fetch(`${BASE}/menu.json`, { cache: 'no-store' })
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(data => { MENU = data; renderMenu(); })
      .catch(err => { document.querySelector('.subtitle').textContent = '加载菜单失败，请检查 menu.json 路径'; console.error('加载菜单失败：', err); });

    // ===== Firebase 配置（你提供的） =====
    const firebaseConfig = {
      apiKey: "AIzaSyA45H7MVPejI-09EmX3Y9RP0G-BzxKUA0M",
      authDomain: "shenyeshitang-9a3c2.firebaseapp.com",
      projectId: "shenyeshitang-9a3c2",
      storageBucket: "shenyeshitang-9a3c2.firebasestorage.app",
      messagingSenderId: "293937999981",
      appId: "1:293937999981:web:364b69c1ea61b48e8acf64"
    };

    let db=null; let fbReady=false;
    (async () => {
      try{
        const appMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
        const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        const app = appMod.initializeApp(firebaseConfig);
        db = fsMod.getFirestore(app); fbReady = true;

        // === 管理员：逐行订阅 yd_order_lines（前端排序 + 完成/撤销 + 批量完成） ===
        if(ADMIN){
          document.getElementById('admin').style.display='block';
          document.getElementById('roomInfo').textContent = `房间/日期: ${ROOM} · 将链接分享为 ?r=${ROOM}`;

          const showPendingOnly = document.getElementById('showPendingOnly');
          const markAllDoneBtn  = document.getElementById('markAllDone');

          const { query, collection, where, onSnapshot, getDocs, updateDoc, addDoc, serverTimestamp, doc } =
            await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');

          // 订阅逐行集合
          const qLines = query(collection(db, 'yd_order_lines'), where('room', '==', ROOM));

          onSnapshot(
            qLines,
            snap => {
              const tbody = document.getElementById('adminRows');
              tbody.innerHTML = '';

              const rows = [];
              snap.forEach(d => {
                const data = d.data();
                const ts = data.createdAt?.toMillis?.() ? data.createdAt.toMillis() : 0;
                rows.push({ id: d.id, data, ts });
              });
              rows.sort((a, b) => b.ts - a.ts);

              rows.forEach(({ id, data }) => {
                const isDone = data.status === 'done';
                if (showPendingOnly.checked && isDone) return;

                const when = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : '';
                const nameCell = (() => {
                  const m = /^(.+?)（(.+)）$/.exec(data.name); // 解析“（食材…）”
                  if (m) return `${m[1]}<div style="font-size:12px;color:#c7cbe0">🧾 ${m[2]}</div>`;
                  return data.name;
                })();

                const tr = document.createElement('tr');
                tr.style.opacity = isDone ? '0.55' : '1';
                tr.innerHTML = `
                  <td style="border:1px solid #2a2a44;padding:8px 10px">${when}</td>
                  <td style="border:1px solid #2a2a44;padding:8px 10px">${data.nick || '-'}</td>
                  <td style="border:1px solid #2a2a44;padding:8px 10px">${nameCell}</td>
                  <td style="border:1px solid #2a2a44;padding:8px 10px">${data.qty}</td>`;

                const tdOp = document.createElement('td');
                tdOp.style.border = '1px solid #2a2a44';
                tdOp.style.padding = '6px 8px';
                const btn = document.createElement('button');
                btn.className = isDone ? 'muted' : 'primary';
                btn.textContent = isDone ? '撤销' : '完成';
                btn.onclick = async () => {
                  await updateDoc(doc(db, 'yd_order_lines', id), {
                    status: isDone ? 'pending' : 'done',
                    doneAt: isDone ? null : new Date()
                  });
                };
                tdOp.appendChild(btn);
                tr.appendChild(tdOp);
                tbody.appendChild(tr);
              });
            },
            err => { console.error('实时订单监听失败：', err); alert('实时订单监听失败：'+err.message); }
          );

          showPendingOnly.addEventListener('change', ()=>location.reload());

          markAllDoneBtn.onclick = async () => {
            if (!confirm('将当前显示的订单全部标记为完成？')) return;
            const q2 = query(collection(db,'yd_order_lines'), where('room','==',ROOM));
            const snap2 = await getDocs(q2);
            const ops = [];
            snap2.forEach(d => {
              const data = d.data();
              if (showPendingOnly.checked && data.status === 'done') return;
              if (data.status !== 'done') ops.push(updateDoc(doc(db,'yd_order_lines', d.id), { status:'done', doneAt:new Date() }));
            });
            await Promise.all(ops);
            alert('已标记完成');
          };
        }
      }catch(e){ console.warn('Firebase 初始化失败：', e.message); }
    })();

    // 提交订单（头档 + 逐行；不区分 qty 的部分完成）
    submitOrder.onclick = async () => {
      if(Object.keys(cart).length===0){ alert('请先加入菜品'); return; }
      if(!fbReady){ alert('Firebase 未配置或不可用。'); return; }

      const items = Object.entries(cart).map(([name, qty])=>({name, qty}));

      try{
        const { addDoc, collection, serverTimestamp } =
          await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');

        // 1) 头档（保留历史/汇总）
        const headerRef = await addDoc(collection(db,'yd_orders'), {
          room: ROOM, nick: nickname.value.trim(), items,
          status: 'pending', doneAt: null, createdAt: serverTimestamp()
        });

        // 2) 逐行（真正用于“逐道完成/撤销”）
        const linesCol = collection(db,'yd_order_lines');
        const ops = [];
        for (const it of items) {
          ops.push(addDoc(linesCol, {
            room: ROOM,
            nick: nickname.value.trim(),
            orderId: headerRef.id,
            name: it.name,
            qty: it.qty,               // 不做部分完成，整行完成/撤销
            status: 'pending',
            doneAt: null,
            createdAt: serverTimestamp()
          }));
        }
        await Promise.all(ops);

        cart = {}; saveCart(); drawer.classList.remove('open'); alert('已提交！');
      }catch(err){ alert('提交失败：'+err.message); }
    };

    // 注册 Service Worker（绝对路径）
    if('serviceWorker' in navigator){ navigator.serviceWorker.register(`${BASE}/sw.js`); }
  </script>
</body>
</html>
