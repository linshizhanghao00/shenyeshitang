<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- 默认用户 manifest；运行时按管理员切换 -->
  <link id="manifestLink" rel="manifest" href="/shenyeshitang/manifest.webmanifest?iv=v7">
  <link rel="apple-touch-icon" sizes="180x180" href="/shenyeshitang/icons/moon-180.png?v=99">
  <title>深夜食堂</title>

  <!-- 全局：房间 & 版本（用于 PWA 强制刷新） -->
  <script>
    window.ROOM_LOCK = '家庭聚餐';
    window.__APP_VERSION__ = 'v3';
  </script>

  <!-- 管理员记忆 + iOS A2HS 丢 query 兜底 + manifest 切换 -->
  <script>
  (function () {
    try {
      var p = new URLSearchParams(location.search);
      var isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);
      var savedAdmin = localStorage.getItem('adminMode') === '1';

      if (p.get('admin') === '1' || savedAdmin) {
        localStorage.setItem('adminMode','1');
        localStorage.setItem('adminRoom', window.ROOM_LOCK);
        var link = document.getElementById('manifestLink');
        if (link) link.setAttribute('href','/shenyeshitang/manifest.admin.webmanifest?v='+(window.__APP_VERSION__||''));
      } else {
        if (isPWA && savedAdmin) {
          var base = location.pathname.replace(/\/index\.html$/, '/');
          location.replace(base + '?admin=1&r=' + encodeURIComponent(window.ROOM_LOCK) + '&v=' + (window.__APP_VERSION__||''));
          return;
        }
      }
    } catch(e) {}
  })();
  </script>

  <style>
    :root{
      --bg:#0c0c0f;--panel:#121218;--text:#e9e9f2;--muted:#98a0be;
      --brand:#7c5cff;--brand2:#3dd9b2;--accent:#ffd166;
      --safe:max(env(safe-area-inset-left),16px);--safeTop:env(safe-area-inset-top,0px)
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;font-family:ui-sans-serif,-apple-system,"PingFang SC","Microsoft YaHei",sans-serif;letter-spacing:.2px;color:var(--text);
      background:radial-gradient(1200px 600px at 70% -10%,rgba(124,92,255,.15),transparent 60%),
                 radial-gradient(1000px 500px at 0% 100%,rgba(61,217,178,.12),transparent 60%),var(--bg)
    }
    body.pwa-on header{ padding-top: calc(var(--safeTop) + 10px); }
    body.admin-on header{ padding-top: calc(var(--safeTop) + 22px); }
    body.pwa-on.admin-on header{ padding-top: calc(var(--safeTop) + 26px); }

    header{position:sticky;top:0;z-index:20;background:rgba(12,12,15,.85);backdrop-filter:blur(8px)}
    .topbar{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:18px var(--safe) 10px}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-size:24px}
    .logo::after{content:none !important;}
    .title{font-size:26px;font-weight:800}

    .search{display:flex;align-items:center;gap:8px;background:#0f0f15;border:1px solid #242438;color:var(--text);padding:10px 12px;border-radius:12px;min-width:min(260px,40vw)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;font-size:15px}

    .adminToggle{display:none}
    body.pwa-on .adminToggle{display:inline-flex}
    .adminToggle .btn{background:#1a1b26;border:1px solid #2a2a44;color:#e9e9f2;padding:10px 12px;border-radius:12px;cursor:pointer;font-size:14px}

    .tabs{display:flex;gap:10px;overflow:auto;padding:8px var(--safe) 14px}
    .pill{border:1px solid #28283e;background:#13131b;color:var(--text);padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer}
    .pill[aria-pressed="true"]{background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(61,217,178,.2));border-color:var(--brand)}

    /* 分组卡片（默认展开，可折叠） */
    .section{margin:18px var(--safe)}
    .section-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0 10px;padding:10px 12px;border:1px solid #2a2a44;border-radius:12px;background:linear-gradient(180deg,#12131a,#11121a);position:sticky;top:56px;z-index:5;backdrop-filter:blur(6px)}
    .section-title{display:flex;gap:10px;align-items:center;font-weight:900}
    .section-sub{color:#98a0be;font-size:12px}
    .section-toggle{background:#161622;border:1px solid #2a2a44;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px}
    .card{display:grid;grid-template-columns:140px 1fr;background:linear-gradient(180deg,#171a24,#12131a 40%);border:1px solid #282b3f;border-radius:16px;overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .imgbox.small{aspect-ratio:4/3;background:#0a0b10}
    .imgbox.small > img.thumb{width:100%;height:100%;object-fit:cover;display:block}
    .content{padding:14px 14px 16px;display:grid;gap:8px}
    .name{font-size:18px;font-weight:900;margin:2px 0 0;color:#fff}
    .desc{font-size:13px;color:#98a0be;min-height:34px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{font-size:12px;color:#c7cbe0;border:1px dashed #2a2a44;padding:4px 8px;border-radius:999px}
    .add{margin-top:2px;background:#1a1a28;border:1px solid #2a2a44;color:#fff;border-radius:10px;cursor:pointer;justify-self:start}

    /* “全部”网格 */
    .grid-all{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;padding:16px}
    @media(min-width:1024px){.grid-all{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card-all{display:grid;gap:8px;background:linear-gradient(180deg,#171a24,#12131a 40%);border:1px solid #2a2a44;border-radius:16px;overflow:hidden;cursor:pointer}
    .imgbox{aspect-ratio:4/3;display:block;background:#0a0a10}
    .imgbox > img.thumb{width:100%;height:100%;object-fit:cover;display:block}
    .title-only{padding:0 10px 12px;font-weight:900;font-size:16px;color:#fff;text-align:center}

    /* 购物车与输入 UI 修复 */
    #cartBtn{
      position:fixed;right:16px;
      /* PATCH: 固定 16px + 安全区，不用 vh，避免键盘/视口变化导致上移 */
      bottom: calc(16px + env(safe-area-inset-bottom, 0px)) !important;
      background:linear-gradient(135deg,#7c5cff,#ffd166);color:#0b0b0e;border:0;border-radius:16px;padding:14px 18px;font-weight:900;box-shadow:0 14px 40px rgba(0,0,0,.45);z-index:40;font-size:16px
    }

    /* PATCH: 统一唯一的 #drawer 规则（贴底，默认收起） */
    #drawer{
      position: fixed !important;
      left: 0; right: 0; bottom: 0; top: auto;
      width: 100% !important;
      max-height: 92vh !important;
      margin: 0 !important;

      border-top-left-radius: 18px !important;
      border-top-right-radius: 18px !important;
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;

      transform: translateY(110%) translateZ(0); /* 默认收起；JS 改为 0 展开 */
      transition: transform .25s ease;
      z-index: 50;
      overscroll-behavior: contain;

      /* 保留你的外观 */
      display: flex !important;
      flex-direction: column !important;
      background:#fbf6ee !important;
      border:2px solid #cfc5b3 !important;
      box-shadow:0 -4px 12px rgba(0,0,0,.10) !important;
      color:#4a463f !important;
    }

    .drawer-ct{padding:12px 16px;max-height:60vh;overflow:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
    .drawer-ft{position:sticky;bottom:0;background:inherit;padding-bottom:calc(14px + env(safe-area-inset-bottom, 0px)) !important}
    .drawer-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22243c}

    .drawer-ft .btn{font-size:16px;padding:12px 14px;border-radius:12px}
    #submitOrder{font-size:20px;padding:20px 18px;min-height:72px;border-radius:14px}
    .drawer-ft input.btn,.drawer-ft input.btn:focus{color:#fff !important;background:#161622 !important;border:1px solid #2a2a44 !important}
    .btn{background:#1a1b26;border:1px solid #2a2a44;color:#e9e9f2;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:active{transform:scale(.98)}
    #clearCart{font-size:18px;padding:14px 16px;border-radius:12px}
    .qty .btn{font-size:20px;line-height:1;padding:10px 14px;min-width:44px}
    #cartList .row-name{font-size:18px;font-weight:800}
    #cartList .row-qty{font-size:18px;font-weight:800}

    footer{margin:28px 0 120px;text-align:center;color:#98a0be;font-size:12px}
    #toast{position:fixed;top:14px;right:14px;z-index:60;display:grid;gap:8px}
    .toast{background:rgba(20,22,30,.95);border:1px solid #2a2a44;color:#e9e9f2;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.45);font-size:14px}

    /* 顶部占位，避免刘海遮挡（你原样保留） */
    body.admin-on::before{content:"";display:block;height:calc(env(safe-area-inset-top,0px)+22px)}
    body.pwa-on.admin-on::before{content:"";display:block;height:calc(env(safe-area-inset-top,0px)+26px)}
    body.pwa-on:not(.admin-on)::before{content:"";display:block;height:calc(env(safe-area-inset-top,0px)+10px)}

    /* 危险按钮样式（清空数据） */
    .btn.danger{ background:#2b1214; border-color:#5e1a1f; color:#ffb7bf; }
    .btn.danger:hover{ border-color:#e74856; color:#ffdbe0; }

    /* 兜底：管理员区本身再加安全区顶部留白（你原样保留） */
    body.admin-on #admin{ padding-top: calc(env(safe-area-inset-top, 0px) + 22px) !important; }
    body.pwa-on.admin-on #admin{ padding-top: calc(env(safe-area-inset-top, 0px) + 26px) !important; }
    #admin > *:first-child{ margin-top: 0 !important; }

    /* 以下为你原有的 Light Sage 主题与其它样式（未改动） ... */
    /* —— 省略：你下方的主题色、pill、card 等原样保留 —— */

    /* 购物车输入区提升体验（你原样保留） */
    #drawer .drawer-hd, #drawer .drawer-ft{ touch-action:none; -webkit-user-select:none; user-select:none; }

    /* 页底留白（你原样保留） */
    main { padding-bottom: calc(max(60px, 8vh) + env(safe-area-inset-bottom, 0px)) !important; }
    footer { margin-bottom: calc(max(80px, 10vh) + env(safe-area-inset-bottom, 0px)) !important; }

  </style>
</head>
<body>
  <!-- 管理员面板 -->
  <section id="admin" style="display:none;padding:14px var(--safe)">
    <h3>📟 实时订单</h3>
    <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 10px">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input id="showPendingOnly" type="checkbox" checked><span>只看未做</span></label>
      <button id="markAllDone" class="btn">标记完成</button>
      <button id="enableNotify" class="btn">开启提醒</button>
      <button id="purgeAll" class="btn danger" style="display:none">🗑️ 清空本房间订单</button>
    </div>
    <div id="roomInfo" style="color:#c7cbe0;margin:8px 0"></div>
    <table style="width:100%;border-collapse:collapse;border:1px solid #2a2a44">
      <thead><tr><th>时间</th><th>来源</th><th>菜品</th><th>数量</th><th>操作</th></tr></thead>
      <tbody id="adminRows"></tbody>
    </table>
  </section>

  <header>
    <div class="topbar">
      <div class="brand"><div class="logo"></div><div class="title">深夜<br>食堂</div></div>
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#8086a3" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="搜索菜名/标签…" />
      </div>
      <div class="adminToggle"><button id="toggleAdmin" class="btn">👨‍🍳 厨房屏</button></div>
    </div>

    <div class="tabs">
      <button class="pill" data-filter="all" aria-pressed="true">全部</button>
      <button class="pill" data-filter="Main">热菜</button>
      <button class="pill" data-filter="Rice">主食</button>
      <button class="pill" data-filter="Cold">凉拌菜</button>
    </div>
  </header>

  <div id="toast" aria-live="polite"></div>
  <main id="menu-root"></main>

  <!-- 购物车按钮（右下角） -->
  <button id="cartBtn">🛒 购物车 <small id="cartCount">(0)</small></button>

  <!-- 购物车抽屉 -->
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-hd"><strong>🛒 购物车</strong><button class="btn" id="closeDrawer">关闭</button></div>
    <div class="drawer-ct" id="cartList"></div>
    <div class="drawer-ft">
      <button id="clearCart" class="btn ghost">清空</button>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div style="font-weight:700;opacity:.9">✍️ 自定义点菜</div>
        <input id="cName" placeholder="菜名（必填）" class="btn">
        <input id="cIngs" placeholder="食材（可选，逗号分隔）" class="btn">
        <button id="addCustom" class="btn">加入购物车（自定义）</button>
      </div>
      <button class="btn" id="submitOrder" style="background:linear-gradient(135deg,#7c5cff,#ffd166);color:#0b0b0e">提交订单</button>
    </div>
  </aside>

  <footer>© 2025 深夜食堂 · 安装到主屏幕后离线可用。</footer>

  <script>
    /* 菜单 JSON（统一线上路径） */
    var MENU_URL = 'https://linshizhanghao00.github.io/shenyeshitang/menu.json';

    /* 状态判定 */
    var qs = new URLSearchParams(location.search);
    var isPWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);
    var savedAdmin = localStorage.getItem('adminMode')==='1';
    var ADMIN = (qs.get('admin')==='1') || savedAdmin;
    if (ADMIN) document.body.classList.add('admin-on');
    if (isPWA) document.body.classList.add('pwa-on');

    /* DOM */
    var root=document.getElementById('menu-root');
    var pills=document.querySelectorAll('.pill');
    var searchInput=document.getElementById('search');
    var cartBtn=document.getElementById('cartBtn');
    var drawer=document.getElementById('drawer');
    var cartList=document.getElementById('cartList');
    // 抽屉默认收起
    drawer.style.transform='translateY(110%)';
    drawer.setAttribute('aria-hidden','true');
    var cartCount=document.getElementById('cartCount');
    var closeDrawer=document.getElementById('closeDrawer');
    var submitOrder=document.getElementById('submitOrder');
    var clearCart=document.getElementById('clearCart');
    var nickname=document.getElementById('nickname');
    var cName=document.getElementById('cName');
    var cIngs=document.getElementById('cIngs');
    var addCustom=document.getElementById('addCustom');
    var toggleAdmin=document.getElementById('toggleAdmin');

    /* PWA 一键切换管理员/用户 */
    if (toggleAdmin) {
      function refreshAdminButton(){ toggleAdmin.textContent = ADMIN ? '🛎 返回点单' : '👨‍🍳 厨房屏'; }
      refreshAdminButton();
      toggleAdmin.onclick = function(){
        var base = location.pathname.replace(/\/index\.html$/, '/');
        if (ADMIN) {
          localStorage.removeItem('adminMode');
          location.href = base + '?v=' + (window.__APP_VERSION__||'');
        } else {
          localStorage.setItem('adminMode','1');
          location.href = base + '?admin=1&r=' + encodeURIComponent(window.ROOM_LOCK) + '&v=' + (window.__APP_VERSION__||'');
        }
      };
    }

    /* SVG 占位图（保留） */
function iconSVG(e, label){
  var svg = encodeURIComponent(
    "<?xml version='1.0'?>"
   +"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 220'>"
   +"<rect width='220' height='220' fill='none'/>"
   +"<text x='110' y='115' font-size='96' text-anchor='middle'>"+(e||'🍽️')+"</text>"
   +"</svg>"
  );
  var im = new Image();
  im.className = 'thumb loaded';
  im.alt = label;
  im.src = 'data:image/svg+xml;utf8,' + svg;
  return im;
}
    function mediaFor(item){ return iconSVG(item.emoji,item.name_cn); }

    /* ============== 分类 / 分组渲染（按你的“逻辑改进摘要”） ============== */
    var MENU=[];
    function groupSection(title, items){
      var sec=document.createElement('section'); sec.className='section'; sec.setAttribute('aria-expanded','true');
      var header=document.createElement('div'); header.className='section-header';
      header.innerHTML="<div class='section-title'><span>"+title+"</span><span class='section-sub'>共 "+items.length+" 道</span></div>";
      var btn=document.createElement('button'); btn.className='section-toggle'; btn.textContent='收起';
      header.appendChild(btn);
      function toggle(){ var open = sec.getAttribute('aria-expanded') !== 'false'; sec.setAttribute('aria-expanded', open ? 'false' : 'true'); btn.textContent = open ? '展开' : '收起'; }
      btn.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
      header.addEventListener('click', function(e){ if (e.target === btn) return; toggle(); });

      var grid=document.createElement('div'); grid.className='grid';
      items.forEach(function(it){
        var card=document.createElement('article'); card.className='card';
        var imgbox=document.createElement('div'); imgbox.className='imgbox small'; imgbox.appendChild(mediaFor(it));
        var content=document.createElement('div'); content.className='content';
        content.innerHTML="<h3 class='name'>"+it.name_cn+(it.name_en?' · '+it.name_en:'')+"</h3>"
          +"<p class='desc'>"+(it.desc||'')+"</p>"
          +"<div class='tags'>"+((it.tags||[]).map(function(t){return '<span class=\"tag\">'+t+'</span>';}).join(''))+"</div>"
          +"<button class='add' data-item='"+it.name_cn+"'>加入</button>";
        content.querySelector('.add').onclick=function(){ cart[it.name_cn]=(cart[it.name_cn]||0)+1; saveCart(); };
        card.appendChild(imgbox); card.appendChild(content); grid.appendChild(card);
      });
      sec.appendChild(header); sec.appendChild(grid); return sec;
    }

    function gridAll(items){
      var grid=document.createElement('div'); grid.className='grid-all';
      var q=(searchInput.value||'').trim().toLowerCase();
      items.filter(function(it){
        var hay=(it.name_cn+' '+(it.name_en||'')+' '+(it.category||'')+' '+(it.tags||[]).join(' ')).toLowerCase();
        return !q || hay.includes(q);
      }).forEach(function(it){
        var card=document.createElement('article'); card.className='card-all';
        var imgbox=document.createElement('div'); imgbox.className='imgbox'; imgbox.appendChild(mediaFor(it));
        var t=document.createElement('div'); t.className='title-only'; t.textContent=it.name_cn;
        card.appendChild(imgbox); card.appendChild(t);
        card.onclick=function(){ cart[it.name_cn]=(cart[it.name_cn]||0)+1; saveCart(); };
        grid.appendChild(card);
      });
      return grid;
    }

    function renderMenu(){
      root.innerHTML='';
      var q=(searchInput.value||'').trim().toLowerCase();
      function matchQ(it){
        var hay=(it.name_cn+' '+(it.name_en||'')+' '+(it.category||'')+' '+(it.tags||[]).join(' ')).toLowerCase();
        return !q || hay.includes(q);
      }
      function hasTag(it, tag){ return (it.tags||[]).indexOf(tag)>-1; }
      function nameHas(it, kwCN){ return (it.name_cn||'').indexOf(kwCN)>-1; }

      var activeEl=document.querySelector('.pill[aria-pressed="true"]');
      var active = activeEl ? activeEl.dataset.filter : 'all';

      if (active === 'all') { root.appendChild(gridAll(MENU)); return; }

      if (active === 'Main') {
        var soup = MENU.filter(function(it){ return matchQ(it) && hasTag(it,'Soup'); });
        var veg  = MENU.filter(function(it){ return matchQ(it) && it.category==='Veg'  && !hasTag(it,'Cold'); });
        var meat = MENU.filter(function(it){ return matchQ(it) && it.category==='Main' && !hasTag(it,'Soup'); });

        if (meat.length) root.appendChild(groupSection('🥩 肉菜', meat));
        if (veg.length)  root.appendChild(groupSection('🥦 素菜', veg));
        if (soup.length) root.appendChild(groupSection('🍲 汤类', soup));
        return;
      }

      if (active === 'Rice') {
        var rice   = MENU.filter(function(it){ return matchQ(it) && it.category==='Rice' && nameHas(it,'饭'); });
        var noodle = MENU.filter(function(it){ return matchQ(it) && it.category==='Rice' && nameHas它,'面'); });
        var pastry = MENU.filter(function(it){ return matchQ(it) && it.category==='Rice' && !nameHas(it,'饭') && !nameHas(it,'面'); });

        if (rice.length)   root.appendChild(groupSection('🍚 饭', rice));
        if (noodle长度) root.appendChild(groupSection('🍜 面', noodle));
        if (pastry长度) root.appendChild(groupSection('🥟 面食', pastry));
        return;
      }

      if (active === 'Cold') {
        var cold = MENU.filter(function(it){ return matchQ(it) && hasTag(it,'Cold'); });
        if (cold.length) root.appendChild(groupSection('🥒 凉拌菜', cold));
        return;
      }
    }

    pills.forEach(function(btn){
      btn.addEventListener('click', function(){
        pills.forEach(function(b){ b.setAttribute('aria-pressed','false'); });
        btn.setAttribute('aria-pressed','true');
        renderMenu();
      });
    });
    searchInput.addEventListener('input', renderMenu);

    /* 购物车 */
    var cart; try { cart = JSON.parse(localStorage.getItem('yd_cart') || '{}'); } catch { cart = {}; }
    function saveCart(){ localStorage.setItem('yd_cart', JSON.stringify(cart)); renderCart(); }
    function renderCart(){
      var list=document.getElementById('cartList'); var count=document.getElementById('cartCount');
      list.innerHTML=''; var total=0;
      Object.keys(cart).forEach(function(name){
        var qty=cart[name]; total+=qty;
        var row=document.createElement('div');
        row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='12px';
        row.style.alignItems='center'; row.style.padding='12px 0'; row.style.borderBottom='1px dashed #2a2a44';
        row.innerHTML='<strong class="row-name">'+name+'</strong><div></div>'
          +'<div class="qty row-qty"><button class="btn" data-op="-">-</button> <span>'+qty+'</span> <button class="btn" data-op="+">+</button></div>';
        row.querySelector('[data-op="-"]').onclick=function(){ cart[name]=Math.max(0,(cart[name]||0)-1); if(cart[name]===0) delete cart[name]; saveCart(); };
        row.querySelector('[data-op="+"]').onclick=function(){ cart[name]=(cart[name]||0)+1; saveCart(); };
        list.appendChild(row);
      });
      count.textContent='('+total+')';
    }

    /* 打开/关闭抽屉（保留你的逻辑） */
    cartBtn.onclick=function(){ drawer.style.transform='translateY(0)'; drawer.setAttribute('aria-hidden','false'); };
    closeDrawer.onclick=function(){
      /* PATCH: 先收起键盘，防止 iOS 保持“键盘态”导致按钮/抽屉上移 */
      if (document.activeElement && document.activeElement.blur) document.activeElement.blur();
      if (cName) cName.blur();
      if (cIngs) cIngs.blur();

      drawer.style.transform='translateY(110%)';
      drawer.setAttribute('aria-hidden','true');

      setTimeout(()=>{ window.dispatchEvent(new Event('resize')); },30);
    };

    /* 自定义加入（成功后清空 + 收起键盘，避免视口变小） */
    addCustom.onclick=function(){
      var name=(cName.value||'').trim();
      var ings=(cIngs.value||'').trim();
      if(!name){ alert('请先输入菜名'); cName.focus(); return; }

      var display= ings ? ('自定义 · '+name+'（'+ings+'）') : ('自定义 · '+name);
      cart[display]=(cart[display]||0)+1;
      saveCart();

      cName.value=''; cIngs.value='';
      if (document.activeElement && document.activeElement.blur) document.activeElement.blur();
      if (navigator.vibrate){ try{ navigator.vibrate(16); }catch(e){} }

      setTimeout(()=>{ window.dispatchEvent(new Event('resize')); },30);
    };

    /* 加载菜单 JSON */
    fetch(MENU_URL, { cache:'no-store' })
      .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(function(d){ MENU = Array.isArray(d)? d : []; renderMenu(); })
      .catch(function(e){ console.error('[menu] load failed', e); });

    /* Firestore（模块方式） */
    const _firebaseConfig = {
      apiKey: "AIzaSyA45H7MVPejI-09EmX3Y9RP0G-BzxKUA0M",
      authDomain: "shenyeshitang-9a3c2.firebaseapp.com",
      projectId: "shenyeshitang-9a3c2",
      storageBucket: "shenyeshitang-9a3c2.firebasestorage.app",
      messagingSenderId: "293937999981",
      appId: "1:293937999981:web:364b69c1ea61b48e8acf64"
    };
    async function ensureDb(){
      if (window.__fs && window.__db) return { fs: window.__fs, db: window.__db };
      const appMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
      const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
      const app    = appMod.initializeApp(_firebaseConfig);
      const db     = fsMod.getFirestore(app);
      window.__fs = fsMod; window.__db = db; return { fs: fsMod, db };
    }

    /* 管理员订阅（原样保留）...  */
    (function(){
      if (!ADMIN) return;
      try{
        var adminSection = document.getElementById('admin');
        if (adminSection) {
          adminSection.style.display='block';
          var headerEl = document.querySelector('header');
          if (headerEl && adminSection.previousElementSibling !== headerEl) {
            document.body.insertBefore(adminSection, headerEl);
          }
        }
        document.body.classList.add('admin-on');
      }catch(e){}

      (async function(){
        try{
          const { fs, db } = await ensureDb();

          let __ADMIN_LAST_ROWS__ = [];
          function renderAdminRowsCached(){
            const tbody = document.getElementById('adminRows'); if (!tbody) return;
            const only = document.getElementById('showPendingOnly');
            tbody.innerHTML = '';
            __ADMIN_LAST_ROWS__.forEach(row => {
              const d = row.data; const isDone = d.status === 'done';
              if (only && only.checked && isDone) return;
              const when = (d.createdAt && d.createdAt.toDate) ? d.createdAt.toDate().toLocaleString() : '';
              const tr = document.createElement('tr'); tr.style.opacity = isDone ? '0.55' : '1';
              tr.innerHTML = `<td>${when}</td><td>${d.nick || '-'}</td><td>${d.name}</td><td>${d.qty}</td>`;
              const tdOp = document.createElement('td'); const btn = document.createElement('button');
              btn.className='btn'; btn.textContent=isDone?'撤销':'完成';
              btn.onclick= async()=>{ try{ await fs.updateDoc(fs.doc(db,'yd_order_lines',row.id),{status:isDone?'pending':'done',doneAt:isDone?null:new Date()}); }catch(e){ alert('更新失败：'+e.message); } };
              tdOp.appendChild(btn); tr.appendChild(tdOp); tbody.appendChild(tr);
            });
          }
          const _chkOnly = document.getElementById('showPendingOnly'); if (_chkOnly) _chkOnly.addEventListener('change', renderAdminRowsCached);

          const qLines = fs.query(fs.collection(db,'yd_order_lines'), fs.where('room','==', window.ROOM_LOCK));
          var firstLoad = true;

          (function revealPurgeButton(){
            var title = document.querySelector('#admin h3'); var purgeBtn = document.getElementById('purgeAll'); if(!title || !purgeBtn) return;
            var shown=false; function show(){ if(!shown){ purgeBtn.style.display='inline-block'; shown=true; } }
            title.addEventListener('dblclick', show);
            var lastTapTime=0,lastX=0,lastY=0, TAP_MS=320,TAP_DIST=24;
            title.addEventListener('touchend', function(e){
              var t=e.changedTouches[0]; var now=Date.now(); var dt=now-lastTapTime; var dx=Math.abs(t.clientX-lastX); var dy=Math.abs(t.clientY-lastY);
              if (dt<TAP_MS && dx<TAP_DIST && dy<TAP_DIST){ show(); lastTapTime=0; }else{ lastTapTime=now; lastX=t.clientX; lastY=t.clientY; }
            }, {passive:true});
          })();

          (function bindPurgeHandler(){
            var purgeBtn=document.getElementById('purgeAll'); if(!purgeBtn) return;
            purgeBtn.onclick = async function(){
              try{
                if(!confirm('⚠️ 确认清空房间《'+window.ROOM_LOCK+'》所有订单与明细？')) return;
                var code = prompt('请输入 DELETE 以确认：'); if(code!=='DELETE'){ alert('已取消'); return; }
                const qL = fs.query(fs.collection(db,'yd_order_lines'), fs.where('room','==', window.ROOM_LOCK));
                const sL = await fs.getDocs(qL); await Promise.all(sL.docs.map(function(d){ return fs.deleteDoc(d.ref); }));
                const qO = fs.query(fs.collection(db,'yd_orders'), fs.where('room','==', window.ROOM_LOCK));
                const sO = await fs.getDocs(qO); await Promise.all(sO.docs.map(function(d){ return fs.deleteDoc(d.ref); }));
                alert('✅ 已清空：订单 '+sO.size+' 单，明细 '+sL.size+' 行');
              }catch(e){ alert('清空失败：'+(e && e.message ? e.message : e)); }
            };
          })();

          fs.onSnapshot(qLines, function(snap){
            const rows = [];
            snap.forEach(function(d){
              const data=d.data(); const ts = (data.createdAt && data.createdAt.toMillis) ? data.createdAt.toMillis() : 0;
              rows.push({ id:d.id, data, ts });
            });
            rows.sort((a,b)=> b.ts - a.ts);
            __ADMIN_LAST_ROWS__ = rows; renderAdminRowsCached();

            if(!firstLoad && 'Notification' in window && Notification.permission==='granted'){
              snap.docChanges().forEach(function(ch){
                if(ch.type==='added'){ const d=ch.doc.data(); if(d.status!=='done'){ new Notification('新订单 · '+d.name+' × '+d.qty); } }
              });
            }
            firstLoad=false;
          }, function(err){
            console.error('实时订单监听失败：', err);
            const roomInfo=document.getElementById('roomInfo');
            if(roomInfo) roomInfo.textContent='实时订单监听失败：'+err.message;
            alert('实时订单监听失败：'+err.message);
          });

          var markAllBtn=document.getElementById('markAllDone');
          if(markAllBtn){
            markAllBtn.onclick=async function(){
              if(!confirm('将当前显示的订单全部标记为完成？')) return;
              try{
                const snap2 = await fs.getDocs(qLines);
                const ops=[];
                const onlyPending=document.getElementById('showPendingOnly')?.checked;
                snap2.forEach(function(d){ var data=d.data(); if(onlyPending && data.status==='done') return; if(data.status!=='done') ops.push(fs.updateDoc(fs.doc(db,'yd_order_lines',d.id),{status:'done',doneAt:new Date()})); });
                await Promise.all(ops); alert('已标记完成');
              }catch(e){ alert('批量完成失败：'+e.message); }
            };
          }

          var notifyBtn=document.getElementById('enableNotify');
          if(notifyBtn){
            notifyBtn.onclick=function(){
              if('Notification' in window){
                Notification.requestPermission().then(function(p){ alert(p==='granted'?'已开启系统通知':'未授权通知'); });
              }else{
                alert('当前环境不支持通知');
              }
            }
          }

          var info=document.getElementById('roomInfo');
          if(info) info.textContent='房间：'+window.ROOM_LOCK+'（固定）';

        }catch(e){
          console.warn('Firebase 初始化失败：', e);
          alert('Firebase 初始化失败：'+e.message);
        }
      })();
    })();

    /* 提交订单（原样保留） */
    submitOrder.onclick = async function () {
      if (Object.keys(cart).length === 0) { alert('请先加入菜品'); return; }
      try {
        const { fs, db } = await ensureDb();
        const nick = (nickname && nickname.value ? nickname.value.trim() : '');
        const items = Object.entries(cart).map(([name, qty]) => ({ name, qty }));

        const headerRef = await fs.addDoc(fs.collection(db, "yd_orders"), {
          room: window.ROOM_LOCK, nick, items,
          status: "pending", doneAt: null, createdAt: fs.serverTimestamp()
        });
        await Promise.all(items.map(it => fs.addDoc(fs.collection(db, "yd_order_lines"), {
          room: window.ROOM_LOCK, nick, orderId: headerRef.id,
          name: it.name, qty: it.qty, status: "pending", doneAt: null, createdAt: fs.serverTimestamp()
        })));

        cart = {}; saveCart(); drawer.style.transform = "translateY(110%)"; alert("✅ 已提交成功");
      } catch (e) {
        console.error("提交失败：", e); alert("提交失败：" + e.message);
      }
    };
  </script>
</body>
</html>